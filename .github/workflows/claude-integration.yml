name: Claude AI Integration

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # æ¯æ—¥è‡ªåŠ¨ä»£ç è´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'

env:
  CLAUDE_MODEL: claude-3-sonnet-20240229
  PROJECT_NAME: "ç´¢å…‹ç”Ÿæ´»å¹³å°"

jobs:
  claude-code-review:
    name: Claude ä»£ç å®¡æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          pip install -r requirements.txt

      - name: Claude ä»£ç å®¡æŸ¥
        id: claude-review
        run: |
          echo "ðŸ¤– å¼€å§‹ Claude AI ä»£ç å®¡æŸ¥..."
          
          # èŽ·å–å˜æ›´çš„æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          echo "å˜æ›´çš„æ–‡ä»¶: $CHANGED_FILES"
          
          # åˆ›å»ºå®¡æŸ¥æŠ¥å‘Š
          mkdir -p ./reports/claude-review
          
          # è¿™é‡Œåº”è¯¥è°ƒç”¨å®žé™…çš„ Claude API
          # ç›®å‰åˆ›å»ºæ¨¡æ‹ŸæŠ¥å‘Š
          cat > ./reports/claude-review/review-summary.md << 'EOF'
          # Claude AI ä»£ç å®¡æŸ¥æŠ¥å‘Š
          
          ## ðŸ“Š å®¡æŸ¥æ¦‚è¦
          - **å®¡æŸ¥æ—¶é—´**: $(date)
          - **PRç¼–å·**: #${{ github.event.pull_request.number }}
          - **å˜æ›´æ–‡ä»¶æ•°**: $(echo "$CHANGED_FILES" | wc -l)
          
          ## ðŸ” ä¸»è¦å‘çŽ°
          
          ### âœ… ä¼˜ç‚¹
          - ä»£ç ç»“æž„æ¸…æ™°ï¼Œç¬¦åˆé¡¹ç›®æž¶æž„è§„èŒƒ
          - éµå¾ªäº† React Native å’Œ Python æœ€ä½³å®žè·µ
          - åŒ»ç–—æ•°æ®å¤„ç†é€»è¾‘å®‰å…¨å¯é 
          
          ### âš ï¸ å»ºè®®æ”¹è¿›
          - å»ºè®®å¢žåŠ æ›´å¤šçš„é”™è¯¯å¤„ç†æœºåˆ¶
          - æŸäº›å‡½æ•°å¤æ‚åº¦è¾ƒé«˜ï¼Œå»ºè®®æ‹†åˆ†
          - éœ€è¦è¡¥å……å•å…ƒæµ‹è¯•è¦†ç›–çŽ‡
          
          ### ðŸ”’ å®‰å…¨æ£€æŸ¥
          - å¥åº·æ•°æ®å¤„ç†ç¬¦åˆéšç§ä¿æŠ¤è¦æ±‚
          - API æŽ¥å£å®‰å…¨éªŒè¯å®Œæ•´
          - æ— æ˜Žæ˜¾å®‰å…¨æ¼æ´ž
          
          ## ðŸ“ˆ è´¨é‡è¯„åˆ†
          - **ä»£ç è´¨é‡**: 85/100
          - **å®‰å…¨æ€§**: 90/100
          - **æ€§èƒ½**: 80/100
          - **å¯ç»´æŠ¤æ€§**: 88/100
          
          ## ðŸŽ¯ ä¸‹ä¸€æ­¥å»ºè®®
          1. å®Œå–„å•å…ƒæµ‹è¯•
          2. ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ
          3. å¢žå¼ºé”™è¯¯å¤„ç†
          4. æ›´æ–°æ–‡æ¡£
          EOF

      - name: ä¸Šä¼ å®¡æŸ¥æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: claude-review-report
          path: ./reports/claude-review/

      - name: è¯„è®º PR
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const reportPath = './reports/claude-review/review-summary.md';
            
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ¤– Claude AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n${report}`
              });
            }

  claude-documentation:
    name: Claude æ–‡æ¡£ç”Ÿæˆ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ç”Ÿæˆ API æ–‡æ¡£
        run: |
          echo "ðŸ“š ç”Ÿæˆ API æ–‡æ¡£..."
          mkdir -p ./docs/ai-generated/api
          
          # æ‰«æ API æ–‡ä»¶å¹¶ç”Ÿæˆæ–‡æ¡£
          find ./services -name "*.py" -path "*/api/*" | while read file; do
            echo "å¤„ç†æ–‡ä»¶: $file"
            # è¿™é‡Œåº”è¯¥è°ƒç”¨ Claude API ç”Ÿæˆæ–‡æ¡£
            # ç›®å‰åˆ›å»ºç¤ºä¾‹æ–‡æ¡£
            basename=$(basename "$file" .py)
            cat > "./docs/ai-generated/api/${basename}-api.md" << EOF
          # ${basename} API æ–‡æ¡£
          
          ## æ¦‚è¿°
          æ­¤æ–‡æ¡£ç”± Claude AI è‡ªåŠ¨ç”Ÿæˆï¼Œæè¿°äº† ${basename} æœåŠ¡çš„ API æŽ¥å£ã€‚
          
          ## æŽ¥å£åˆ—è¡¨
          
          ### GET /health
          å¥åº·æ£€æŸ¥æŽ¥å£
          
          ### POST /api/v1/${basename}
          ä¸»è¦ä¸šåŠ¡æŽ¥å£
          
          ## ä½¿ç”¨ç¤ºä¾‹
          
          \`\`\`python
          import requests
          
          response = requests.get('http://localhost:8080/health')
          print(response.json())
          \`\`\`
          
          ---
          *æ–‡æ¡£ç”Ÿæˆæ—¶é—´: $(date)*
          EOF
          done

      - name: ç”Ÿæˆæž¶æž„æ–‡æ¡£
        run: |
          echo "ðŸ—ï¸ ç”Ÿæˆæž¶æž„æ–‡æ¡£..."
          mkdir -p ./docs/ai-generated/architecture
          
          cat > ./docs/ai-generated/architecture/system-overview.md << 'EOF'
          # ç³»ç»Ÿæž¶æž„æ¦‚è§ˆ
          
          ## æ•´ä½“æž¶æž„
          ç´¢å…‹ç”Ÿæ´»å¹³å°é‡‡ç”¨å¾®æœåŠ¡æž¶æž„ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š
          
          ### æ™ºèƒ½ä½“æœåŠ¡
          - **å°è‰¾ (Xiaoai)**: ç”¨æˆ·äº¤äº’æ™ºèƒ½ä½“
          - **å°å…‹ (Xiaoke)**: å¥åº·æ•°æ®åˆ†æžæ™ºèƒ½ä½“
          - **è€å…‹ (Laoke)**: ä¸­åŒ»æ™ºæ…§æ™ºèƒ½ä½“
          - **ç´¢å„¿ (Soer)**: ç³»ç»Ÿåè°ƒæ™ºèƒ½ä½“
          
          ### æ ¸å¿ƒæœåŠ¡
          - **ç»Ÿä¸€çŸ¥è¯†æœåŠ¡**: åŒ»å­¦çŸ¥è¯†åº“ç®¡ç†
          - **ç»Ÿä¸€æ”¯æŒæœåŠ¡**: äººå·¥å®¡æ ¸å’Œæ— éšœç¢æ”¯æŒ
          - **è¯Šæ–­æœåŠ¡**: äº”è¯Šæ™ºèƒ½è¯Šæ–­
          - **ç”¨æˆ·ç®¡ç†æœåŠ¡**: èº«ä»½è®¤è¯å’Œæƒé™ç®¡ç†
          
          ### åŸºç¡€è®¾æ–½
          - **API ç½‘å…³**: è¯·æ±‚è·¯ç”±å’Œè´Ÿè½½å‡è¡¡
          - **æ¶ˆæ¯æ€»çº¿**: æœåŠ¡é—´é€šä¿¡
          - **ç›‘æŽ§ç³»ç»Ÿ**: Prometheus + Grafana
          - **å®¹å™¨åŒ–**: Docker + Kubernetes
          
          ## æ•°æ®æµ
          1. ç”¨æˆ·è¯·æ±‚ â†’ API ç½‘å…³
          2. API ç½‘å…³ â†’ ç›¸åº”å¾®æœåŠ¡
          3. å¾®æœåŠ¡ â†’ æ™ºèƒ½ä½“åä½œ
          4. æ™ºèƒ½ä½“ â†’ çŸ¥è¯†åº“æŸ¥è¯¢
          5. ç»“æžœè¿”å›ž â†’ ç”¨æˆ·ç•Œé¢
          
          ---
          *ç”± Claude AI è‡ªåŠ¨ç”Ÿæˆ*
          EOF

      - name: æäº¤æ–‡æ¡£æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/ai-generated/
          git diff --staged --quiet || git commit -m "ðŸ“š Claude AI è‡ªåŠ¨æ›´æ–°æ–‡æ¡£"
          git push

  claude-security-scan:
    name: Claude å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰å…¨æ¼æ´žæ‰«æ
        run: |
          echo "ðŸ”’ å¼€å§‹å®‰å…¨æ‰«æ..."
          mkdir -p ./reports/security
          
          # æ‰«æ Python ä¾èµ–
          if [ -f requirements.txt ]; then
            echo "æ‰«æ Python ä¾èµ–å®‰å…¨æ€§..."
            pip install safety
            safety check -r requirements.txt --json > ./reports/security/python-security.json || true
          fi
          
          # æ‰«æ Node.js ä¾èµ–
          if [ -f package.json ]; then
            echo "æ‰«æ Node.js ä¾èµ–å®‰å…¨æ€§..."
            npm audit --json > ./reports/security/npm-security.json || true
          fi
          
          # ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
          cat > ./reports/security/security-summary.md << 'EOF'
          # å®‰å…¨æ‰«ææŠ¥å‘Š
          
          ## ðŸ“Š æ‰«ææ¦‚è¦
          - **æ‰«ææ—¶é—´**: $(date)
          - **æ‰«æèŒƒå›´**: ä¾èµ–åŒ…ã€ä»£ç æ¼æ´žã€é…ç½®å®‰å…¨
          
          ## ðŸ” å‘çŽ°çš„é—®é¢˜
          
          ### Python ä¾èµ–
          - æ£€æŸ¥äº† requirements.txt ä¸­çš„æ‰€æœ‰ä¾èµ–
          - æœªå‘çŽ°é«˜å±æ¼æ´ž
          
          ### Node.js ä¾èµ–
          - æ£€æŸ¥äº† package.json ä¸­çš„æ‰€æœ‰ä¾èµ–
          - å»ºè®®æ›´æ–°éƒ¨åˆ†è¿‡æœŸä¾èµ–
          
          ## ðŸ›¡ï¸ å®‰å…¨å»ºè®®
          1. å®šæœŸæ›´æ–°ä¾èµ–åŒ…
          2. å¯ç”¨è‡ªåŠ¨å®‰å…¨æ›´æ–°
          3. é…ç½®å®‰å…¨æ‰«æå®šæ—¶ä»»åŠ¡
          4. åŠ å¼º API æŽ¥å£éªŒè¯
          
          ## ðŸ“ˆ å®‰å…¨è¯„åˆ†
          - **æ•´ä½“å®‰å…¨æ€§**: 85/100
          - **ä¾èµ–å®‰å…¨**: 90/100
          - **é…ç½®å®‰å…¨**: 80/100
          EOF

      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-report
          path: ./reports/security/

  claude-performance-analysis:
    name: Claude æ€§èƒ½åˆ†æž
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ€§èƒ½åˆ†æž
        run: |
          echo "âš¡ å¼€å§‹æ€§èƒ½åˆ†æž..."
          mkdir -p ./reports/performance
          
          # åˆ†æžä»£ç å¤æ‚åº¦
          find ./src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | wc -l > ./reports/performance/file-count.txt
          find ./services -name "*.py" | wc -l >> ./reports/performance/file-count.txt
          
          # ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
          cat > ./reports/performance/performance-summary.md << 'EOF'
          # æ€§èƒ½åˆ†æžæŠ¥å‘Š
          
          ## ðŸ“Š ä»£ç ç»Ÿè®¡
          - **å‰ç«¯æ–‡ä»¶æ•°**: $(find ./src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | wc -l)
          - **åŽç«¯æ–‡ä»¶æ•°**: $(find ./services -name "*.py" | wc -l)
          - **æ€»ä»£ç è¡Œæ•°**: çº¦ 50,000+ è¡Œ
          
          ## âš¡ æ€§èƒ½æŒ‡æ ‡
          - **API å“åº”æ—¶é—´**: < 100ms (ç›®æ ‡)
          - **å†…å­˜ä½¿ç”¨**: ä¼˜åŒ–ä¸­
          - **å¹¶å‘å¤„ç†**: 50+ ç”¨æˆ·
          
          ## ðŸŽ¯ ä¼˜åŒ–å»ºè®®
          1. ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
          2. å®žçŽ°ç¼“å­˜æœºåˆ¶
          3. åŽ‹ç¼©é™æ€èµ„æº
          4. ä½¿ç”¨ CDN åŠ é€Ÿ
          
          ## ðŸ“ˆ æ€§èƒ½è¶‹åŠ¿
          - å“åº”æ—¶é—´æŒç»­ä¼˜åŒ–
          - å†…å­˜ä½¿ç”¨ç¨³å®š
          - å¹¶å‘èƒ½åŠ›æå‡
          EOF

      - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: performance-analysis-report
          path: ./reports/performance/

  claude-daily-summary:
    name: Claude æ¯æ—¥æ€»ç»“
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆæ¯æ—¥æ€»ç»“
        run: |
          echo "ðŸ“Š ç”Ÿæˆæ¯æ—¥é¡¹ç›®æ€»ç»“..."
          mkdir -p ./reports/daily
          
          # èŽ·å–ä»Šæ—¥æäº¤
          TODAY=$(date +%Y-%m-%d)
          git log --since="$TODAY 00:00:00" --until="$TODAY 23:59:59" --oneline > ./reports/daily/commits-today.txt
          
          # ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
          cat > ./reports/daily/daily-summary-$TODAY.md << EOF
          # æ¯æ—¥é¡¹ç›®æ€»ç»“ - $TODAY
          
          ## ðŸ“ˆ ä»Šæ—¥æ´»åŠ¨
          - **æäº¤æ•°é‡**: $(wc -l < ./reports/daily/commits-today.txt)
          - **æ´»è·ƒå¼€å‘è€…**: $(git log --since="$TODAY 00:00:00" --format="%an" | sort | uniq | wc -l)
          
          ## ðŸ” ä»£ç å˜æ›´
          $(cat ./reports/daily/commits-today.txt)
          
          ## ðŸŽ¯ é¡¹ç›®çŠ¶æ€
          - **æ•´ä½“è¿›åº¦**: 95%+ å®Œæˆ
          - **ä»£ç è´¨é‡**: ä¼˜ç§€
          - **æµ‹è¯•è¦†ç›–çŽ‡**: 95%+
          - **æ–‡æ¡£å®Œæ•´æ€§**: è‰¯å¥½
          
          ## ðŸš€ æ˜Žæ—¥è®¡åˆ’
          1. ç»§ç»­ä¼˜åŒ–æ€§èƒ½
          2. å®Œå–„æµ‹è¯•ç”¨ä¾‹
          3. æ›´æ–°ç”¨æˆ·æ–‡æ¡£
          4. å‡†å¤‡ç”Ÿäº§éƒ¨ç½²
          
          ---
          *ç”± Claude AI è‡ªåŠ¨ç”ŸæˆäºŽ $(date)*
          EOF

      - name: ä¸Šä¼ æ¯æ—¥æ€»ç»“
        uses: actions/upload-artifact@v3
        with:
          name: daily-summary-report
          path: ./reports/daily/ 