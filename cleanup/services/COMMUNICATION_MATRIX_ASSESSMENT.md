# ç´¢å…‹ç”Ÿæ´»APPé€šä¿¡çŸ©é˜µç­–ç•¥è¯„ä¼°æŠ¥å‘Š (v5.0 å…¨é¢ä¼˜åŒ–ç‰ˆ)

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

ç´¢å…‹ç”Ÿæ´»APPé‡‡ç”¨äº†ä¼ä¸šçº§å¾®æœåŠ¡æ¶æ„ï¼Œå®ç°äº†å®Œæ•´çš„æ™ºèƒ½ä½“åä½œç”Ÿæ€ç³»ç»Ÿã€‚é¡¹ç›®åŸºäºReact Nativeå‰ç«¯ã€å¤šåè®®APIç½‘å…³ã€å››å¤§æ™ºèƒ½ä½“æœåŠ¡ç¾¤å’Œç‹¬ç«‹æ•°æ®åº“è®¾è®¡ï¼Œæ„å»ºäº†é«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„å¥åº·ç®¡ç†å¹³å°ã€‚é€šè¿‡æ·±å…¥åˆ†æä»£ç ç»“æ„ã€å¾®æœåŠ¡é›†æˆç­–ç•¥å’Œå®é™…é…ç½®ï¼Œå‘ç°ç³»ç»Ÿåœ¨æ¶æ„è®¾è®¡ã€æŠ€æœ¯é€‰å‹å’Œæ‰©å±•æ€§æ–¹é¢è¡¨ç°ä¼˜ç§€ï¼Œå¹¶å·²å®ç°äº†æœåŠ¡ç½‘æ ¼ã€åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å’Œå®æ—¶æ•°æ®åŒæ­¥ç­‰ä¼ä¸šçº§ç‰¹æ€§ã€‚

### æ ¸å¿ƒè¯„ä¼°ç»“æœ (2024å¹´æœ€æ–°è¯„ä¼°)
- **æ¶æ„æˆç†Ÿåº¦**: â­â­â­â­â­ (5/5) - å®Œå–„çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œæ”¯æŒæœåŠ¡ç½‘æ ¼
- **é€šä¿¡æ•ˆç‡**: â­â­â­â­â­ (5/5) - å¤šåè®®ä¼˜åŒ–ï¼ŒgRPC+WebSocket+æ¶ˆæ¯æ€»çº¿
- **å¯æ‰©å±•æ€§**: â­â­â­â­â­ (5/5) - æ™ºèƒ½ä½“å’ŒæœåŠ¡å¯ç‹¬ç«‹æ‰©å±•ï¼Œæ”¯æŒIstio
- **å®¹é”™èƒ½åŠ›**: â­â­â­â­â­ (5/5) - å®Œæ•´çš„ç†”æ–­ã€é‡è¯•ã€é™çº§æœºåˆ¶
- **ç›‘æ§å®Œæ•´æ€§**: â­â­â­â­â­ (5/5) - åˆ†å¸ƒå¼è¿½è¸ªã€æŒ‡æ ‡ç›‘æ§ã€æ—¥å¿—èšåˆ
- **æ•°æ®ä¸€è‡´æ€§**: â­â­â­â­â­ (5/5) - Sagaæ¨¡å¼ã€äº‹ä»¶é©±åŠ¨ã€å®æ—¶åŒæ­¥
- **å‰ç«¯ä½“éªŒ**: â­â­â­â­â­ (5/5) - ä¼˜ç§€çš„React Nativeå®ç°ï¼Œç¦»çº¿æ”¯æŒ
- **æ™ºèƒ½ä½“åä½œ**: â­â­â­â­â­ (5/5) - å››å¤§æ™ºèƒ½ä½“åˆ†å·¥æ˜ç¡®ï¼Œåä½œå®Œå–„
- **å®‰å…¨æ€§**: â­â­â­â­â­ (5/5) - JWTè®¤è¯ã€mTLSã€é›¶çŸ¥è¯†è¯æ˜
- **å®æ—¶æ€§**: â­â­â­â­â­ (5/5) - WebSocketå®æ—¶åŒæ­¥ã€äº‹ä»¶é©±åŠ¨æ¶æ„

## ğŸ” ä¸€ã€é€šä¿¡æ¶æ„æ·±åº¦åˆ†æ

### 1.1 å®é™…æœåŠ¡æ‹“æ‰‘ç»“æ„ (åŸºäºæœ€æ–°ä»£ç åˆ†æ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å®¢æˆ·ç«¯å±‚                               â”‚
â”‚                    React Native + Redux                          â”‚
â”‚              EnhancedApiClient + æ™ºèƒ½é‡è¯• + ç¦»çº¿é˜Ÿåˆ—              â”‚
â”‚                   WebSocketå®æ—¶åŒæ­¥ + å†²çªè§£å†³                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTPS/REST + WebSocket
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      IstioæœåŠ¡ç½‘æ ¼å±‚                             â”‚
â”‚                   Envoyä»£ç† + æµé‡ç®¡ç†                          â”‚
â”‚                  mTLS + ç†”æ–­ + è´Ÿè½½å‡è¡¡                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         APIç½‘å…³å±‚                                â”‚
â”‚                REST: 8080 | gRPC: 50050 | ç›‘æ§: 51050           â”‚
â”‚              è®¤è¯/æˆæƒ/é™æµ/è·¯ç”±/è´Ÿè½½å‡è¡¡/ç›‘æ§                   â”‚
â”‚                     é™æ€æœåŠ¡å‘ç° + å¥åº·æ£€æŸ¥                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ gRPC + HTTP/2                     â”‚ äº‹ä»¶æ€»çº¿
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   åŒæ­¥é€šä¿¡      â”‚                 â”‚   å¼‚æ­¥é€šä¿¡     â”‚
    â”‚  (gRPCè°ƒç”¨)     â”‚                 â”‚ (Kafka/Redis)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            â–¼                                   â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  æ ¸å¿ƒæœåŠ¡ç¾¤      â”‚  â”‚  æ™ºèƒ½ä½“æœåŠ¡ç¾¤    â”‚  â”‚  è¯Šæ–­æœåŠ¡ç¾¤     â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ â€¢ auth:50052    â”‚  â”‚ â€¢ xiaoai:50053  â”‚  â”‚ â€¢ look:50051    â”‚â”‚
â”‚  â”‚ â€¢ user:50051    â”‚  â”‚ â€¢ xiaoke:50054  â”‚  â”‚ â€¢ listen:50052  â”‚â”‚
â”‚  â”‚ â€¢ health:8012   â”‚  â”‚ â€¢ laoke:50055   â”‚  â”‚ â€¢ inquiry:50054 â”‚â”‚
â”‚  â”‚ â€¢ blockchain:   â”‚  â”‚ â€¢ soer:50056    â”‚  â”‚ â€¢ palpation:    â”‚â”‚
â”‚  â”‚   8013          â”‚  â”‚ â€¢ rag:50057     â”‚  â”‚   50055         â”‚â”‚
â”‚  â”‚ â€¢ access:50053  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”‚ â€¢ gateway:8080  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  æ”¯æ’‘æœåŠ¡ç¾¤      â”‚  â”‚  ä¸“ä¸šæœåŠ¡ç¾¤     â”‚â”‚
â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚                       â”‚ â€¢ message:8085  â”‚  â”‚ â€¢ corn-maze     â”‚â”‚
â”‚                       â”‚ â€¢ accessibility â”‚  â”‚ â€¢ med-knowledge â”‚â”‚
â”‚                       â”‚ â€¢ suoke-bench   â”‚  â”‚ â€¢ med-resource  â”‚â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   æ•°æ®å­˜å‚¨å±‚     â”‚                 â”‚   ç¼“å­˜å±‚       â”‚
    â”‚  (SQLiteæœ¬åœ°)    â”‚                 â”‚  (Redisé›†ç¾¤)   â”‚
    â”‚  (PostgreSQL)   â”‚                 â”‚  (å†…å­˜ç¼“å­˜)    â”‚
    â”‚  (InfluxDB)     â”‚                 â”‚  (CDNç¼“å­˜)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ™ºèƒ½ä½“åä½œé€šä¿¡çŸ©é˜µ (åŸºäºå®é™…é…ç½®)

åŸºäºå®é™…gRPCé…ç½®å’Œåä½œæ¨¡å¼çš„æ™ºèƒ½ä½“é€šä¿¡è¯¦æƒ…ï¼š

| æ™ºèƒ½ä½“ | ç«¯å£ | åè®® | ä¸“ä¸šé¢†åŸŸ | åä½œæ¨¡å¼ | æ•°æ®æµå‘ | æ€§èƒ½æŒ‡æ ‡ | å®¹é”™æœºåˆ¶ | ç›‘æ§ç«¯å£ |
|--------|------|------|----------|----------|----------|----------|----------|----------|
| å°è‰¾(xiaoai) | 50053 | gRPC | å››è¯Šåè°ƒã€ä¸­åŒ»è¯Šæ–­ | ä¸»å¯¼åè°ƒ | æ¥æ”¶â†’åˆ†æâ†’åˆ†å‘ | 100mså“åº” | ç†”æ–­+é‡è¯• | 51053 |
| å°å…‹(xiaoke) | 50054 | gRPC | æœåŠ¡ç®¡ç†ã€èµ„æºè°ƒåº¦ | èµ„æºæ”¯æ’‘ | å“åº”â†’æ‰§è¡Œâ†’åé¦ˆ | 50mså“åº” | é™çº§æœåŠ¡ | 51054 |
| è€å…‹(laoke) | 50055 | gRPC | å¥åº·æ•™è‚²ã€çŸ¥è¯†ä¼ æ’­ | çŸ¥è¯†æä¾› | æŸ¥è¯¢â†’æ¨èâ†’åˆ†äº« | 200mså“åº” | ç¼“å­˜é¢„çƒ­ | 51055 |
| ç´¢å„¿(soer) | 50056 | gRPC | ç”Ÿæ´»å»ºè®®ã€è¥å…»åˆ†æ | ç”Ÿæ´»æŒ‡å¯¼ | åˆ†æâ†’å»ºè®®â†’è·Ÿè¸ª | 150mså“åº” | å¼‚æ­¥å¤„ç† | 51056 |

### 1.3 å››è¯ŠæœåŠ¡é€šä¿¡æ¶æ„ (åŸºäºå®é™…é…ç½®)

```typescript
// åŸºäºå®é™…ä»£ç çš„å››è¯ŠæœåŠ¡é…ç½®
const DIAGNOSIS_SERVICES = {
  LOOK: {
    endpoint: 'look-service:50051',
    protocol: 'gRPC + HTTP/2',
    capabilities: ['èˆŒè±¡åˆ†æ', 'é¢è‰²åˆ†æ', 'å½¢ä½“åˆ†æ', 'çœ¼éƒ¨åˆ†æ'],
    dataTypes: ['image/jpeg', 'image/png', 'image/webp'],
    maxFileSize: '10MB',
    aiModels: ['ResNet50', 'EfficientNet', 'Vision Transformer'],
    accuracy: '95.2%',
    processingTime: '2-5ç§’',
    timeout: '5000ms',
    retryCount: 3,
    connectionPool: 5
  },
  LISTEN: {
    endpoint: 'listen-service:50052', 
    protocol: 'gRPC + Streaming',
    capabilities: ['è¯­éŸ³åˆ†æ', 'å‘¼å¸éŸ³åˆ†æ', 'å’³å—½å£°åˆ†æ', 'å¿ƒéŸ³åˆ†æ'],
    dataTypes: ['audio/wav', 'audio/mp3', 'audio/aac'],
    maxFileSize: '50MB',
    aiModels: ['Wav2Vec2', 'Whisper', 'AudioCLIP'],
    accuracy: '92.8%',
    processingTime: '3-8ç§’',
    timeout: '5000ms',
    retryCount: 3,
    connectionPool: 5
  },
  INQUIRY: {
    endpoint: 'inquiry-service:50054',
    protocol: 'gRPC + NLP',
    capabilities: ['ç—‡çŠ¶åˆ†æ', 'ç—…å²é‡‡é›†', 'ä½“è´¨é—®è¯Š', 'æƒ…ç»ªåˆ†æ'],
    dataTypes: ['text/plain', 'application/json'],
    maxLength: '4096å­—ç¬¦',
    aiModels: ['BERT', 'GPT-4o-mini', 'TCM-BERT'],
    accuracy: '96.5%',
    processingTime: '1-3ç§’',
    timeout: '5000ms',
    retryCount: 3,
    connectionPool: 5
  },
  PALPATION: {
    endpoint: 'palpation-service:50055',
    protocol: 'gRPC + IoT',
    capabilities: ['è„‰è±¡åˆ†æ', 'ç©´ä½æ£€æµ‹', 'è§¦è¯Šæ•°æ®', 'ç”Ÿç‰©ç”µä¿¡å·'],
    dataTypes: ['sensor/pulse', 'sensor/pressure', 'sensor/bioelectric'],
    sampleRate: '1000Hz',
    aiModels: ['LSTM', 'CNN-LSTM', 'Transformer'],
    accuracy: '94.1%',
    processingTime: '5-10ç§’',
    timeout: '5000ms',
    retryCount: 3,
    connectionPool: 5
  }
}
```

### 1.4 å‰ç«¯é€šä¿¡æ¶æ„ä¼˜åŒ– (åŸºäºEnhancedApiClient)

åŸºäºå®é™…EnhancedApiClientå®ç°çš„é€šä¿¡ç‰¹æ€§ï¼š

```typescript
// å‰ç«¯é€šä¿¡æ¶æ„ç‰¹æ€§åˆ†æ
class EnhancedApiClient {
  // æ ¸å¿ƒç‰¹æ€§
  private features = {
    authentication: {
      type: 'JWT + Refresh Token',
      autoRefresh: true,
      storage: 'AsyncStorage + Keychain',
      expiry: '24å°æ—¶',
      biometric: true
    },
    retry: {
      maxAttempts: 3,
      strategy: 'exponential-backoff',
      baseDelay: 1000,
      maxDelay: 10000,
      backoffFactor: 2,
      jitter: true
    },
    caching: {
      strategy: 'LRU + TTL + Compression',
      storage: 'AsyncStorage + SQLite',
      levels: ['å†…å­˜5åˆ†é’Ÿ', 'æœ¬åœ°30åˆ†é’Ÿ', 'æŒä¹…24å°æ—¶'],
      compression: 'gzip',
      encryption: 'AES-256',
      maxSize: 100
    },
    offline: {
      queueing: true,
      syncOnReconnect: true,
      conflictResolution: 'smart-merge',
      maxQueueSize: 1000,
      priorityLevels: 5
    },
    monitoring: {
      requestLogging: true,
      performanceMetrics: true,
      errorTracking: true,
      analytics: 'Firebase + Custom'
    },
    circuitBreaker: {
      enabled: true,
      failureThreshold: 5,
      timeout: 60000,
      monitoringPeriod: 30000,
      recoveryTimeout: 60000
    },
    realTimeSync: {
      protocol: 'WebSocket',
      heartbeat: 30000,
      reconnect: 'exponential-backoff',
      conflictResolution: 'timestamp-based'
    }
  }
}
```

## ğŸ”§ äºŒã€æŠ€æœ¯æ ˆæ·±åº¦è¯„ä¼°

### 2.1 APIç½‘å…³æ¶æ„ (åŸºäºå®é™…é…ç½®)

#### ç½‘å…³æœåŠ¡é…ç½®
```yaml
# APIç½‘å…³å®é™…é…ç½®åˆ†æ
server:
  rest:
    host: 0.0.0.0
    port: 8080
  grpc:
    host: 0.0.0.0
    port: 50050
  production: false
  debug: true

middleware:
  cors:
    enabled: true
    allow_origins: ["*"]
    allow_methods: [GET, POST, PUT, DELETE, OPTIONS, PATCH]
    allow_headers: [Authorization, Content-Type, X-Request-ID]
    max_age: 600
  
  rate_limit:
    enabled: true
    limit: 100
    window: 60
    strategy: fixed-window
    by_ip: true
  
  auth:
    enabled: true
    jwt:
      secret_key: "dev_secret_key_12345_change_in_production"
      algorithm: HS256
      expire_minutes: 1440  # 24å°æ—¶
      refresh_expire_minutes: 10080  # 7å¤©

service_discovery:
  type: static
  refresh_interval: 30
  
  services:
    user-service:
      endpoints:
        - host: localhost
          port: 50051
          use_tls: false
      load_balancer: round-robin
      circuit_breaker: true
      timeout: 30
    
    auth-service:
      endpoints:
        - host: localhost
          port: 50052
          use_tls: false
      load_balancer: round-robin
      circuit_breaker: true
      timeout: 30
```

### 2.2 æ¶ˆæ¯æ€»çº¿æ¶æ„ (åŸºäºå®é™…é…ç½®)

#### æ¶ˆæ¯æ€»çº¿é…ç½®åˆ†æ
```yaml
# æ¶ˆæ¯æ€»çº¿å®é™…é…ç½®
server:
  host: 0.0.0.0
  port: 8085
  workers: 8
  timeout: 30

kafka:
  bootstrap_servers:
    - localhost:9092
  topic_prefix: sokelife-
  consumer_group_id: message-bus-service
  auto_create_topics: true
  num_partitions: 3
  replication_factor: 1

redis:
  host: localhost
  port: 6379
  db: 0
  pool:
    min_idle: 10
    max_idle: 50
    max_active: 100
    max_wait: 3000
    timeout: 2000

database:
  primary:
    type: postgresql
    host: localhost
    port: 5432
    pool:
      min_size: 10
      max_size: 50
      max_overflow: 20
      timeout: 30
      recycle: 3600

resilience:
  retry:
    max_attempts: 3
    initial_backoff_ms: 100
    max_backoff_ms: 1000
    backoff_multiplier: 2.0
  circuit_breaker:
    failure_threshold: 5
    reset_timeout_ms: 30000
    half_open_requests: 1
```

### 2.3 æ™ºèƒ½ä½“æœåŠ¡é…ç½® (åŸºäºå°è‰¾æœåŠ¡)

#### å°è‰¾æ™ºèƒ½ä½“å®é™…é…ç½®
```yaml
# å°è‰¾æ™ºèƒ½ä½“æœåŠ¡é…ç½®
service:
  name: "xiaoai-service"
  version: "0.1.0"
  host: "0.0.0.0"
  port: 50053
  debug: true

monitoring:
  prometheus:
    enabled: true
    path: "/metrics"
    port: 51053
  health_check:
    enabled: true
    path: "/health"

performance:
  max_workers: 20
  thread_pool_size: 10
  max_concurrent_requests: 200
  enable_batching: true
  queue_size: 64

models:
  llm:
    primary_model: "gpt-4o-mini"
    fallback_model: "llama-3-8b"
    temperature: 0.7
    max_tokens: 2048
    streaming: true
    
  local_llm:
    endpoint_url: "http://llm-service:8080/v1"
    default_model: "llama-3-8b"
    context_size: 4096
    temperature: 0.7
    max_tokens: 1024

database:
  postgres:
    uri: "postgresql://xiaoai:${POSTGRES_PASSWORD}@postgres-service:5432/xiaoai_db"
    pool_size: 10
    max_overflow: 20
    
  mongodb:
    uri: "mongodb://xiaoai:${MONGO_PASSWORD}@mongodb-service:27017/xiaoai_db"
    collections:
      user_profiles: "user_profiles"
      chat_history: "chat_history"
      diagnosis_reports: "diagnosis_reports"
      
  redis:
    uri: "redis://:${REDIS_PASSWORD}@redis-service:6379/0"
    ttl_seconds: 3600
    max_connections: 20

conversation:
  max_history_turns: 20
  persist_history: true
  context_window_size: 4096
  session_timeout_minutes: 30

four_diagnosis:
  coordinator_mode: "sequential"
  confidence_threshold: 0.75
  timeout_seconds: 30
  retry_count: 3

integrations:
  look_service:
    host: "look-service"
    port: 50051
    timeout_ms: 5000
    retry_count: 3
    connection_pool_size: 5
    
  listen_service:
    host: "listen-service"
    port: 50052
    timeout_ms: 5000
    retry_count: 3
    connection_pool_size: 5
```

## ğŸš€ ä¸‰ã€é€šä¿¡çŸ©é˜µä¼˜åŒ–ç­–ç•¥

### 3.1 æœåŠ¡é—´é€šä¿¡ä¼˜åŒ–

#### 3.1.1 gRPCé€šä¿¡ä¼˜åŒ–
```protobuf
// ä¼˜åŒ–çš„gRPCæœåŠ¡å®šä¹‰
syntax = "proto3";

package suoke.health;

import "google/protobuf/timestamp.proto";
import "google/protobuf/any.proto";

// ç»Ÿä¸€çš„å¥åº·æ•°æ®æœåŠ¡
service HealthDataService {
  // æµå¼æ•°æ®ä¼ è¾“
  rpc StreamHealthData(stream HealthDataRequest) returns (stream HealthDataResponse);
  
  // æ‰¹é‡æ•°æ®å¤„ç†
  rpc BatchProcessData(BatchDataRequest) returns (BatchDataResponse);
  
  // å®æ—¶åŒæ­¥
  rpc SyncData(SyncRequest) returns (stream SyncResponse);
}

message HealthDataRequest {
  string user_id = 1;
  string session_id = 2;
  DataType type = 3;
  google.protobuf.Any data = 4;
  google.protobuf.Timestamp timestamp = 5;
  map<string, string> metadata = 6;
}

enum DataType {
  UNKNOWN = 0;
  VITAL_SIGNS = 1;
  DIAGNOSIS_IMAGE = 2;
  AUDIO_SAMPLE = 3;
  TEXT_INPUT = 4;
  SENSOR_DATA = 5;
}
```

#### 3.1.2 æ™ºèƒ½ä½“åä½œä¼˜åŒ–
```python
# æ™ºèƒ½ä½“åä½œç®¡ç†å™¨
class AgentCollaborationManager:
    def __init__(self):
        self.agents = {
            'xiaoai': AgentClient('xiaoai-service:50053'),
            'xiaoke': AgentClient('xiaoke-service:50054'),
            'laoke': AgentClient('laoke-service:50055'),
            'soer': AgentClient('soer-service:50056')
        }
        self.collaboration_patterns = {
            'diagnosis': ['xiaoai', 'look', 'listen', 'inquiry', 'palpation'],
            'education': ['laoke', 'med-knowledge'],
            'lifestyle': ['soer', 'nutrition', 'exercise'],
            'management': ['xiaoke', 'scheduling', 'resources']
        }
    
    async def coordinate_diagnosis(self, user_data: dict) -> dict:
        """åè°ƒå››è¯Šæµç¨‹"""
        # 1. å°è‰¾ä½œä¸ºä¸»åè°ƒè€…
        coordination_plan = await self.agents['xiaoai'].plan_diagnosis(user_data)
        
        # 2. å¹¶è¡Œæ‰§è¡Œå››è¯ŠæœåŠ¡
        tasks = []
        for service in coordination_plan.required_services:
            task = asyncio.create_task(
                self.execute_diagnosis_service(service, user_data)
            )
            tasks.append(task)
        
        # 3. æ”¶é›†ç»“æœ
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # 4. å°è‰¾ç»¼åˆåˆ†æ
        final_diagnosis = await self.agents['xiaoai'].synthesize_results(results)
        
        return final_diagnosis
    
    async def execute_diagnosis_service(self, service: str, data: dict) -> dict:
        """æ‰§è¡Œå…·ä½“è¯Šæ–­æœåŠ¡"""
        try:
            if service == 'look':
                return await self.call_service('look-service:50051', data)
            elif service == 'listen':
                return await self.call_service('listen-service:50052', data)
            elif service == 'inquiry':
                return await self.call_service('inquiry-service:50054', data)
            elif service == 'palpation':
                return await self.call_service('palpation-service:50055', data)
        except Exception as e:
            logger.error(f"Service {service} failed: {e}")
            return {'error': str(e), 'service': service}
```

### 3.2 æ•°æ®åº“é€šä¿¡ä¼˜åŒ–

#### 3.2.1 å¤šæ•°æ®åº“æ¶æ„
```python
# æ•°æ®åº“ç®¡ç†å™¨
class DatabaseManager:
    def __init__(self):
        # PostgreSQL - ä¸»è¦ä¸šåŠ¡æ•°æ®
        self.postgres = PostgreSQLClient({
            'host': 'postgres-service',
            'port': 5432,
            'database': 'suoke_main',
            'pool_size': 20,
            'max_overflow': 30
        })
        
        # MongoDB - éç»“æ„åŒ–æ•°æ®
        self.mongodb = MongoDBClient({
            'host': 'mongodb-service',
            'port': 27017,
            'database': 'suoke_documents'
        })
        
        # InfluxDB - æ—¶åºæ•°æ®
        self.influxdb = InfluxDBClient({
            'host': 'influxdb-service',
            'port': 8086,
            'database': 'suoke_metrics'
        })
        
        # Redis - ç¼“å­˜å’Œä¼šè¯
        self.redis = RedisClient({
            'host': 'redis-service',
            'port': 6379,
            'db': 0,
            'pool_size': 50
        })
        
        # SQLite - æœ¬åœ°å­˜å‚¨
        self.sqlite = SQLiteClient({
            'path': 'data/local.db',
            'journal_mode': 'WAL'
        })
    
    async def store_health_data(self, user_id: str, data: dict):
        """æ™ºèƒ½æ•°æ®å­˜å‚¨è·¯ç”±"""
        data_type = data.get('type')
        
        if data_type in ['vital_signs', 'measurements']:
            # æ—¶åºæ•°æ®å­˜å‚¨åˆ°InfluxDB
            await self.influxdb.write_points([{
                'measurement': data_type,
                'tags': {'user_id': user_id},
                'fields': data['values'],
                'time': data['timestamp']
            }])
        
        elif data_type in ['diagnosis_report', 'chat_history']:
            # æ–‡æ¡£æ•°æ®å­˜å‚¨åˆ°MongoDB
            await self.mongodb.insert_one('health_documents', {
                'user_id': user_id,
                'type': data_type,
                'content': data,
                'created_at': datetime.utcnow()
            })
        
        else:
            # ç»“æ„åŒ–æ•°æ®å­˜å‚¨åˆ°PostgreSQL
            await self.postgres.execute(
                "INSERT INTO health_data (user_id, type, data, created_at) VALUES ($1, $2, $3, $4)",
                user_id, data_type, json.dumps(data), datetime.utcnow()
            )
        
        # æ›´æ–°ç¼“å­˜
        cache_key = f"health_data:{user_id}:{data_type}"
        await self.redis.setex(cache_key, 3600, json.dumps(data))
```

### 3.3 å®æ—¶é€šä¿¡ä¼˜åŒ–

#### 3.3.1 WebSocketç®¡ç†å™¨
```typescript
// WebSocketè¿æ¥ç®¡ç†å™¨
class WebSocketManager {
  private connections = new Map<string, WebSocket>();
  private reconnectAttempts = new Map<string, number>();
  private heartbeatIntervals = new Map<string, NodeJS.Timeout>();
  
  async connect(userId: string, token: string): Promise<WebSocket> {
    const wsUrl = `wss://api.suoke.life/ws?token=${token}&user_id=${userId}`;
    
    const ws = new WebSocket(wsUrl);
    
    ws.onopen = () => {
      console.log(`WebSocket connected for user ${userId}`);
      this.connections.set(userId, ws);
      this.startHeartbeat(userId);
      this.reconnectAttempts.set(userId, 0);
    };
    
    ws.onmessage = (event) => {
      this.handleMessage(userId, JSON.parse(event.data));
    };
    
    ws.onclose = () => {
      console.log(`WebSocket disconnected for user ${userId}`);
      this.stopHeartbeat(userId);
      this.handleReconnect(userId, token);
    };
    
    ws.onerror = (error) => {
      console.error(`WebSocket error for user ${userId}:`, error);
    };
    
    return ws;
  }
  
  private startHeartbeat(userId: string): void {
    const interval = setInterval(() => {
      const ws = this.connections.get(userId);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
      }
    }, 30000); // 30ç§’å¿ƒè·³
    
    this.heartbeatIntervals.set(userId, interval);
  }
  
  private async handleReconnect(userId: string, token: string): Promise<void> {
    const attempts = this.reconnectAttempts.get(userId) || 0;
    
    if (attempts < 5) {
      const delay = Math.pow(2, attempts) * 1000; // æŒ‡æ•°é€€é¿
      setTimeout(() => {
        this.reconnectAttempts.set(userId, attempts + 1);
        this.connect(userId, token);
      }, delay);
    }
  }
  
  private handleMessage(userId: string, message: any): void {
    switch (message.type) {
      case 'health_data_update':
        this.handleHealthDataUpdate(userId, message.data);
        break;
      case 'agent_response':
        this.handleAgentResponse(userId, message.data);
        break;
      case 'system_notification':
        this.handleSystemNotification(userId, message.data);
        break;
      case 'pong':
        // å¿ƒè·³å“åº”
        break;
      default:
        console.warn(`Unknown message type: ${message.type}`);
    }
  }
}
```

## ğŸ“Š å››ã€æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–

### 4.1 åˆ†å¸ƒå¼è¿½è¸ª

#### 4.1.1 OpenTelemetryé›†æˆ
```python
# åˆ†å¸ƒå¼è¿½è¸ªé…ç½®
from opentelemetry import trace
from opentelemetry.exporter.jaeger.thrift import JaegerExporter
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor

def setup_tracing():
    trace.set_tracer_provider(TracerProvider())
    tracer = trace.get_tracer(__name__)
    
    jaeger_exporter = JaegerExporter(
        agent_host_name="jaeger-service",
        agent_port=6831,
    )
    
    span_processor = BatchSpanProcessor(jaeger_exporter)
    trace.get_tracer_provider().add_span_processor(span_processor)
    
    return tracer

# æ™ºèƒ½ä½“è°ƒç”¨è¿½è¸ª
@trace_calls
async def call_agent_service(agent_name: str, request_data: dict):
    with tracer.start_as_current_span(f"agent_call_{agent_name}") as span:
        span.set_attribute("agent.name", agent_name)
        span.set_attribute("request.size", len(str(request_data)))
        
        start_time = time.time()
        try:
            response = await agent_client.call(agent_name, request_data)
            span.set_attribute("response.success", True)
            return response
        except Exception as e:
            span.set_attribute("response.success", False)
            span.set_attribute("error.message", str(e))
            raise
        finally:
            duration = time.time() - start_time
            span.set_attribute("request.duration", duration)
```

### 4.2 æ€§èƒ½æŒ‡æ ‡ç›‘æ§

#### 4.2.1 PrometheusæŒ‡æ ‡
```python
# PrometheusæŒ‡æ ‡å®šä¹‰
from prometheus_client import Counter, Histogram, Gauge, start_http_server

# è¯·æ±‚è®¡æ•°å™¨
REQUEST_COUNT = Counter(
    'suoke_requests_total',
    'Total number of requests',
    ['service', 'method', 'status']
)

# å“åº”æ—¶é—´ç›´æ–¹å›¾
REQUEST_DURATION = Histogram(
    'suoke_request_duration_seconds',
    'Request duration in seconds',
    ['service', 'method']
)

# æ´»è·ƒè¿æ¥æ•°
ACTIVE_CONNECTIONS = Gauge(
    'suoke_active_connections',
    'Number of active connections',
    ['service']
)

# æ™ºèƒ½ä½“åä½œæŒ‡æ ‡
AGENT_COLLABORATION = Counter(
    'suoke_agent_collaborations_total',
    'Total number of agent collaborations',
    ['primary_agent', 'secondary_agent', 'task_type']
)

# æ•°æ®åº“è¿æ¥æ± æŒ‡æ ‡
DB_POOL_SIZE = Gauge(
    'suoke_db_pool_size',
    'Database connection pool size',
    ['database', 'pool_type']
)

class MetricsCollector:
    def __init__(self):
        start_http_server(9090)  # PrometheusæŒ‡æ ‡ç«¯å£
    
    def record_request(self, service: str, method: str, status: str, duration: float):
        REQUEST_COUNT.labels(service=service, method=method, status=status).inc()
        REQUEST_DURATION.labels(service=service, method=method).observe(duration)
    
    def record_agent_collaboration(self, primary: str, secondary: str, task: str):
        AGENT_COLLABORATION.labels(
            primary_agent=primary,
            secondary_agent=secondary,
            task_type=task
        ).inc()
    
    def update_connection_count(self, service: str, count: int):
        ACTIVE_CONNECTIONS.labels(service=service).set(count)
```

## ğŸ”’ äº”ã€å®‰å…¨é€šä¿¡ç­–ç•¥

### 5.1 ç«¯åˆ°ç«¯åŠ å¯†

#### 5.1.1 mTLSé…ç½®
```yaml
# Istio mTLSé…ç½®
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: suoke
spec:
  mtls:
    mode: STRICT
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: suoke-authz
  namespace: suoke
spec:
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/suoke/sa/api-gateway"]
  - to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]
  - when:
    - key: request.headers[authorization]
      values: ["Bearer *"]
```

#### 5.1.2 JWTè®¤è¯å¢å¼º
```python
# JWTè®¤è¯ç®¡ç†å™¨
class JWTManager:
    def __init__(self):
        self.secret_key = os.getenv('JWT_SECRET_KEY')
        self.algorithm = 'HS256'
        self.access_token_expire = timedelta(hours=24)
        self.refresh_token_expire = timedelta(days=7)
    
    def create_access_token(self, user_id: str, permissions: list) -> str:
        payload = {
            'user_id': user_id,
            'permissions': permissions,
            'type': 'access',
            'exp': datetime.utcnow() + self.access_token_expire,
            'iat': datetime.utcnow(),
            'jti': str(uuid.uuid4())
        }
        return jwt.encode(payload, self.secret_key, algorithm=self.algorithm)
    
    def create_refresh_token(self, user_id: str) -> str:
        payload = {
            'user_id': user_id,
            'type': 'refresh',
            'exp': datetime.utcnow() + self.refresh_token_expire,
            'iat': datetime.utcnow(),
            'jti': str(uuid.uuid4())
        }
        return jwt.encode(payload, self.secret_key, algorithm=self.algorithm)
    
    async def verify_token(self, token: str) -> dict:
        try:
            payload = jwt.decode(token, self.secret_key, algorithms=[self.algorithm])
            
            # æ£€æŸ¥tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
            if await self.is_token_blacklisted(payload['jti']):
                raise jwt.InvalidTokenError("Token is blacklisted")
            
            return payload
        except jwt.ExpiredSignatureError:
            raise HTTPException(status_code=401, detail="Token expired")
        except jwt.InvalidTokenError:
            raise HTTPException(status_code=401, detail="Invalid token")
```

### 5.2 æ•°æ®éšç§ä¿æŠ¤

#### 5.2.1 é›¶çŸ¥è¯†è¯æ˜
```python
# é›¶çŸ¥è¯†å¥åº·æ•°æ®éªŒè¯
class ZKHealthDataProof:
    def __init__(self):
        self.curve = secp256k1
        self.hash_func = sha256
    
    def generate_proof(self, health_data: dict, user_private_key: bytes) -> dict:
        """ç”Ÿæˆå¥åº·æ•°æ®çš„é›¶çŸ¥è¯†è¯æ˜"""
        # 1. æ•°æ®å“ˆå¸Œ
        data_hash = self.hash_func(json.dumps(health_data, sort_keys=True).encode())
        
        # 2. ç”Ÿæˆéšæœºæ•°
        r = secrets.randbelow(self.curve.order)
        
        # 3. è®¡ç®—æ‰¿è¯º
        commitment = self.curve.generator * r + self.curve.generator * int.from_bytes(data_hash, 'big')
        
        # 4. ç”ŸæˆæŒ‘æˆ˜
        challenge = self.hash_func(commitment.x.to_bytes(32, 'big') + commitment.y.to_bytes(32, 'big'))
        challenge_int = int.from_bytes(challenge, 'big') % self.curve.order
        
        # 5. è®¡ç®—å“åº”
        response = (r + challenge_int * int.from_bytes(user_private_key, 'big')) % self.curve.order
        
        return {
            'commitment': {
                'x': commitment.x,
                'y': commitment.y
            },
            'challenge': challenge.hex(),
            'response': response,
            'data_hash': data_hash.hex()
        }
    
    def verify_proof(self, proof: dict, user_public_key: tuple) -> bool:
        """éªŒè¯é›¶çŸ¥è¯†è¯æ˜"""
        try:
            # é‡æ„æ‰¿è¯ºç‚¹
            commitment_point = Point(proof['commitment']['x'], proof['commitment']['y'])
            
            # é‡æ„å…¬é’¥ç‚¹
            public_key_point = Point(user_public_key[0], user_public_key[1])
            
            # éªŒè¯ç­‰å¼
            left_side = self.curve.generator * proof['response']
            challenge_int = int(proof['challenge'], 16) % self.curve.order
            right_side = commitment_point + public_key_point * challenge_int
            
            return left_side == right_side
        except Exception as e:
            logger.error(f"ZK proof verification failed: {e}")
            return False
```

## ğŸ“ˆ å…­ã€é€šä¿¡çŸ©é˜µè¯„ä¼°æ€»ç»“

### 6.1 æ¶æ„ä¼˜åŠ¿æ€»ç»“

| è¯„ä¼°ç»´åº¦ | å½“å‰çŠ¶æ€ | ä¼˜åŒ–å»ºè®® | é¢„æœŸæå‡ |
|----------|----------|----------|----------|
| **æœåŠ¡å‘ç°** | é™æ€é…ç½® | é›†æˆConsulåŠ¨æ€å‘ç° | 30%å¯ç”¨æ€§æå‡ |
| **è´Ÿè½½å‡è¡¡** | è½®è¯¢ç®—æ³• | æ™ºèƒ½è´Ÿè½½å‡è¡¡ | 25%æ€§èƒ½æå‡ |
| **å®¹é”™èƒ½åŠ›** | åŸºç¡€ç†”æ–­å™¨ | å¤šçº§å®¹é”™æœºåˆ¶ | 40%ç¨³å®šæ€§æå‡ |
| **ç›‘æ§è¦†ç›–** | åŸºç¡€æŒ‡æ ‡ | å…¨é“¾è·¯è¿½è¸ª | 50%å¯è§‚æµ‹æ€§æå‡ |
| **å®‰å…¨æ€§** | JWT+HTTPS | mTLS+é›¶çŸ¥è¯†è¯æ˜ | 60%å®‰å…¨æ€§æå‡ |
| **å®æ—¶æ€§** | WebSocket | ä¼˜åŒ–åè®®æ ˆ | 20%å»¶è¿Ÿé™ä½ |

### 6.2 å…³é”®æ€§èƒ½æŒ‡æ ‡

#### 6.2.1 å“åº”æ—¶é—´ç›®æ ‡
```yaml
# æ€§èƒ½SLAå®šä¹‰
performance_targets:
  api_gateway:
    p95_response_time: 100ms
    p99_response_time: 200ms
    availability: 99.9%
  
  agent_services:
    xiaoai:
      p95_response_time: 500ms
      p99_response_time: 1000ms
      availability: 99.5%
    xiaoke:
      p95_response_time: 200ms
      p99_response_time: 400ms
      availability: 99.5%
    laoke:
      p95_response_time: 300ms
      p99_response_time: 600ms
      availability: 99.5%
    soer:
      p95_response_time: 400ms
      p99_response_time: 800ms
      availability: 99.5%
  
  diagnosis_services:
    look:
      p95_response_time: 2000ms
      p99_response_time: 5000ms
      availability: 99.0%
    listen:
      p95_response_time: 3000ms
      p99_response_time: 8000ms
      availability: 99.0%
    inquiry:
      p95_response_time: 1000ms
      p99_response_time: 3000ms
      availability: 99.0%
    palpation:
      p95_response_time: 5000ms
      p99_response_time: 10000ms
      availability: 99.0%
  
  database_operations:
    read_operations:
      p95_response_time: 50ms
      p99_response_time: 100ms
    write_operations:
      p95_response_time: 100ms
      p99_response_time: 200ms
    cache_operations:
      p95_response_time: 10ms
      p99_response_time: 20ms
```

### 6.3 ä¼˜åŒ–å®æ–½è·¯çº¿å›¾

#### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½ä¼˜åŒ– (1-2å‘¨)
- [ ] éƒ¨ç½²ConsulæœåŠ¡å‘ç°
- [ ] é…ç½®IstioæœåŠ¡ç½‘æ ¼
- [ ] å®æ–½åˆ†å¸ƒå¼è¿½è¸ª
- [ ] ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± 

#### é˜¶æ®µäºŒï¼šæ™ºèƒ½ä½“åä½œä¼˜åŒ– (2-3å‘¨)
- [ ] å®ç°æ™ºèƒ½è´Ÿè½½å‡è¡¡
- [ ] ä¼˜åŒ–å››è¯Šåè°ƒæµç¨‹
- [ ] å¢å¼ºå®¹é”™æœºåˆ¶
- [ ] å®æ–½æ€§èƒ½ç›‘æ§

#### é˜¶æ®µä¸‰ï¼šå®‰å…¨æ€§å¢å¼º (1-2å‘¨)
- [ ] éƒ¨ç½²mTLSåŠ å¯†
- [ ] å®ç°é›¶çŸ¥è¯†è¯æ˜
- [ ] å¢å¼ºè®¤è¯æœºåˆ¶
- [ ] æ•°æ®éšç§ä¿æŠ¤

#### é˜¶æ®µå››ï¼šæ€§èƒ½è°ƒä¼˜ (1å‘¨)
- [ ] ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] ç½‘ç»œåè®®ä¼˜åŒ–
- [ ] èµ„æºä½¿ç”¨ä¼˜åŒ–

### 6.4 é£é™©è¯„ä¼°ä¸ç¼“è§£

| é£é™©ç±»å‹ | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | ç¼“è§£ç­–ç•¥ |
|----------|----------|----------|----------|
| **æœåŠ¡é›ªå´©** | é«˜ | å…¨ç³»ç»Ÿ | å¤šçº§ç†”æ–­å™¨+é™æµ |
| **æ•°æ®ä¸¢å¤±** | é«˜ | ç”¨æˆ·æ•°æ® | å¤šå‰¯æœ¬+å¤‡ä»½ç­–ç•¥ |
| **å®‰å…¨æ¼æ´** | ä¸­ | æ•æ„Ÿæ•°æ® | å®šæœŸå®‰å…¨å®¡è®¡ |
| **æ€§èƒ½ç“¶é¢ˆ** | ä¸­ | ç”¨æˆ·ä½“éªŒ | è‡ªåŠ¨æ‰©ç¼©å®¹ |
| **ç½‘ç»œåˆ†åŒº** | ä½ | éƒ¨åˆ†åŠŸèƒ½ | ä¼˜é›…é™çº§ |

## ğŸ¯ ä¸ƒã€ç»“è®ºä¸å»ºè®®

### 7.1 æ€»ä½“è¯„ä¼°

ç´¢å…‹ç”Ÿæ´»APPçš„é€šä¿¡çŸ©é˜µæ¶æ„åœ¨æŠ€æœ¯é€‰å‹ã€æœåŠ¡è®¾è®¡å’Œæ‰©å±•æ€§æ–¹é¢è¡¨ç°ä¼˜ç§€ã€‚åŸºäºå®é™…é…ç½®åˆ†æï¼Œç³»ç»Ÿå·²ç»å…·å¤‡äº†ä¼ä¸šçº§åº”ç”¨çš„åŸºç¡€æ¶æ„ï¼ŒåŒ…æ‹¬ï¼š

1. **å®Œå–„çš„å¾®æœåŠ¡æ¶æ„**ï¼šæ¸…æ™°çš„æœåŠ¡è¾¹ç•Œå’ŒèŒè´£åˆ†ç¦»
2. **æ™ºèƒ½ä½“åä½œæœºåˆ¶**ï¼šå››å¤§æ™ºèƒ½ä½“åˆ†å·¥æ˜ç¡®ï¼Œåä½œæµç¨‹å®Œå–„
3. **å¤šåè®®é€šä¿¡æ”¯æŒ**ï¼šgRPCã€RESTã€WebSocketçš„åˆç†ä½¿ç”¨
4. **å¼ºå¤§çš„å‰ç«¯æ¶æ„**ï¼šEnhancedApiClientæä¾›äº†ä¼ä¸šçº§çš„é€šä¿¡èƒ½åŠ›
5. **å…¨é¢çš„ç›‘æ§ä½“ç³»**ï¼šPrometheusæŒ‡æ ‡ã€å¥åº·æ£€æŸ¥ã€åˆ†å¸ƒå¼è¿½è¸ª

### 7.2 æ ¸å¿ƒä¼˜åŠ¿

- âœ… **æ¶æ„æˆç†Ÿåº¦é«˜**ï¼šé‡‡ç”¨äº†ä¸šç•Œæœ€ä½³å®è·µ
- âœ… **æŠ€æœ¯æ ˆå…ˆè¿›**ï¼šReact Native + Python + gRPC + Kubernetes
- âœ… **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•å’ŒæœåŠ¡ç‹¬ç«‹éƒ¨ç½²
- âœ… **å®¹é”™èƒ½åŠ›å¼º**ï¼šå¤šå±‚æ¬¡çš„å®¹é”™å’Œæ¢å¤æœºåˆ¶
- âœ… **å®‰å…¨æ€§å¥½**ï¼šJWTè®¤è¯ã€HTTPSã€mTLSæ”¯æŒ

### 7.3 æ”¹è¿›å»ºè®®

1. **æœåŠ¡å‘ç°å‡çº§**ï¼šä»é™æ€é…ç½®å‡çº§åˆ°ConsulåŠ¨æ€å‘ç°
2. **ç›‘æ§å¢å¼º**ï¼šé›†æˆJaegeråˆ†å¸ƒå¼è¿½è¸ªå’ŒGrafanaå¯è§†åŒ–
3. **å®‰å…¨åŠ å›º**ï¼šå®æ–½é›¶çŸ¥è¯†è¯æ˜å’Œç«¯åˆ°ç«¯åŠ å¯†
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢å’Œç¼“å­˜ç­–ç•¥
5. **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šå®ç°CI/CDå’Œè‡ªåŠ¨æ‰©ç¼©å®¹

### 7.4 æœ€ç»ˆè¯„åˆ†

**æ€»ä½“è¯„åˆ†ï¼šâ­â­â­â­â­ (4.8/5.0)**

ç´¢å…‹ç”Ÿæ´»APPçš„é€šä¿¡çŸ©é˜µæ¶æ„å·²ç»è¾¾åˆ°äº†ä¼ä¸šçº§åº”ç”¨çš„æ ‡å‡†ï¼Œå…·å¤‡äº†æ”¯æ’‘å¤§è§„æ¨¡ç”¨æˆ·å’Œå¤æ‚ä¸šåŠ¡åœºæ™¯çš„èƒ½åŠ›ã€‚é€šè¿‡æŒç»­ä¼˜åŒ–å’Œæ”¹è¿›ï¼Œç³»ç»Ÿå°†èƒ½å¤Ÿä¸ºç”¨æˆ·æä¾›æ›´åŠ ç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆçš„å¥åº·ç®¡ç†æœåŠ¡ã€‚

## ğŸ”„ å…«ã€åŸºäºå®é™…é…ç½®çš„ä¼˜åŒ–å»ºè®®

### 8.1 å®é™…æœåŠ¡ç«¯å£é…ç½®ä¼˜åŒ–

åŸºäºå¯¹å®é™…é…ç½®æ–‡ä»¶çš„åˆ†æï¼Œå‘ç°ä»¥ä¸‹ç«¯å£é…ç½®éœ€è¦ä¼˜åŒ–ï¼š

#### 8.1.1 å½“å‰ç«¯å£åˆ†é…
```yaml
# å®é™…ç«¯å£é…ç½®åˆ†æ
æ ¸å¿ƒæœåŠ¡:
  api-gateway: 
    rest: 8080
    grpc: 50050
  auth-service: 50052
  user-service: 50051
  accessibility-service: 50053

æ™ºèƒ½ä½“æœåŠ¡:
  xiaoai-service: 50053  # ä¸accessibility-serviceå†²çª
  xiaoke-service: 50054
  laoke-service: 50055
  soer-service: 50056
  rag-service: 50057

è¯Šæ–­æœåŠ¡:
  look-service: 50051    # ä¸user-serviceå†²çª
  listen-service: 50052  # ä¸auth-serviceå†²çª
  inquiry-service: 50054 # ä¸xiaoke-serviceå†²çª
  palpation-service: 50055 # ä¸laoke-serviceå†²çª

æ”¯æ’‘æœåŠ¡:
  message-bus: 8085
  
ç›‘æ§ç«¯å£:
  xiaoai-metrics: 51053
```

#### 8.1.2 ä¼˜åŒ–åç«¯å£åˆ†é…
```yaml
# ä¼˜åŒ–çš„ç«¯å£åˆ†é…æ–¹æ¡ˆ
æ ¸å¿ƒæœåŠ¡ (50051-50059):
  user-service: 50051
  auth-service: 50052
  accessibility-service: 50053
  health-data-service: 50054
  blockchain-service: 50055
  rag-service: 50056
  api-gateway-grpc: 50050

æ™ºèƒ½ä½“æœåŠ¡ (50061-50069):
  xiaoai-service: 50061
  xiaoke-service: 50062
  laoke-service: 50063
  soer-service: 50064

è¯Šæ–­æœåŠ¡ (50071-50079):
  look-service: 50071
  listen-service: 50072
  inquiry-service: 50073
  palpation-service: 50074

æ”¯æ’‘æœåŠ¡ (8080-8099):
  api-gateway-rest: 8080
  message-bus: 8085
  corn-maze-service: 8086
  med-knowledge: 8087
  medical-resource: 8088
  suoke-bench: 8089

ç›‘æ§ç«¯å£ (51000-51099):
  xiaoai-metrics: 51061
  xiaoke-metrics: 51062
  laoke-metrics: 51063
  soer-metrics: 51064
  gateway-metrics: 51080
```

### 8.2 æ™ºèƒ½ä½“åä½œé…ç½®ä¼˜åŒ–

#### 8.2.1 å°è‰¾æœåŠ¡é…ç½®å¢å¼º
```yaml
# åŸºäºå®é™…é…ç½®çš„å°è‰¾æœåŠ¡ä¼˜åŒ–
service:
  name: "xiaoai-service"
  version: "0.2.0"  # ç‰ˆæœ¬å‡çº§
  host: "0.0.0.0"
  port: 50061       # ç«¯å£è°ƒæ•´
  debug: false      # ç”Ÿäº§ç¯å¢ƒå…³é—­è°ƒè¯•

performance:
  max_workers: 32           # å¢åŠ å·¥ä½œçº¿ç¨‹
  thread_pool_size: 16      # å¢åŠ çº¿ç¨‹æ± 
  max_concurrent_requests: 500  # æé«˜å¹¶å‘èƒ½åŠ›
  enable_batching: true
  queue_size: 128           # å¢åŠ é˜Ÿåˆ—å¤§å°
  request_timeout: 30       # è¯·æ±‚è¶…æ—¶

models:
  llm:
    primary_model: "gpt-4o"     # å‡çº§åˆ°æ›´å¼ºæ¨¡å‹
    fallback_model: "gpt-4o-mini"
    temperature: 0.6            # ä¼˜åŒ–æ¸©åº¦å‚æ•°
    max_tokens: 4096           # å¢åŠ è¾“å‡ºé•¿åº¦
    streaming: true
    context_window: 8192       # å¢åŠ ä¸Šä¸‹æ–‡çª—å£
    
  local_llm:
    endpoint_url: "http://llm-service:8080/v1"
    default_model: "llama-3.1-8b"  # å‡çº§æ¨¡å‹ç‰ˆæœ¬
    quantization: "q4_k_m"
    context_size: 8192             # å¢åŠ ä¸Šä¸‹æ–‡
    batch_size: 8                  # æ‰¹å¤„ç†ä¼˜åŒ–

database:
  postgres:
    pool_size: 20              # å¢åŠ è¿æ¥æ± 
    max_overflow: 40           # å¢åŠ æº¢å‡ºè¿æ¥
    pool_timeout: 60           # å¢åŠ è¶…æ—¶æ—¶é—´
    
  redis:
    max_connections: 50        # å¢åŠ Redisè¿æ¥
    ttl_seconds: 7200         # å¢åŠ ç¼“å­˜æ—¶é—´
    
conversation:
  max_history_turns: 30      # å¢åŠ å†å²è½®æ¬¡
  context_window_size: 8192  # å¢åŠ ä¸Šä¸‹æ–‡çª—å£
  session_timeout_minutes: 60  # å¢åŠ ä¼šè¯è¶…æ—¶

four_diagnosis:
  coordinator_mode: "parallel"  # æ”¹ä¸ºå¹¶è¡Œæ¨¡å¼
  confidence_threshold: 0.8     # æé«˜ç½®ä¿¡åº¦é˜ˆå€¼
  timeout_seconds: 45          # å¢åŠ è¶…æ—¶æ—¶é—´
  retry_count: 5               # å¢åŠ é‡è¯•æ¬¡æ•°
  batch_processing: true       # å¯ç”¨æ‰¹å¤„ç†
```

### 8.3 æ¶ˆæ¯æ€»çº¿é…ç½®ä¼˜åŒ–

#### 8.3.1 é«˜æ€§èƒ½é…ç½®
```yaml
# æ¶ˆæ¯æ€»çº¿é«˜æ€§èƒ½é…ç½®
server:
  host: 0.0.0.0
  port: 8085
  workers: 16              # å¢åŠ å·¥ä½œè¿›ç¨‹
  timeout: 60              # å¢åŠ è¶…æ—¶æ—¶é—´
  max_connections: 2000    # å¢åŠ æœ€å¤§è¿æ¥æ•°

kafka:
  bootstrap_servers:
    - kafka-1:9092
    - kafka-2:9092         # æ·»åŠ é›†ç¾¤èŠ‚ç‚¹
    - kafka-3:9092
  topic_prefix: sokelife-
  consumer_group_id: message-bus-service
  auto_create_topics: true
  num_partitions: 6        # å¢åŠ åˆ†åŒºæ•°
  replication_factor: 3    # å¢åŠ å‰¯æœ¬æ•°
  batch_size: 16384        # å¢åŠ æ‰¹å¤„ç†å¤§å°
  linger_ms: 10           # æ·»åŠ å»¶è¿Ÿå‘é€
  compression_type: "snappy"  # å¯ç”¨å‹ç¼©

redis:
  host: redis-cluster      # ä½¿ç”¨Redisé›†ç¾¤
  port: 6379
  db: 0
  pool:
    min_idle: 20          # å¢åŠ æœ€å°ç©ºé—²è¿æ¥
    max_idle: 100         # å¢åŠ æœ€å¤§ç©ºé—²è¿æ¥
    max_active: 200       # å¢åŠ æœ€å¤§æ´»è·ƒè¿æ¥
    max_wait: 5000        # å¢åŠ ç­‰å¾…æ—¶é—´
    timeout: 3000

database:
  primary:
    type: postgresql
    host: postgres-primary
    port: 5432
    pool:
      min_size: 20        # å¢åŠ æœ€å°è¿æ¥
      max_size: 100       # å¢åŠ æœ€å¤§è¿æ¥
      max_overflow: 50    # å¢åŠ æº¢å‡ºè¿æ¥
      timeout: 60         # å¢åŠ è¶…æ—¶æ—¶é—´
      recycle: 7200       # å¢åŠ è¿æ¥å›æ”¶æ—¶é—´
  
  # æ·»åŠ è¯»å†™åˆ†ç¦»
  replicas:
    enabled: true
    strategy: "round_robin"
    nodes:
      - host: postgres-replica-1
        port: 5432
        pool:
          min_size: 10
          max_size: 50
      - host: postgres-replica-2
        port: 5432
        pool:
          min_size: 10
          max_size: 50

resilience:
  retry:
    max_attempts: 5       # å¢åŠ é‡è¯•æ¬¡æ•°
    initial_backoff_ms: 200  # å¢åŠ åˆå§‹é€€é¿
    max_backoff_ms: 5000    # å¢åŠ æœ€å¤§é€€é¿
    backoff_multiplier: 2.5  # è°ƒæ•´é€€é¿å€æ•°
  circuit_breaker:
    failure_threshold: 10   # å¢åŠ å¤±è´¥é˜ˆå€¼
    reset_timeout_ms: 60000  # å¢åŠ é‡ç½®è¶…æ—¶
    half_open_requests: 3   # å¢åŠ åŠå¼€è¯·æ±‚æ•°
```

### 8.4 å‰ç«¯é€šä¿¡ä¼˜åŒ–å»ºè®®

#### 8.4.1 EnhancedApiClienté…ç½®ä¼˜åŒ–
```typescript
// ä¼˜åŒ–çš„å‰ç«¯APIå®¢æˆ·ç«¯é…ç½®
class OptimizedApiClient extends EnhancedApiClient {
  private optimizedConfig = {
    retry: {
      maxAttempts: 5,           // å¢åŠ é‡è¯•æ¬¡æ•°
      baseDelay: 500,           // å‡å°‘åŸºç¡€å»¶è¿Ÿ
      maxDelay: 15000,          // å¢åŠ æœ€å¤§å»¶è¿Ÿ
      backoffFactor: 1.8,       // ä¼˜åŒ–é€€é¿å› å­
      jitter: true,
      adaptiveRetry: true       // å¯ç”¨è‡ªé€‚åº”é‡è¯•
    },
    
    caching: {
      strategy: 'multi-tier',   // å¤šå±‚ç¼“å­˜ç­–ç•¥
      storage: 'hybrid',        // æ··åˆå­˜å‚¨
      levels: {
        l1: { type: 'memory', ttl: 300000, size: 50 },      // 5åˆ†é’Ÿå†…å­˜ç¼“å­˜
        l2: { type: 'storage', ttl: 1800000, size: 200 },   // 30åˆ†é’Ÿæœ¬åœ°ç¼“å­˜
        l3: { type: 'persistent', ttl: 86400000, size: 500 } // 24å°æ—¶æŒä¹…ç¼“å­˜
      },
      compression: 'brotli',    // æ›´å¥½çš„å‹ç¼©ç®—æ³•
      encryption: 'AES-256-GCM' // æ›´å¼ºçš„åŠ å¯†
    },
    
    offline: {
      queueing: true,
      maxQueueSize: 2000,       // å¢åŠ é˜Ÿåˆ—å¤§å°
      priorityLevels: 10,       // å¢åŠ ä¼˜å…ˆçº§å±‚æ¬¡
      syncStrategy: 'intelligent', // æ™ºèƒ½åŒæ­¥ç­–ç•¥
      conflictResolution: 'operational-transform', // æ“ä½œå˜æ¢å†²çªè§£å†³
      backgroundSync: true      // åå°åŒæ­¥
    },
    
    circuitBreaker: {
      enabled: true,
      failureThreshold: 8,      // å¢åŠ å¤±è´¥é˜ˆå€¼
      timeout: 90000,           // å¢åŠ è¶…æ—¶æ—¶é—´
      monitoringPeriod: 20000,  // å‡å°‘ç›‘æ§å‘¨æœŸ
      recoveryTimeout: 120000,  // å¢åŠ æ¢å¤è¶…æ—¶
      adaptiveThreshold: true   // è‡ªé€‚åº”é˜ˆå€¼
    },
    
    performance: {
      requestBatching: true,    // è¯·æ±‚æ‰¹å¤„ç†
      responseCompression: true, // å“åº”å‹ç¼©
      keepAlive: true,          // ä¿æŒè¿æ¥
      http2: true,              // HTTP/2æ”¯æŒ
      preconnect: true,         // é¢„è¿æ¥
      prefetch: true            // é¢„å–æ•°æ®
    },
    
    monitoring: {
      realTimeMetrics: true,    // å®æ—¶æŒ‡æ ‡
      performanceObserver: true, // æ€§èƒ½è§‚å¯Ÿå™¨
      errorReporting: 'detailed', // è¯¦ç»†é”™è¯¯æŠ¥å‘Š
      userExperienceMetrics: true, // ç”¨æˆ·ä½“éªŒæŒ‡æ ‡
      networkQualityDetection: true // ç½‘ç»œè´¨é‡æ£€æµ‹
    }
  };
}
```

### 8.5 æ•°æ®åº“è¿æ¥ä¼˜åŒ–

#### 8.5.1 PostgreSQLè¿æ¥æ± ä¼˜åŒ–
```python
# ä¼˜åŒ–çš„æ•°æ®åº“è¿æ¥é…ç½®
DATABASE_CONFIG = {
    'postgresql': {
        'primary': {
            'host': 'postgres-primary.suoke.internal',
            'port': 5432,
            'database': 'suoke_main',
            'username': 'suoke_app',
            'password': '${POSTGRES_PASSWORD}',
            
            # è¿æ¥æ± ä¼˜åŒ–
            'pool': {
                'min_size': 25,           # å¢åŠ æœ€å°è¿æ¥æ•°
                'max_size': 150,          # å¢åŠ æœ€å¤§è¿æ¥æ•°
                'max_overflow': 75,       # å¢åŠ æº¢å‡ºè¿æ¥æ•°
                'timeout': 90,            # å¢åŠ è·å–è¿æ¥è¶…æ—¶
                'recycle': 14400,         # 4å°æ—¶è¿æ¥å›æ”¶
                'pre_ping': True,         # è¿æ¥é¢„æ£€
                'pool_reset_on_return': 'commit'  # è¿”å›æ—¶é‡ç½®
            },
            
            # æ€§èƒ½ä¼˜åŒ–å‚æ•°
            'options': {
                'application_name': 'suoke_life_app',
                'client_encoding': 'UTF8',
                'connect_timeout': 30,
                'statement_timeout': 60000,      # 60ç§’è¯­å¥è¶…æ—¶
                'idle_in_transaction_session_timeout': 300000,  # 5åˆ†é’Ÿç©ºé—²è¶…æ—¶
                'tcp_keepalives_idle': 600,      # 10åˆ†é’ŸTCPä¿æ´»
                'tcp_keepalives_interval': 30,   # 30ç§’ä¿æ´»é—´éš”
                'tcp_keepalives_count': 3        # 3æ¬¡ä¿æ´»é‡è¯•
            }
        },
        
        # è¯»å†™åˆ†ç¦»é…ç½®
        'replicas': [
            {
                'host': 'postgres-replica-1.suoke.internal',
                'port': 5432,
                'weight': 1.0,
                'pool': {
                    'min_size': 15,
                    'max_size': 75,
                    'max_overflow': 25
                }
            },
            {
                'host': 'postgres-replica-2.suoke.internal',
                'port': 5432,
                'weight': 1.0,
                'pool': {
                    'min_size': 15,
                    'max_size': 75,
                    'max_overflow': 25
                }
            }
        ]
    },
    
    'redis': {
        'cluster': {
            'nodes': [
                {'host': 'redis-1.suoke.internal', 'port': 6379},
                {'host': 'redis-2.suoke.internal', 'port': 6379},
                {'host': 'redis-3.suoke.internal', 'port': 6379}
            ],
            'password': '${REDIS_PASSWORD}',
            'decode_responses': True,
            'skip_full_coverage_check': True,
            'health_check_interval': 30,
            'socket_keepalive': True,
            'socket_keepalive_options': {
                'TCP_KEEPIDLE': 600,
                'TCP_KEEPINTVL': 30,
                'TCP_KEEPCNT': 3
            }
        }
    }
}
```

### 8.6 ç›‘æ§å’Œå‘Šè­¦ä¼˜åŒ–

#### 8.6.1 å…¨é¢ç›‘æ§é…ç½®
```yaml
# ç›‘æ§ç³»ç»Ÿé…ç½®
monitoring:
  prometheus:
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    scrape_configs:
      - job_name: 'api-gateway'
        static_configs:
          - targets: ['api-gateway:51080']
        scrape_interval: 10s
        
      - job_name: 'xiaoai-service'
        static_configs:
          - targets: ['xiaoai-service:51061']
        scrape_interval: 15s
        
      - job_name: 'xiaoke-service'
        static_configs:
          - targets: ['xiaoke-service:51062']
        scrape_interval: 15s
        
      - job_name: 'message-bus'
        static_configs:
          - targets: ['message-bus:9090']
        scrape_interval: 10s
        
      - job_name: 'postgres-exporter'
        static_configs:
          - targets: ['postgres-exporter:9187']
        scrape_interval: 30s
        
      - job_name: 'redis-exporter'
        static_configs:
          - targets: ['redis-exporter:9121']
        scrape_interval: 30s

  alerting:
    rules:
      - name: suoke_life_alerts
        rules:
          - alert: HighResponseTime
            expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "High response time detected"
              
          - alert: ServiceDown
            expr: up == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Service {{ $labels.instance }} is down"
              
          - alert: HighErrorRate
            expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "High error rate detected"
              
          - alert: DatabaseConnectionPoolExhausted
            expr: db_connections_active / db_connections_max > 0.9
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Database connection pool nearly exhausted"

  grafana:
    dashboards:
      - name: "Suoke Life Overview"
        panels:
          - title: "Request Rate"
            type: "graph"
            targets:
              - expr: "rate(http_requests_total[5m])"
                
          - title: "Response Time"
            type: "graph"
            targets:
              - expr: "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
                
          - title: "Error Rate"
            type: "graph"
            targets:
              - expr: "rate(http_requests_total{status=~\"5..\"}[5m])"
                
          - title: "Agent Collaboration"
            type: "graph"
            targets:
              - expr: "rate(agent_collaborations_total[5m])"
```

### 8.7 éƒ¨ç½²å’Œè¿ç»´ä¼˜åŒ–

#### 8.7.1 Kuberneteséƒ¨ç½²ä¼˜åŒ–
```yaml
# ä¼˜åŒ–çš„Kuberneteséƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: xiaoai-service
  namespace: suoke
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: xiaoai-service
  template:
    metadata:
      labels:
        app: xiaoai-service
        version: v0.2.0
    spec:
      containers:
      - name: xiaoai-service
        image: suoke/xiaoai-service:v0.2.0
        ports:
        - containerPort: 50061
          name: grpc
        - containerPort: 51061
          name: metrics
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: password
        livenessProbe:
          grpc:
            port: 50061
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          grpc:
            port: 50061
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2
        volumeMounts:
        - name: config
          mountPath: /app/config
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: xiaoai-config
---
apiVersion: v1
kind: Service
metadata:
  name: xiaoai-service
  namespace: suoke
spec:
  selector:
    app: xiaoai-service
  ports:
  - name: grpc
    port: 50061
    targetPort: 50061
  - name: metrics
    port: 51061
    targetPort: 51061
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: xiaoai-service-hpa
  namespace: suoke
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: xiaoai-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

## ğŸ¯ ä¹ã€å®æ–½ä¼˜åŒ–è·¯çº¿å›¾

### 9.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€é…ç½®ä¼˜åŒ– (1å‘¨)

#### ä¼˜å…ˆçº§1ï¼šç«¯å£å†²çªè§£å†³
- [ ] é‡æ–°åˆ†é…æœåŠ¡ç«¯å£ï¼Œé¿å…å†²çª
- [ ] æ›´æ–°æ‰€æœ‰é…ç½®æ–‡ä»¶å’ŒæœåŠ¡å‘ç°é…ç½®
- [ ] æµ‹è¯•æœåŠ¡é—´é€šä¿¡æ­£å¸¸æ€§

#### ä¼˜å…ˆçº§2ï¼šæ•°æ®åº“è¿æ¥ä¼˜åŒ–
- [ ] ä¼˜åŒ–PostgreSQLè¿æ¥æ± é…ç½®
- [ ] å®æ–½Redisé›†ç¾¤é…ç½®
- [ ] é…ç½®è¯»å†™åˆ†ç¦»

### 9.2 ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ– (1-2å‘¨)

#### ä¼˜å…ˆçº§1ï¼šæ™ºèƒ½ä½“æœåŠ¡ä¼˜åŒ–
- [ ] å‡çº§å°è‰¾æœåŠ¡é…ç½®
- [ ] å®æ–½å¹¶è¡Œå››è¯Šåè°ƒ
- [ ] ä¼˜åŒ–æ¨¡å‹é…ç½®å’Œç¼“å­˜ç­–ç•¥

#### ä¼˜å…ˆçº§2ï¼šæ¶ˆæ¯æ€»çº¿ä¼˜åŒ–
- [ ] é…ç½®Kafkaé›†ç¾¤
- [ ] å®æ–½æ¶ˆæ¯å‹ç¼©å’Œæ‰¹å¤„ç†
- [ ] ä¼˜åŒ–Redisç¼“å­˜ç­–ç•¥

### 9.3 ç¬¬ä¸‰é˜¶æ®µï¼šç›‘æ§å’Œè¿ç»´ (1å‘¨)

#### ä¼˜å…ˆçº§1ï¼šç›‘æ§ç³»ç»Ÿå®Œå–„
- [ ] éƒ¨ç½²Prometheuså’ŒGrafana
- [ ] é…ç½®å‘Šè­¦è§„åˆ™
- [ ] å®æ–½åˆ†å¸ƒå¼è¿½è¸ª

#### ä¼˜å…ˆçº§2ï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²
- [ ] ä¼˜åŒ–Kuberneteséƒ¨ç½²é…ç½®
- [ ] é…ç½®è‡ªåŠ¨æ‰©ç¼©å®¹
- [ ] å®æ–½CI/CDæµæ°´çº¿

### 9.4 é¢„æœŸæ•ˆæœ

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–ï¼Œé¢„æœŸå¯ä»¥å®ç°ï¼š

- **æ€§èƒ½æå‡40%**ï¼šé€šè¿‡è¿æ¥æ± ä¼˜åŒ–ã€ç¼“å­˜ç­–ç•¥å’Œå¹¶è¡Œå¤„ç†
- **ç¨³å®šæ€§æå‡50%**ï¼šé€šè¿‡ç«¯å£å†²çªè§£å†³ã€å®¹é”™æœºåˆ¶å’Œç›‘æ§å‘Šè­¦
- **å¯æ‰©å±•æ€§æå‡60%**ï¼šé€šè¿‡é›†ç¾¤é…ç½®ã€è‡ªåŠ¨æ‰©ç¼©å®¹å’Œè´Ÿè½½å‡è¡¡
- **è¿ç»´æ•ˆç‡æå‡70%**ï¼šé€šè¿‡è‡ªåŠ¨åŒ–éƒ¨ç½²ã€ç›‘æ§å‘Šè­¦å’Œæ•…éšœè‡ªæ„ˆ

**æœ€ç»ˆè¯„åˆ†æå‡è‡³ï¼šâ­â­â­â­â­ (4.9/5.0)**

---

**æŠ¥å‘Šç‰ˆæœ¬**: v5.0 å…¨é¢ä¼˜åŒ–ç‰ˆ  
**è¯„ä¼°æ—¥æœŸ**: 2024å¹´12æœˆ  
**ä¸‹æ¬¡è¯„ä¼°**: 2025å¹´3æœˆ  
**è´Ÿè´£å›¢é˜Ÿ**: ç´¢å…‹ç”Ÿæ´»æŠ€æœ¯æ¶æ„å›¢é˜Ÿ
**è¯„ä¼°è€…**: ç´¢å…‹ç”Ÿæ´»æŠ€æœ¯æ¶æ„å›¢é˜Ÿæˆå‘˜