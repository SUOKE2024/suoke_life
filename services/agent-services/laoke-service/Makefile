# è€å…‹æ™ºèƒ½ä½“æœåŠ¡ Makefile

.PHONY: help install dev test lint format clean build docker run-dev run-prod

# é»˜è®¤ç›®æ ‡
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "è€å…‹æ™ºèƒ½ä½“æœåŠ¡ - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ç¯å¢ƒè®¾ç½®
install: ## å®‰è£…ä¾èµ–
	@echo "ğŸ”§ å®‰è£…é¡¹ç›®ä¾èµ–..."
	uv venv --python 3.13
	uv sync --extra dev --extra performance --extra monitoring
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

install-prod: ## å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–
	@echo "ğŸ”§ å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–..."
	uv venv --python 3.13
	uv sync --extra performance --extra monitoring
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒä¾èµ–å®‰è£…å®Œæˆ"

# å¼€å‘
dev: ## å¯åŠ¨å¼€å‘æœåŠ¡å™¨
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	./scripts/dev.sh

run-dev: ## å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	uv run laoke-server --host 0.0.0.0 --port 8080 --reload --log-level debug

run-prod: ## å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
	@echo "ğŸš€ å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨..."
	uv run laoke-server --host 0.0.0.0 --port 8080 --workers 4 --log-level info

# æµ‹è¯•
test: ## è¿è¡Œæ‰€æœ‰æµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	uv run pytest -v

test-unit: ## è¿è¡Œå•å…ƒæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	uv run pytest test/unit/ -v

test-integration: ## è¿è¡Œé›†æˆæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	uv run pytest test/integration/ -v

test-cov: ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
	uv run pytest --cov=laoke_service --cov-report=html --cov-report=term-missing

test-watch: ## ç›‘è§†æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
	@echo "ğŸ‘€ ç›‘è§†æµ‹è¯•..."
	uv run pytest-watch

# ä»£ç è´¨é‡
lint: ## è¿è¡Œä»£ç æ£€æŸ¥
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	uv run ruff check .
	uv run mypy .
	uv run bandit -r laoke_service/

format: ## æ ¼å¼åŒ–ä»£ç 
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	uv run black .
	uv run isort .
	uv run ruff check --fix .

format-check: ## æ£€æŸ¥ä»£ç æ ¼å¼
	@echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
	uv run black --check .
	uv run isort --check-only .

security: ## è¿è¡Œå®‰å…¨æ£€æŸ¥
	@echo "ğŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
	uv run bandit -r laoke_service/
	uv run safety check

# CLI å·¥å…·
cli-help: ## æ˜¾ç¤ºCLIå¸®åŠ©
	uv run laoke-cli --help

config-show: ## æ˜¾ç¤ºå½“å‰é…ç½®
	uv run laoke-cli config show

config-validate: ## éªŒè¯é…ç½®
	uv run laoke-cli config validate

agent-status: ## æ£€æŸ¥æ™ºèƒ½ä½“çŠ¶æ€
	uv run laoke-cli agent status

agent-test: ## æµ‹è¯•æ™ºèƒ½ä½“ï¼ˆéœ€è¦è®¾ç½®MESSAGEå˜é‡ï¼‰
	uv run laoke-cli agent test -m "$(MESSAGE)"

db-init: ## åˆå§‹åŒ–æ•°æ®åº“
	uv run laoke-cli db init

db-migrate: ## æ‰§è¡Œæ•°æ®åº“è¿ç§»
	uv run laoke-cli db migrate

db-status: ## æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
	uv run laoke-cli db status

# æ„å»ºå’Œéƒ¨ç½²
build: ## æ„å»ºé¡¹ç›®
	@echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
	uv build

docker-build: ## æ„å»ºDockeré•œåƒ
	@echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
	docker build -t laoke-service:latest .

docker-run: ## è¿è¡ŒDockerå®¹å™¨
	@echo "ğŸ³ è¿è¡ŒDockerå®¹å™¨..."
	docker run -p 8080:8080 -e ENVIRONMENT=development laoke-service:latest

docker-dev: ## è¿è¡Œå¼€å‘Dockerå®¹å™¨
	@echo "ğŸ³ è¿è¡Œå¼€å‘Dockerå®¹å™¨..."
	docker run -p 8080:8080 -v $(PWD):/app -e ENVIRONMENT=development laoke-service:latest

# æ¸…ç†
clean: ## æ¸…ç†ä¸´æ—¶æ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".mypy_cache" -exec rm -rf {} +
	find . -type d -name ".ruff_cache" -exec rm -rf {} +
	rm -rf build/
	rm -rf dist/
	rm -rf htmlcov/
	@echo "âœ… æ¸…ç†å®Œæˆ"

clean-all: clean ## æ¸…ç†æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬è™šæ‹Ÿç¯å¢ƒï¼‰
	@echo "ğŸ§¹ æ¸…ç†æ‰€æœ‰æ–‡ä»¶..."
	rm -rf .venv/
	rm -rf logs/
	@echo "âœ… å®Œå…¨æ¸…ç†å®Œæˆ"

# æ–‡æ¡£
docs: ## ç”Ÿæˆæ–‡æ¡£
	@echo "ğŸ“š ç”Ÿæˆæ–‡æ¡£..."
	uv run mkdocs build

docs-serve: ## å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨
	@echo "ğŸ“š å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨..."
	uv run mkdocs serve

# æ€§èƒ½åˆ†æ
profile: ## æ€§èƒ½åˆ†æ
	@echo "ğŸ“Š è¿è¡Œæ€§èƒ½åˆ†æ..."
	uv run py-spy record -o profile.svg -- python -m laoke_service.cmd.server.main

memory-profile: ## å†…å­˜åˆ†æ
	@echo "ğŸ“Š è¿è¡Œå†…å­˜åˆ†æ..."
	uv run memory-profiler laoke_service/cmd/server/main.py

# ç›‘æ§
logs: ## æŸ¥çœ‹æ—¥å¿—
	@echo "ğŸ“‹ æŸ¥çœ‹æ—¥å¿—..."
	tail -f logs/laoke-service.log

logs-error: ## æŸ¥çœ‹é”™è¯¯æ—¥å¿—
	@echo "ğŸ“‹ æŸ¥çœ‹é”™è¯¯æ—¥å¿—..."
	grep -i error logs/laoke-service.log | tail -20

metrics: ## æŸ¥çœ‹æŒ‡æ ‡
	@echo "ğŸ“Š è·å–æŒ‡æ ‡..."
	curl -s http://localhost:8080/metrics

health: ## å¥åº·æ£€æŸ¥
	@echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
	curl -s http://localhost:8080/health | jq .

# å¼€å‘å·¥å…·
pre-commit: ## è¿è¡Œé¢„æäº¤æ£€æŸ¥
	@echo "ğŸ” è¿è¡Œé¢„æäº¤æ£€æŸ¥..."
	$(MAKE) format
	$(MAKE) lint
	$(MAKE) test

commit: ## æäº¤ä»£ç ï¼ˆè¿è¡Œå®Œæ•´æ£€æŸ¥ï¼‰
	@echo "ğŸ“ å‡†å¤‡æäº¤ä»£ç ..."
	$(MAKE) pre-commit
	@echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥æäº¤"

setup-dev: ## è®¾ç½®å¼€å‘ç¯å¢ƒ
	@echo "ğŸ› ï¸ è®¾ç½®å¼€å‘ç¯å¢ƒ..."
	$(MAKE) install
	$(MAKE) config-validate
	@echo "âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

# ç¤ºä¾‹å‘½ä»¤
example-chat: ## ç¤ºä¾‹ï¼šæµ‹è¯•èŠå¤©åŠŸèƒ½
	uv run laoke-cli agent test -m "ä½ å¥½ï¼Œè€å…‹" -t general_chat

example-knowledge: ## ç¤ºä¾‹ï¼šæµ‹è¯•çŸ¥è¯†æŸ¥è¯¢
	uv run laoke-cli agent test -m "ä»€ä¹ˆæ˜¯é˜´é˜³å­¦è¯´" -t knowledge_query

example-learning: ## ç¤ºä¾‹ï¼šæµ‹è¯•å­¦ä¹ è®¡åˆ’
	uv run laoke-cli agent test -m "åˆ¶å®šä¸­åŒ»å…¥é—¨å­¦ä¹ è®¡åˆ’" -t learning_plan

# ç‰ˆæœ¬ä¿¡æ¯
version: ## æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
	uv run laoke-cli version

# å¿«é€Ÿå¼€å§‹
quick-start: ## å¿«é€Ÿå¼€å§‹ï¼ˆå®Œæ•´æµç¨‹ï¼‰
	@echo "ğŸš€ å¿«é€Ÿå¼€å§‹è€å…‹æ™ºèƒ½ä½“æœåŠ¡..."
	$(MAKE) setup-dev
	$(MAKE) dev 