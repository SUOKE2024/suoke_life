# Corn Maze Service 架构设计

本文档详细说明 Corn Maze Service 的架构设计，包括系统组件、通信流程和数据模型。

## 目录

- [系统概览](#系统概览)
- [架构设计原则](#架构设计原则)
- [系统组件](#系统组件)
- [通信流程](#通信流程)
- [数据模型](#数据模型)
- [扩展性设计](#扩展性设计)
- [安全性设计](#安全性设计)
- [性能考量](#性能考量)
- [未来规划](#未来规划)

## 系统概览

Corn Maze Service 是一个微服务组件，负责生成和管理基于中医理论的"健康迷宫"体验。该服务采用现代化微服务架构，使用 gRPC 进行通信，支持水平扩展和高可用性。

### 架构图

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  Client Apps    │────▶│  API Gateway    │────▶│  Corn Maze      │
│                 │     │                 │     │  Service        │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
                                              ┌─────────────────────┐
                                              │                     │
                                              │  MongoDB            │
                                              │                     │
                                              └─────────┬───────────┘
                                                        │
                                                        │
                              ┌─────────────────────────┼─────────────────────────┐
                              │                         │                         │
                              ▼                         ▼                         ▼
                    ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
                    │                 │      │                 │      │                 │
                    │  Maze Data      │      │  User Progress  │      │  Knowledge Base │
                    │                 │      │                 │      │                 │
                    └─────────────────┘      └─────────────────┘      └─────────────────┘
```

## 架构设计原则

Corn Maze Service 的架构设计遵循以下原则：

1. **微服务松耦合**: 服务功能内聚，接口明确，便于独立开发和部署
2. **可扩展性**: 支持水平扩展以应对流量增长
3. **弹性容错**: 通过适当的重试策略和熔断机制提高系统弹性
4. **可观测性**: 集成监控、日志和追踪，便于问题排查
5. **安全优先**: 采用安全最佳实践，保护用户数据
6. **领域驱动设计**: 基于中医养生领域概念构建系统模型

## 系统组件

### 1. 迷宫生成器 (Maze Generator)

负责生成迷宫结构和内容，是服务的核心组件。

**主要功能**:
- 使用算法生成随机迷宫结构
- 根据用户健康属性和偏好定制迷宫内容
- 在迷宫中放置知识节点和挑战

**技术实现**:
- 使用 NetworkX 图库实现迷宫生成算法
- 支持多种迷宫算法：递归分割、深度优先搜索、最小生成树等
- 通过参数调整控制迷宫复杂度

### 2. 用户进度管理器 (Progress Manager)

跟踪和管理用户在迷宫中的进度和状态。

**主要功能**:
- 记录用户当前位置
- 跟踪已访问单元格和已获取知识点
- 计算完成百分比和得分
- 处理用户迷宫移动请求

**技术实现**:
- 使用 MongoDB 存储用户进度数据
- 实现幂等操作以确保数据一致性
- 使用原子更新避免并发问题

### 3. 知识库 (Knowledge Repository)

管理迷宫中的中医养生知识内容。

**主要功能**:
- 存储和检索知识节点
- 根据用户特征选择合适的知识内容
- 管理知识内容的分类和标签

**技术实现**:
- 使用 MongoDB 存储结构化知识数据
- 实现基于标签和类别的知识检索
- 支持全文搜索功能

### 4. gRPC 服务层 (gRPC Service Layer)

提供 gRPC 接口，处理客户端请求。

**主要功能**:
- 接收和验证客户端请求
- 协调内部组件处理请求
- 返回响应数据

**技术实现**:
- 使用 gRPC 框架实现服务接口
- 实现服务端拦截器进行请求验证和日志记录
- 集成指标监控

### 5. 监控和指标 (Monitoring & Metrics)

收集和暴露服务运行时的指标数据。

**主要功能**:
- 收集服务性能指标
- 监控服务健康状况
- 为排障和优化提供数据支持

**技术实现**:
- 集成 Prometheus 进行指标收集
- 使用 Grafana 可视化指标数据
- 实现健康检查端点

## 通信流程

### 1. 创建迷宫流程

```
Client                 API Gateway             Corn Maze Service         MongoDB
  │                        │                           │                    │
  │   Create Maze          │                           │                    │
  │───────────────────────▶│                           │                    │
  │                        │   CreateMazeRequest       │                    │
  │                        │──────────────────────────▶│                    │
  │                        │                           │  Generate Maze     │
  │                        │                           │────────────────────│
  │                        │                           │                    │
  │                        │                           │  Save Maze         │
  │                        │                           │────────────────────▶
  │                        │                           │                    │
  │                        │                           │  Initialize User   │
  │                        │                           │  Progress          │
  │                        │                           │────────────────────▶
  │                        │                           │                    │
  │                        │   MazeResponse            │                    │
  │                        │◀──────────────────────────│                    │
  │   Maze Data            │                           │                    │
  │◀───────────────────────│                           │                    │
  │                        │                           │                    │
```

### 2. 迷宫移动流程

```
Client                 API Gateway             Corn Maze Service         MongoDB
  │                        │                           │                    │
  │   Move Request         │                           │                    │
  │───────────────────────▶│                           │                    │
  │                        │   MoveRequest             │                    │
  │                        │──────────────────────────▶│                    │
  │                        │                           │  Validate Move     │
  │                        │                           │───────────────────┐│
  │                        │                           │                   ││
  │                        │                           │◀──────────────────┘│
  │                        │                           │                    │
  │                        │                           │  Update Position   │
  │                        │                           │────────────────────▶
  │                        │                           │                    │
  │                        │                           │  Check Events      │
  │                        │                           │───────────────────┐│
  │                        │                           │                   ││
  │                        │                           │◀──────────────────┘│
  │                        │                           │                    │
  │                        │   MoveResponse            │                    │
  │                        │◀──────────────────────────│                    │
  │   Move Result          │                           │                    │
  │◀───────────────────────│                           │                    │
  │                        │                           │                    │
```

## 数据模型

### 1. 迷宫模型 (Maze)

```javascript
{
  "maze_id": "m12345",
  "user_id": "u67890",
  "maze_type": "四季养生",
  "size_x": 10,
  "size_y": 10,
  "cells": [
    {
      "x": 0,
      "y": 0,
      "type": "START",
      "north_wall": true,
      "east_wall": false,
      "south_wall": true,
      "west_wall": true,
      "cell_id": "0,0"
    },
    // 更多单元格...
  ],
  "start_position": {"x": 0, "y": 0},
  "goal_position": {"x": 9, "y": 9},
  "knowledge_nodes": [
    {
      "node_id": "k123",
      "title": "春季养肝",
      "content": "春季养生重在养肝...",
      "category": "四季养生",
      "difficulty_level": "2",
      "related_tags": ["春季", "养肝"]
    },
    // 更多知识节点...
  ],
  "challenges": [
    {
      "challenge_id": "c456",
      "title": "养肝食物配对",
      "description": "选择适合春季养肝的食物",
      "type": "选择题",
      "difficulty_level": "2",
      "reward_description": "获得养生积分"
    },
    // 更多挑战...
  ],
  "created_at": "2023-04-15T08:30:00Z",
  "difficulty": 2,
  "status": "可用",
  "is_public": false,
  "description": "春季养生迷宫",
  "tags": ["春季", "养肝", "初级"]
}
```

### 2. 用户进度模型 (UserProgress)

```javascript
{
  "user_id": "u67890",
  "maze_id": "m12345",
  "current_position": {"x": 3, "y": 2},
  "visited_cells": ["0,0", "1,0", "2,0", "3,0", "3,1", "3,2"],
  "completed_challenges": ["c456"],
  "acquired_knowledge": ["k123"],
  "completion_percentage": 35,
  "status": "进行中",
  "steps_taken": 12,
  "start_time": "2023-04-15T10:15:30Z",
  "last_active_time": "2023-04-15T10:25:45Z",
  "score": 150
}
```

### 3. 知识节点模型 (KnowledgeNode)

```javascript
{
  "node_id": "k123",
  "title": "春季养肝",
  "content": "春季养生重在养肝。肝在五行属木，与春季相应。春季肝气升发，应注意以下几点：\n1. 饮食宜温补，忌生冷\n2. 情绪调节，保持舒畅\n3. 适当运动，促进气血循环",
  "category": "四季养生",
  "difficulty_level": "2",
  "related_tags": ["春季", "养肝", "饮食", "情绪"],
  "created_at": "2023-01-10T11:30:00Z",
  "updated_at": "2023-03-05T14:20:00Z",
  "source": "中医养生宝典",
  "author": "张三",
  "media_url": "https://example.com/images/spring_liver.jpg"
}
```

### 4. 迷宫模板模型 (MazeTemplate)

```javascript
{
  "template_id": "t789",
  "name": "春季养生迷宫模板",
  "description": "适合初学者的春季养生迷宫",
  "maze_type": "四季养生",
  "difficulty": 2,
  "size_x": 10,
  "size_y": 10,
  "cells": [
    // 预设的单元格结构...
  ],
  "start_position": {"x": 0, "y": 0},
  "goal_position": {"x": 9, "y": 9},
  "knowledge_node_count": 5,
  "challenge_count": 3,
  "tags": ["春季", "养生", "初级"],
  "preview_image_url": "https://example.com/templates/spring_maze.png",
  "created_at": "2023-01-15T09:00:00Z",
  "created_by": "system",
  "is_active": true
}
```

## 扩展性设计

Corn Maze Service 的扩展性体现在以下几个方面：

### 1. 水平扩展

- 服务实例无状态，可以部署多个实例
- 使用负载均衡分发请求
- MongoDB 副本集支持读写分离

### 2. 功能扩展

- 插件化设计，便于添加新的迷宫生成算法
- 知识库支持动态扩展内容
- 配置驱动的挑战类型系统

### 3. 集成扩展

- 标准化的 gRPC 接口便于与其他服务集成
- 事件驱动设计支持未来添加事件通知
- 支持与用户成就系统集成

## 安全性设计

### 1. 认证和授权

- 使用 API Gateway 进行请求认证
- 基于用户 ID 的资源访问控制
- 敏感操作的权限验证

### 2. 数据安全

- 敏感数据加密存储
- 通信加密 (TLS/SSL)
- 输入验证和防注入措施

### 3. 审计和日志

- 关键操作审计日志
- 异常操作记录
- 合规性支持

## 性能考量

### 1. 缓存策略

- Redis 缓存热门迷宫模板
- 内存缓存频繁访问的知识节点
- 用户进度缓存减少数据库负载

### 2. 查询优化

- MongoDB 索引优化
- 批量操作减少数据库往返
- 投影查询只获取必要字段

### 3. 资源管理

- 连接池管理数据库连接
- 服务资源限制防止过载
- 异步处理长时间运行的任务

## 未来规划

### 1. 近期计划

- 添加更多迷宫生成算法
- 集成机器学习个性化迷宫内容推荐
- 增强多语言支持

### 2. 中期计划

- 实现多人协作迷宫模式
- 添加迷宫编辑器功能
- 集成实时语音指导

### 3. 长期愿景

- 基于AR/VR的迷宫体验
- 自适应学习路径
- 开放API生态系统 