# ç´¢å…‹ç”Ÿæ´» API ç½‘å…³ - ç›‘æ§å‘Šè­¦è§„åˆ™
# Monitoring and Alerting Rules for Suoke Life API Gateway

groups:
  # æœåŠ¡å¯ç”¨æ€§å‘Šè­¦
  - name: suoke-api-gateway-availability
    rules:
      - alert: APIGatewayDown
        expr: up{job="suoke-api-gateway"} == 0
        for: 1m
        labels:
          severity: critical
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³æœåŠ¡ä¸å¯ç”¨"
          description: "APIç½‘å…³å®ä¾‹ {{ $labels.instance }} å·²ç»ä¸‹çº¿è¶…è¿‡1åˆ†é’Ÿ"
          runbook_url: "https://docs.suoke.life/runbooks/api-gateway-down"
          
      - alert: APIGatewayHighErrorRate
        expr: rate(http_requests_total{job="suoke-api-gateway",status=~"5.."}[5m]) / rate(http_requests_total{job="suoke-api-gateway"}[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³é”™è¯¯ç‡è¿‡é«˜"
          description: "APIç½‘å…³é”™è¯¯ç‡ä¸º {{ $value | humanizePercentage }}ï¼Œè¶…è¿‡5%é˜ˆå€¼"
          runbook_url: "https://docs.suoke.life/runbooks/high-error-rate"
          
      - alert: APIGatewayHighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="suoke-api-gateway"}[5m])) > 2
        for: 3m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³å“åº”å»¶è¿Ÿè¿‡é«˜"
          description: "APIç½‘å…³95%åˆ†ä½å»¶è¿Ÿä¸º {{ $value }}sï¼Œè¶…è¿‡2sé˜ˆå€¼"
          runbook_url: "https://docs.suoke.life/runbooks/high-latency"

  # èµ„æºä½¿ç”¨å‘Šè­¦
  - name: suoke-api-gateway-resources
    rules:
      - alert: APIGatewayHighCPU
        expr: rate(process_cpu_seconds_total{job="suoke-api-gateway"}[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³CPUä½¿ç”¨ç‡è¿‡é«˜"
          description: "APIç½‘å…³å®ä¾‹ {{ $labels.instance }} CPUä½¿ç”¨ç‡ä¸º {{ $value }}%"
          runbook_url: "https://docs.suoke.life/runbooks/high-cpu"
          
      - alert: APIGatewayHighMemory
        expr: process_resident_memory_bytes{job="suoke-api-gateway"} / 1024 / 1024 / 1024 > 1.5
        for: 5m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³å†…å­˜ä½¿ç”¨è¿‡é«˜"
          description: "APIç½‘å…³å®ä¾‹ {{ $labels.instance }} å†…å­˜ä½¿ç”¨ä¸º {{ $value }}GB"
          runbook_url: "https://docs.suoke.life/runbooks/high-memory"
          
      - alert: APIGatewayDiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 5m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³ç£ç›˜ç©ºé—´ä¸è¶³"
          description: "APIç½‘å…³å®ä¾‹ {{ $labels.instance }} ç£ç›˜å‰©ä½™ç©ºé—´ä¸º {{ $value }}%"
          runbook_url: "https://docs.suoke.life/runbooks/low-disk-space"

  # è¿æ¥å’Œç½‘ç»œå‘Šè­¦
  - name: suoke-api-gateway-network
    rules:
      - alert: APIGatewayHighConnectionCount
        expr: sum(rate(http_requests_total{job="suoke-api-gateway"}[1m])) > 1000
        for: 2m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³è¿æ¥æ•°è¿‡é«˜"
          description: "APIç½‘å…³æ¯åˆ†é’Ÿè¯·æ±‚æ•°ä¸º {{ $value }}ï¼Œè¶…è¿‡1000é˜ˆå€¼"
          runbook_url: "https://docs.suoke.life/runbooks/high-connections"
          
      - alert: APIGatewayRateLimitTriggered
        expr: rate(rate_limit_exceeded_total{job="suoke-api-gateway"}[5m]) > 10
        for: 1m
        labels:
          severity: info
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³é™æµè§¦å‘"
          description: "APIç½‘å…³é™æµæ¯5åˆ†é’Ÿè§¦å‘ {{ $value }} æ¬¡"
          runbook_url: "https://docs.suoke.life/runbooks/rate-limit-triggered"
          
      - alert: APIGatewayCircuitBreakerOpen
        expr: circuit_breaker_state{job="suoke-api-gateway"} == 1
        for: 0m
        labels:
          severity: critical
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³ç†”æ–­å™¨å¼€å¯"
          description: "APIç½‘å…³æœåŠ¡ {{ $labels.service_name }} çš„ç†”æ–­å™¨å·²å¼€å¯"
          runbook_url: "https://docs.suoke.life/runbooks/circuit-breaker-open"

  # ç¼“å­˜å’Œå­˜å‚¨å‘Šè­¦
  - name: suoke-api-gateway-cache
    rules:
      - alert: APIGatewayCacheHitRateLow
        expr: rate(cache_hits_total{job="suoke-api-gateway"}[5m]) / (rate(cache_hits_total{job="suoke-api-gateway"}[5m]) + rate(cache_misses_total{job="suoke-api-gateway"}[5m])) < 0.7
        for: 5m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "APIç½‘å…³ç¼“å­˜å‘½ä¸­ç‡ä¸º {{ $value | humanizePercentage }}ï¼Œä½äº70%"
          runbook_url: "https://docs.suoke.life/runbooks/low-cache-hit-rate"
          
      - alert: APIGatewayRedisConnectionFailed
        expr: redis_connected_clients{job="suoke-api-gateway"} == 0
        for: 1m
        labels:
          severity: critical
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³Redisè¿æ¥å¤±è´¥"
          description: "APIç½‘å…³æ— æ³•è¿æ¥åˆ°RedisæœåŠ¡å™¨"
          runbook_url: "https://docs.suoke.life/runbooks/redis-connection-failed"

  # å®‰å…¨å‘Šè­¦
  - name: suoke-api-gateway-security
    rules:
      - alert: APIGatewayHighFailedAuthRate
        expr: rate(auth_failures_total{job="suoke-api-gateway"}[5m]) > 10
        for: 2m
        labels:
          severity: warning
          service: api-gateway
          team: security
        annotations:
          summary: "APIç½‘å…³è®¤è¯å¤±è´¥ç‡è¿‡é«˜"
          description: "APIç½‘å…³æ¯5åˆ†é’Ÿè®¤è¯å¤±è´¥ {{ $value }} æ¬¡ï¼Œå¯èƒ½å­˜åœ¨æš´åŠ›ç ´è§£æ”»å‡»"
          runbook_url: "https://docs.suoke.life/runbooks/high-auth-failures"
          
      - alert: APIGatewaySuspiciousActivity
        expr: rate(suspicious_requests_total{job="suoke-api-gateway"}[5m]) > 5
        for: 1m
        labels:
          severity: critical
          service: api-gateway
          team: security
        annotations:
          summary: "APIç½‘å…³æ£€æµ‹åˆ°å¯ç–‘æ´»åŠ¨"
          description: "APIç½‘å…³æ¯5åˆ†é’Ÿæ£€æµ‹åˆ° {{ $value }} æ¬¡å¯ç–‘è¯·æ±‚"
          runbook_url: "https://docs.suoke.life/runbooks/suspicious-activity"
          
      - alert: APIGatewaySecurityViolation
        expr: increase(security_violations_total{job="suoke-api-gateway"}[1m]) > 0
        for: 0m
        labels:
          severity: critical
          service: api-gateway
          team: security
        annotations:
          summary: "APIç½‘å…³å®‰å…¨è¿è§„"
          description: "APIç½‘å…³æ£€æµ‹åˆ°å®‰å…¨è¿è§„äº‹ä»¶"
          runbook_url: "https://docs.suoke.life/runbooks/security-violation"

  # ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
  - name: suoke-api-gateway-business
    rules:
      - alert: APIGatewayLowThroughput
        expr: rate(http_requests_total{job="suoke-api-gateway"}[5m]) < 10
        for: 10m
        labels:
          severity: info
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³ååé‡è¿‡ä½"
          description: "APIç½‘å…³æ¯5åˆ†é’Ÿå¤„ç†è¯·æ±‚æ•°ä¸º {{ $value }}ï¼Œä½äºæ­£å¸¸æ°´å¹³"
          runbook_url: "https://docs.suoke.life/runbooks/low-throughput"
          
      - alert: APIGatewayServiceUnavailable
        expr: probe_success{job="suoke-api-gateway-probe"} == 0
        for: 1m
        labels:
          severity: critical
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³æœåŠ¡æ¢æµ‹å¤±è´¥"
          description: "APIç½‘å…³å¥åº·æ£€æŸ¥æ¢æµ‹å¤±è´¥"
          runbook_url: "https://docs.suoke.life/runbooks/service-unavailable"

  # ä¾èµ–æœåŠ¡å‘Šè­¦
  - name: suoke-api-gateway-dependencies
    rules:
      - alert: APIGatewayUpstreamServiceDown
        expr: up{job=~"user-service|auth-service|diagnostic-service"} == 0
        for: 2m
        labels:
          severity: critical
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³ä¸Šæ¸¸æœåŠ¡ä¸å¯ç”¨"
          description: "ä¸Šæ¸¸æœåŠ¡ {{ $labels.job }} ä¸å¯ç”¨ï¼Œå¯èƒ½å½±å“APIç½‘å…³åŠŸèƒ½"
          runbook_url: "https://docs.suoke.life/runbooks/upstream-service-down"
          
      - alert: APIGatewayUpstreamHighLatency
        expr: histogram_quantile(0.95, rate(upstream_request_duration_seconds_bucket{job="suoke-api-gateway"}[5m])) > 5
        for: 3m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³ä¸Šæ¸¸æœåŠ¡å»¶è¿Ÿè¿‡é«˜"
          description: "ä¸Šæ¸¸æœåŠ¡ {{ $labels.upstream_service }} 95%åˆ†ä½å»¶è¿Ÿä¸º {{ $value }}s"
          runbook_url: "https://docs.suoke.life/runbooks/upstream-high-latency"

  # Kubernetesç›¸å…³å‘Šè­¦
  - name: suoke-api-gateway-kubernetes
    rules:
      - alert: APIGatewayPodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total{container="api-gateway"}[15m]) > 0
        for: 5m
        labels:
          severity: critical
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³Podé‡å¯å¾ªç¯"
          description: "APIç½‘å…³Pod {{ $labels.pod }} åœ¨è¿‡å»15åˆ†é’Ÿå†…é‡å¯äº† {{ $value }} æ¬¡"
          runbook_url: "https://docs.suoke.life/runbooks/pod-crash-looping"
          
      - alert: APIGatewayPodNotReady
        expr: kube_pod_status_ready{condition="false", pod=~"suoke-api-gateway-.*"} == 1
        for: 5m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³Podæœªå°±ç»ª"
          description: "APIç½‘å…³Pod {{ $labels.pod }} æœªå°±ç»ªè¶…è¿‡5åˆ†é’Ÿ"
          runbook_url: "https://docs.suoke.life/runbooks/pod-not-ready"
          
      - alert: APIGatewayHPAScalingIssue
        expr: kube_hpa_status_current_replicas{hpa="suoke-api-gateway-hpa"} != kube_hpa_status_desired_replicas{hpa="suoke-api-gateway-hpa"}
        for: 10m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³HPAæ‰©ç¼©å®¹å¼‚å¸¸"
          description: "APIç½‘å…³HPAå½“å‰å‰¯æœ¬æ•° {{ $labels.current_replicas }} ä¸æœŸæœ›å‰¯æœ¬æ•° {{ $labels.desired_replicas }} ä¸åŒ¹é…"
          runbook_url: "https://docs.suoke.life/runbooks/hpa-scaling-issue"

  # æ—¥å¿—å‘Šè­¦
  - name: suoke-api-gateway-logs
    rules:
      - alert: APIGatewayHighErrorLogRate
        expr: rate(log_entries_total{job="suoke-api-gateway",level="error"}[5m]) > 5
        for: 2m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³é”™è¯¯æ—¥å¿—è¿‡å¤š"
          description: "APIç½‘å…³æ¯5åˆ†é’Ÿäº§ç”Ÿ {{ $value }} æ¡é”™è¯¯æ—¥å¿—"
          runbook_url: "https://docs.suoke.life/runbooks/high-error-logs"
          
      - alert: APIGatewayLogVolumeHigh
        expr: rate(log_entries_total{job="suoke-api-gateway"}[5m]) > 100
        for: 5m
        labels:
          severity: info
          service: api-gateway
          team: platform
        annotations:
          summary: "APIç½‘å…³æ—¥å¿—é‡è¿‡å¤§"
          description: "APIç½‘å…³æ¯5åˆ†é’Ÿäº§ç”Ÿ {{ $value }} æ¡æ—¥å¿—ï¼Œå¯èƒ½å½±å“å­˜å‚¨"
          runbook_url: "https://docs.suoke.life/runbooks/high-log-volume"

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 30m
    - match:
        team: security
      receiver: 'security-alerts'
      group_wait: 0s
      repeat_interval: 5m

# å‘Šè­¦æ¥æ”¶å™¨é…ç½®
receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://alertmanager-webhook:9093/webhook'
        
  - name: 'critical-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-critical'
        title: 'ğŸš¨ Critical Alert - {{ .GroupLabels.service }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'
    email_configs:
      - to: 'oncall@suoke.life'
        subject: 'ğŸš¨ Critical Alert - {{ .GroupLabels.service }}'
        body: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'
        
  - name: 'warning-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-warning'
        title: 'âš ï¸ Warning Alert - {{ .GroupLabels.service }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'
        
  - name: 'security-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#security-alerts'
        title: 'ğŸ”’ Security Alert - {{ .GroupLabels.service }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'
    email_configs:
      - to: 'security@suoke.life'
        subject: 'ğŸ”’ Security Alert - {{ .GroupLabels.service }}'
        body: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'instance'] 