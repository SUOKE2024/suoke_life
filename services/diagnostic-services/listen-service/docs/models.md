# 闻诊服务模型文档

本文档详细介绍闻诊服务(Listen Service)使用的各种机器学习模型，包括模型架构、训练方法、特征说明及与中医理论的关联。

## 模型概览

闻诊服务使用以下主要模型：

1. **语音特征分析模型** (voice_feature_analyzer)
   - 功能：分析语音特征，提取中医相关特性
   - 输入：人声音频
   - 输出：语速、音调、音量、气息特征等

2. **声音分析模型** (sound_feature_analyzer)
   - 功能：分析非语言声音(咳嗽、呼吸等)特征
   - 输入：各类非语言声音音频
   - 输出：声音类型、持续时间、振幅、规律性等特征

3. **情绪分析模型** (emotion_detector)
   - 功能：从语音中分析情绪状态
   - 输入：人声音频
   - 输出：情绪类型及强度、中医五志相关度

4. **方言识别模型** (dialect_identifier)
   - 功能：识别用户使用的方言类型及地区
   - 输入：人声音频
   - 输出：方言类型、方言地区、置信度

5. **语音转写模型** (whisper_medium)
   - 功能：将语音转换为文本
   - 输入：人声音频
   - 输出：文本内容、分段时间戳

## 语音特征分析模型

### 模型架构

语音特征分析模型采用多层感知机(MLP)结构，由以下组件构成：

- 输入层：对应提取的语音特征向量(维度约100-200)
- 隐藏层：2-3个全连接层，每层后接BatchNorm和ReLU激活
- 输出层：根据任务不同，可以是回归或分类输出

### 特征提取

从音频中提取的主要特征包括：

1. **基础声学特征**
   - 基频(F0)：平均值、标准差、最大/最小值、范围
   - 音量/能量：平均值、标准差、峰值
   - 语速：音节/秒，停顿频率与持续时间

2. **频谱特征**
   - 梅尔频率倒谱系数(MFCC)：13-39维
   - 谐波噪声比(HNR)：反映声音清晰度
   - 声门特征：抖动(Jitter)和闪烁(Shimmer)

3. **声音质量特征**
   - 气息特征(Breathiness)：气声比例
   - 声音稳定性：音高和音量的变化率
   - 音色特征：谐波结构、共振峰分布

### 与中医理论关联

模型将提取的声学特征与以下中医理论概念关联：

| 声学特征 | 中医关联 | 含义 |
|---------|---------|------|
| 音量大小与稳定 | 气虚/气实 | 音量小而不稳定可能表示气虚；音量大而有力表示气实 |
| 音色清浊 | 痰湿/阴阳 | 声音浑浊可能表示痰湿；清亮表示阴阳平衡 |
| 语速快慢 | 热证/寒证 | 语速快可能表示热证；语速慢表示寒证 |
| 气息特征 | 肺/肾功能 | 气息不足可能表示肺肾虚弱；气息充足表示肺肾功能正常 |
| 声音颤抖 | 肝/心功能 | 声音颤抖可能表示肝风内动或心悸 |

### 训练方法

模型训练采用以下流程：

1. **数据准备**
   - 收集带标注的语音样本(每类1000+样本)
   - 按中医证型标注样本(例如：气虚、阴虚、阳虚等)

2. **特征工程**
   - 使用librosa和parselmouth库提取声学特征
   - 进行特征归一化和选择

3. **模型训练**
   - 使用PyTorch框架训练MLP模型
   - 采用交叉验证确保模型泛化能力
   - 使用早停法防止过拟合

4. **模型评估**
   - 使用精确率、召回率、F1分数和混淆矩阵评估
   - 与专业中医医师进行对比评估

### 使用方法

通过以下命令训练模型：

```bash
python scripts/model_training/train_voice_model.py \
    --data_dir /path/to/dataset \
    --config config/model_training/voice_model.yaml \
    --output_dir models/voice_feature_analyzer \
    --epochs 50 \
    --batch_size 32 \
    --learning_rate 0.001
```

## 声音分析模型

### 模型架构

声音分析模型采用卷积神经网络(CNN)和长短期记忆网络(LSTM)的混合结构：

- CNN部分：提取音频的局部时频特征
- LSTM部分：捕捉声音的时序模式
- 注意力机制：关注重要的时间和频率区域

### 特征提取

针对非语言声音(如咳嗽、呼吸等)，提取以下特征：

1. **时域特征**
   - 包络特征：振幅包络、能量轮廓
   - 时长特征：声音持续时间、起始/结束特性
   - 节奏特征：周期性、重复模式

2. **频域特征**
   - 频谱特征：频谱质心、频谱带宽、频谱倾斜度
   - 谐波特征：谐波-噪声比、奇偶谐波比率
   - 梅尔谱图：时频表示

3. **声学事件特征**
   - 起始/冲击特征：声音起始特性
   - 纹理特征：声音粗糙度、湿润度

### 与中医理论关联

| 声音特征 | 中医关联 | 含义 |
|---------|---------|------|
| 咳嗽声调高低 | 寒/热 | 声调高亢清脆表示热证；声调低沉浊重表示寒证 |
| 咳嗽声音有痰声 | 痰湿 | 痰声明显表示痰湿内盛 |
| 咳嗽声音强度 | 虚/实 | 声音低弱无力表示虚证；声音洪亮有力表示实证 |
| 呼吸声音节律 | 气机顺逆 | 节律不齐表示气机紊乱；均匀表示气机调和 |
| 呼吸深浅 | 肺/肾功能 | 呼吸浅短表示肺肾不足；呼吸深长有力表示肺肾功能佳 |

### 训练方法

类似于语音分析模型，但针对不同类型的声音使用专门的数据集和特征提取方法。

## 情绪分析模型

### 模型架构

情绪分析模型结合了声学特征和语义特征，采用双流架构：

- 声学流：处理语音的声学特征(音高、音量、音色等)
- 语义流：处理转写后的文本内容(如有)
- 融合层：结合两种特征进行最终预测

### 情绪类别

模型识别的情绪包括：

1. **基础情绪**
   - 快乐、悲伤、愤怒、恐惧、厌恶、惊讶、中性

2. **中医五志**
   - 喜（心）：兴奋、愉悦感
   - 怒（肝）：愤怒、暴躁、烦闷
   - 忧（肺）：忧愁、悲伤
   - 思（脾）：思虑、担忧、焦虑
   - 恐（肾）：恐惧、惊慌

### 与中医理论关联

情绪分析在中医理论中具有重要意义，中医认为情志过极会导致相应脏腑功能失调：

| 情绪 | 对应脏腑 | 过极影响 | 声音特征 |
|------|----------|---------|---------|
| 喜 | 心 | 心气散 | 语调高昂、节奏轻快 |
| 怒 | 肝 | 肝气上逆 | 音量增大、语速加快、音调升高 |
| 忧 | 肺 | 肺气郁 | 声音低沉、叹气多 |
| 思 | 脾 | 气机不畅 | 语速减慢、停顿增多 |
| 恐 | 肾 | 肾气下陷 | 声音颤抖、语调不稳 |

## 模型部署与服务

### 模型量化与优化

为了在生产环境高效运行，对模型进行以下优化：

1. **量化压缩**
   - 使用FP16或INT8量化减少模型大小和推理时间
   - 使用ONNX格式提高跨平台兼容性

2. **批处理优化**
   - 支持批量推理提高吞吐量
   - 实现动态批处理大小

3. **缓存机制**
   - 特征提取结果缓存
   - 频繁请求的预测结果缓存

### 模型更新机制

服务支持以下模型更新方式：

1. **在线更新**
   - 热加载新模型而不中断服务
   - 灰度发布新模型(部分流量使用新模型)

2. **持续学习**
   - 收集用户反馈进行模型改进
   - 定期使用新数据重训练模型

## 评估指标

模型性能使用以下指标评估：

1. **准确率指标**
   - 分类任务：准确率、精确率、召回率、F1分数
   - 回归任务：MAE、MSE、R²

2. **效率指标**
   - 推理时间
   - GPU/CPU内存占用
   - 吞吐量(每秒请求数)

3. **中医专业评估**
   - 与专业中医医师的一致性评分
   - 特征-证型关联的合理性评估

## 数据伦理与隐私

模型训练和使用过程中采取以下措施保护用户隐私：

1. **数据匿名化**
   - 去除个人身份信息
   - 使用ID替代实际身份

2. **同态加密**
   - 在特定场景下使用同态加密进行特征处理

3. **本地处理**
   - 在用户端设备进行初步特征提取
   - 只传输必要的特征而非原始音频

## 未来改进方向

1. **多模态融合**
   - 结合视觉数据进行更全面的诊断
   - 整合其他传感器数据(如呼吸频率、心率等)

2. **个性化模型**
   - 针对用户历史数据进行模型调整
   - 考虑用户的基础体质和健康状况

3. **可解释性增强**
   - 提供特征重要性分析
   - 使用注意力可视化展示关键特征 