# 🧮 算诊服务 API 文档

## 📋 **服务概览**

算诊服务是索克生活平台中医五诊体系的核心创新组件，实现了传统中医"算诊"的数字化。通过子午流注、八字体质、五运六气、八卦配属等算法，提供个性化的健康分析和调理建议。

**服务地址**: `http://localhost:8005`  
**API版本**: `v1`  
**文档地址**: `/docs` (Swagger UI)

---

## 🚀 **核心功能**

### **1. 子午流注分析**
- 十二经络时间医学分析
- 最佳治疗时间推荐
- 穴位开合时间计算

### **2. 八字体质分析**
- 基于出生时间的体质判断
- 五行属性分析
- 个性化调理方案

### **3. 五运六气分析**
- 运气学说健康预测
- 气候影响评估
- 疾病防治建议

### **4. 八卦配属分析**
- 易学健康关系分析
- 本命卦计算
- 吉凶判断指导

---

## 📡 **API 接口**

### **基础接口**

#### **GET /** - 服务信息
获取算诊服务的基本信息和功能介绍。

**响应示例**:
```json
{
  "service": "calculation-service",
  "name": "索克生活 - 算诊服务",
  "version": "1.0.0",
  "description": "中医五诊中的算诊功能微服务",
  "status": "running",
  "features": [
    "子午流注分析",
    "八字体质分析", 
    "八卦配属分析",
    "五运六气分析",
    "综合算诊"
  ],
  "innovation": [
    "传统中医智慧数字化",
    "个性化健康分析",
    "时间医学指导",
    "预防保健建议"
  ],
  "docs": "/docs",
  "health": "/api/v1/calculation/health"
}
```

#### **GET /ping** - 健康检查
简单的服务状态检查接口。

**响应示例**:
```json
{
  "status": "ok",
  "message": "pong",
  "timestamp": "2024-01-15T10:00:00Z"
}
```

---

### **算诊核心接口**

#### **POST /api/v1/calculation/comprehensive** - 综合算诊
执行完整的综合算诊分析，整合所有算诊方法。

**请求参数**:
```json
{
  "birth_datetime": "1990-01-01T08:00:00",
  "current_datetime": "2024-01-15T14:30:00",
  "gender": "male",
  "location": [116.4074, 39.9042],
  "symptoms": ["疲劳", "失眠", "食欲不振"]
}
```

**参数说明**:
- `birth_datetime`: 出生时间 (ISO 8601格式)
- `current_datetime`: 当前时间 (可选，默认为服务器当前时间)
- `gender`: 性别 ("male" 或 "female")
- `location`: 地理位置 [经度, 纬度] (可选)
- `symptoms`: 当前症状列表 (可选)

**响应示例**:
```json
{
  "success": true,
  "data": {
    "基本信息": {
      "出生时间": "1990年01月01日 08时00分",
      "当前时间": "2024年01月15日 14时30分",
      "性别": "男",
      "当前症状": ["疲劳", "失眠", "食欲不振"]
    },
    "五运六气分析": {
      "当前运气": "甲子年 丙寅月",
      "主运": "土运太过",
      "客运": "金运不及",
      "易发疾病": ["脾胃疾病", "肺系疾病"],
      "防治建议": ["健脾益气", "润肺养阴"]
    },
    "子午流注分析": {
      "当前时辰": "未时",
      "当前经络": "小肠经",
      "气血状态": "旺盛",
      "最佳治疗": "心系疾病、消化不良",
      "治疗建议": "此时治疗心脏和小肠相关疾病效果最佳"
    },
    "八字体质分析": {
      "体质类型": "阳虚质",
      "五行属性": "水木偏弱，火土偏旺",
      "体质特征": ["畏寒怕冷", "精神不振", "大便溏薄"],
      "易患疾病": ["脾胃虚寒", "肾阳不足", "心阳虚弱"],
      "调理原则": "温阳散寒，健脾益肾"
    },
    "八卦配属分析": {
      "本命卦": {
        "卦名": "坎卦",
        "属性": "水",
        "特征": "智慧、流动、适应性强"
      },
      "当前卦": {
        "卦名": "艮卦", 
        "属性": "土",
        "影响": "稳定、内敛、需要休养"
      },
      "健康预测": {
        "风险等级": "中",
        "易发疾病": ["肾系疾病", "水液代谢异常"],
        "调理建议": ["注意保暖", "避免过度劳累"]
      }
    },
    "综合诊断": {
      "健康风险评估": {
        "风险等级": "中",
        "风险因素": [
          "体质易患：脾胃虚寒、肾阳不足",
          "八卦预测：肾系疾病",
          "当前症状：疲劳、失眠、食欲不振"
        ],
        "风险评分": 75
      },
      "综合治疗建议": {
        "治疗原则": ["温阳散寒", "健脾益肾", "安神定志"],
        "最佳治疗时间": "卯时(5-7点)、辰时(7-9点)",
        "治疗方法": ["温针灸", "中药调理", "食疗养生"],
        "疗程建议": "连续调理3个月，每周2-3次"
      },
      "时间医学指导": {
        "今日最佳": "未时(13-15点) - 小肠经旺盛，适合调理消化",
        "明日推荐": "卯时(5-7点) - 大肠经旺盛，适合排毒调理",
        "本周重点": "每日辰时(7-9点)进行脾胃调理"
      },
      "个性化养生方案": {
        "饮食调理": {
          "宜食": ["羊肉", "韭菜", "生姜", "桂圆", "红枣"],
          "忌食": ["冷饮", "生冷瓜果", "苦寒药物"],
          "食疗方": "当归生姜羊肉汤、桂圆红枣粥"
        },
        "运动建议": [
          "太极拳 - 每日晨练30分钟",
          "八段锦 - 每日午后练习",
          "散步 - 每日晚饭后30分钟"
        ],
        "情志调节": [
          "保持心情愉悦，避免忧思过度",
          "适当社交，避免孤独抑郁",
          "规律作息，早睡早起"
        ]
      },
      "预防保健建议": {
        "定期检查": [
          "每季度检查脾胃功能",
          "每半年检查肾功能",
          "每年进行全面体检"
        ],
        "生活方式": [
          "保持规律作息，避免熬夜",
          "注意保暖，特别是腰腹部",
          "适度运动，避免过度劳累"
        ],
        "预防重点": [
          "预防脾胃虚寒 - 饮食温热，避免生冷",
          "预防肾阳虚 - 适当进补，避免房劳过度",
          "预防心阳虚 - 保持心情愉悦，避免情志刺激"
        ]
      }
    },
    "算诊总结": {
      "核心问题": "阳虚体质，脾肾阳虚，气血不足",
      "治疗重点": "温阳散寒，健脾益肾，调理气血",
      "预后评估": "通过系统调理，预计3-6个月可明显改善",
      "关键建议": "坚持温阳调理，注意生活起居，定期复查评估"
    }
  },
  "message": "综合算诊分析完成",
  "timestamp": "2024-01-15T14:30:00Z"
}
```

#### **POST /api/v1/calculation/ziwu-liuzhu** - 子午流注分析
专门的子午流注时间医学分析。

**请求参数**:
```json
{
  "datetime": "2024-01-15T14:30:00",
  "symptoms": ["头痛", "失眠"]
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "当前时辰": "未时",
    "对应经络": "小肠经",
    "气血状态": "旺盛",
    "经络信息": {
      "经络": "手太阳小肠经",
      "脏腑": "小肠",
      "主治": ["心系疾病", "消化不良", "肩背疼痛"],
      "最佳针灸时间": "13:00-15:00",
      "禁忌时间": "01:00-03:00"
    },
    "症状分析": [
      {
        "症状": "头痛",
        "最佳治疗时间": "卯时(5-7点) - 大肠经",
        "治疗建议": "此时气血流注大肠经，适合治疗头面部疾病"
      },
      {
        "症状": "失眠", 
        "最佳治疗时间": "亥时(21-23点) - 三焦经",
        "治疗建议": "此时调理三焦，有助于安神定志"
      }
    ],
    "今日建议": "当前未时适合调理消化系统，建议进行腹部按摩",
    "明日规划": "明日卯时(5-7点)进行头部穴位按摩治疗头痛"
  }
}
```

#### **POST /api/v1/calculation/constitution** - 八字体质分析
基于出生时间的体质分析。

**请求参数**:
```json
{
  "birth_datetime": "1990-01-01T08:00:00",
  "gender": "male"
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "基本信息": {
      "出生时间": "1990年01月01日 08时00分",
      "性别": "男",
      "生肖": "马",
      "八字": "己巳年 丙子月 甲寅日 戊辰时"
    },
    "五行分析": {
      "五行分布": {
        "木": 2,
        "火": 2, 
        "土": 2,
        "金": 0,
        "水": 2
      },
      "五行特点": "金弱，其他相对平衡",
      "喜用神": "金、水",
      "忌神": "火、土"
    },
    "体质判断": {
      "主体质": "阳虚质",
      "次体质": "气虚质",
      "体质特征": [
        "畏寒怕冷，手足不温",
        "精神不振，容易疲劳",
        "大便溏薄，小便清长",
        "舌淡苔白，脉沉迟"
      ],
      "性格特点": [
        "性格内向，不喜欢说话",
        "情绪不稳定，容易悲伤",
        "做事缺乏冲劲，反应较慢"
      ]
    },
    "健康分析": {
      "易患疾病": [
        "脾胃虚寒 - 消化不良、腹泻",
        "肾阳不足 - 腰膝酸软、性功能减退", 
        "心阳虚弱 - 心悸、胸闷、失眠"
      ],
      "发病倾向": [
        "冬季和阴雨天容易发病",
        "过度劳累后容易生病",
        "情绪波动大时容易出现症状"
      ],
      "体质评分": 65
    },
    "调理方案": {
      "调理原则": "温阳散寒，健脾益肾",
      "中药调理": [
        "主方：金匮肾气丸、理中汤",
        "常用药：附子、干姜、人参、黄芪",
        "禁用药：苦寒清热药物"
      ],
      "饮食调理": {
        "宜食": [
          "温热性食物：羊肉、韭菜、生姜",
          "补益食物：人参、黄芪、当归",
          "温性水果：桂圆、荔枝、樱桃"
        ],
        "忌食": [
          "寒凉食物：冷饮、冰淇淋、西瓜",
          "苦寒食物：苦瓜、绿豆、菊花茶",
          "生冷食物：生鱼片、凉拌菜"
        ]
      },
      "运动调理": [
        "适宜运动：太极拳、八段锦、慢跑",
        "运动时间：上午9-11点，下午3-5点",
        "运动强度：中低强度，微微出汗即可",
        "注意事项：避免大汗淋漓，运动后及时保暖"
      ],
      "生活调理": [
        "起居：早睡早起，避免熬夜",
        "保暖：注意腰腹部和足部保暖",
        "情志：保持心情愉悦，避免过度思虑",
        "房事：节制房事，避免房劳过度"
      ]
    }
  }
}
```

#### **POST /api/v1/calculation/wuyun-liuqi** - 五运六气分析
运气学说的健康预测分析。

**请求参数**:
```json
{
  "year": 2024,
  "datetime": "2024-01-15T14:30:00"
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "年运分析": {
      "年份": 2024,
      "干支": "甲辰年",
      "主运": "土运太过",
      "客运": "金运不及",
      "运气特点": "土旺金衰，脾胃偏旺，肺金不足"
    },
    "六气分析": {
      "当前节气": "大寒",
      "主气": "太阳寒水",
      "客气": "太阴湿土",
      "气候特点": "寒湿并重，脾胃易伤"
    },
    "健康影响": {
      "易发疾病": [
        "脾胃疾病 - 消化不良、腹胀腹泻",
        "肺系疾病 - 咳嗽、气喘、感冒",
        "湿邪困脾 - 身重乏力、食欲不振"
      ],
      "发病时间": [
        "春季 - 肝木克脾土，脾胃病多发",
        "长夏 - 湿邪当令，湿病多发",
        "秋季 - 金气不足，肺病易发"
      ],
      "高危人群": [
        "脾胃虚弱者",
        "肺气不足者", 
        "湿热体质者"
      ]
    },
    "防治建议": {
      "总体原则": "健脾燥湿，补肺益气",
      "春季调理": [
        "疏肝健脾，预防肝木克土",
        "适当运动，增强脾胃功能",
        "饮食清淡，避免肥甘厚味"
      ],
      "夏季调理": [
        "清热祛湿，健脾和胃",
        "避免贪凉，保护脾阳",
        "适量饮水，促进代谢"
      ],
      "秋季调理": [
        "润肺养阴，补益肺气",
        "预防燥邪，保护肺津",
        "适当进补，增强体质"
      ],
      "冬季调理": [
        "温阳散寒，健脾益肾",
        "避免寒湿，保护阳气",
        "适当进补，储备精气"
      ]
    },
    "本月重点": {
      "当前月份": "一月",
      "气候特点": "寒湿当令",
      "重点防护": [
        "防寒保暖，避免寒邪入侵",
        "健脾祛湿，预防湿邪困脾",
        "补益肺气，增强抵抗力"
      ],
      "推荐方药": [
        "理中汤 - 温中健脾",
        "二陈汤 - 燥湿化痰",
        "补中益气汤 - 补益脾肺"
      ]
    }
  }
}
```

#### **POST /api/v1/calculation/bagua** - 八卦配属分析
易学与健康关系的分析。

**请求参数**:
```json
{
  "birth_datetime": "1990-01-01T08:00:00",
  "current_datetime": "2024-01-15T14:30:00"
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "本命卦": {
      "卦名": "坎卦",
      "卦象": "☵",
      "五行": "水",
      "方位": "北方",
      "脏腑": "肾、膀胱",
      "特征": ["智慧", "流动", "适应性强", "内敛深沉"]
    },
    "当前卦": {
      "卦名": "艮卦",
      "卦象": "☶", 
      "五行": "土",
      "方位": "东北",
      "脏腑": "脾、胃",
      "影响": "稳定、内敛、需要休养"
    },
    "健康分析": {
      "本命特质": [
        "肾系功能较强，智慧聪明",
        "适应能力强，但容易内耗",
        "水性流动，循环代谢良好",
        "容易思虑过度，耗伤心神"
      ],
      "当前状态": [
        "处于艮卦影响，宜静不宜动",
        "脾胃功能需要重点关注",
        "适合内敛修养，积蓄能量",
        "避免过度劳累和情绪波动"
      ],
      "五行关系": "土克水，当前需要注意脾胃对肾的影响"
    },
    "健康预测": {
      "风险等级": "中",
      "易发疾病": [
        "肾系疾病 - 腰膝酸软、水液代谢异常",
        "脾胃疾病 - 消化不良、食欲不振",
        "心神疾病 - 失眠、健忘、焦虑"
      ],
      "发病时间": [
        "冬季 - 水旺时肾病易发",
        "长夏 - 土旺时脾胃病易发",
        "情绪波动时 - 心神疾病易发"
      ],
      "有利时期": [
        "春季 - 木生水，有利于肾的恢复",
        "秋季 - 金生水，有利于肺肾调理"
      ]
    },
    "调理建议": {
      "总体原则": "补肾健脾，安神定志",
      "本命调理": [
        "补益肾精，固本培元",
        "节制房事，避免肾精亏损",
        "多食黑色食物，如黑豆、黑芝麻",
        "适当静坐冥想，养神安心"
      ],
      "当前调理": [
        "健脾和胃，增强消化功能",
        "避免思虑过度，保持心情平静",
        "适当运动，但不宜过于激烈",
        "注意休息，保证充足睡眠"
      ],
      "方位调理": [
        "居住环境宜坐北朝南",
        "工作学习面向北方有利",
        "避免长期处于西南方位"
      ],
      "时间调理": [
        "子时(23-1点)是肾经当令，宜休息",
        "辰时(7-9点)是胃经当令，宜进食",
        "避免在未时(13-15点)过度劳累"
      ]
    },
    "吉凶判断": {
      "总体运势": "平稳中带有挑战",
      "健康运势": "需要重点关注脾肾功能",
      "有利因素": [
        "本命水性，适应能力强",
        "智慧聪明，善于调理",
        "当前艮卦，适合静养"
      ],
      "不利因素": [
        "土克水，脾胃影响肾功能",
        "容易思虑过度，耗伤心神",
        "水性流动，容易情绪波动"
      ],
      "化解方法": [
        "用金来通关，多食白色食物",
        "加强运动，促进土水和谐",
        "保持心境平和，减少内耗"
      ]
    }
  }
}
```

---

### **缓存管理接口**

#### **GET /cache/stats** - 缓存统计
获取缓存使用统计信息。

**响应示例**:
```json
{
  "success": true,
  "data": {
    "total_items": 156,
    "hit_rate": 0.85,
    "miss_rate": 0.15,
    "total_hits": 1240,
    "total_misses": 218,
    "memory_usage": "2.3MB",
    "oldest_item": "2024-01-15T10:00:00Z",
    "newest_item": "2024-01-15T14:30:00Z"
  },
  "message": "缓存统计信息获取成功"
}
```

#### **POST /cache/clear** - 清理缓存
清理所有缓存数据。

**响应示例**:
```json
{
  "success": true,
  "message": "缓存已清理"
}
```

#### **POST /cache/cleanup** - 清理过期缓存
清理过期的缓存项。

**响应示例**:
```json
{
  "success": true,
  "data": {
    "cleaned_items": 23
  },
  "message": "已清理 23 个过期缓存项"
}
```

---

## 🔧 **错误处理**

### **错误响应格式**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_BIRTH_TIME",
    "message": "出生时间格式不正确",
    "details": "时间格式应为 ISO 8601 标准"
  },
  "timestamp": "2024-01-15T14:30:00Z"
}
```

### **常见错误码**
- `INVALID_BIRTH_TIME`: 出生时间格式错误
- `INVALID_GENDER`: 性别参数错误
- `CALCULATION_ERROR`: 算诊计算错误
- `SERVICE_UNAVAILABLE`: 服务不可用
- `RATE_LIMIT_EXCEEDED`: 请求频率超限
- `INTERNAL_ERROR`: 内部服务错误

---

## 🚀 **使用示例**

### **Python 客户端示例**
```python
import requests
import json
from datetime import datetime

# 服务地址
BASE_URL = "http://localhost:8005"

# 综合算诊请求
def comprehensive_diagnosis():
    url = f"{BASE_URL}/api/v1/calculation/comprehensive"
    
    data = {
        "birth_datetime": "1990-01-01T08:00:00",
        "current_datetime": datetime.now().isoformat(),
        "gender": "male",
        "symptoms": ["疲劳", "失眠", "食欲不振"]
    }
    
    response = requests.post(url, json=data)
    
    if response.status_code == 200:
        result = response.json()
        print("算诊分析成功:")
        print(json.dumps(result, indent=2, ensure_ascii=False))
    else:
        print(f"请求失败: {response.status_code}")
        print(response.text)

# 子午流注分析
def ziwu_liuzhu_analysis():
    url = f"{BASE_URL}/api/v1/calculation/ziwu-liuzhu"
    
    data = {
        "datetime": datetime.now().isoformat(),
        "symptoms": ["头痛", "失眠"]
    }
    
    response = requests.post(url, json=data)
    result = response.json()
    
    print("子午流注分析:")
    print(f"当前时辰: {result['data']['当前时辰']}")
    print(f"对应经络: {result['data']['对应经络']}")

if __name__ == "__main__":
    comprehensive_diagnosis()
    ziwu_liuzhu_analysis()
```

### **JavaScript 客户端示例**
```javascript
// 综合算诊请求
async function comprehensiveDiagnosis() {
    const url = 'http://localhost:8005/api/v1/calculation/comprehensive';
    
    const data = {
        birth_datetime: '1990-01-01T08:00:00',
        current_datetime: new Date().toISOString(),
        gender: 'male',
        symptoms: ['疲劳', '失眠', '食欲不振']
    };
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('算诊分析成功:', result.data);
        } else {
            console.error('算诊分析失败:', result.error);
        }
    } catch (error) {
        console.error('请求错误:', error);
    }
}

// 体质分析请求
async function constitutionAnalysis() {
    const url = 'http://localhost:8005/api/v1/calculation/constitution';
    
    const data = {
        birth_datetime: '1990-01-01T08:00:00',
        gender: 'male'
    };
    
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    });
    
    const result = await response.json();
    console.log('体质分析结果:', result.data.体质判断);
}
```

---

## 📊 **性能指标**

### **响应时间**
- 综合算诊: < 2000ms
- 单项分析: < 500ms
- 缓存命中: < 50ms

### **并发能力**
- 最大并发: 100 requests/second
- 平均响应: 300ms
- 错误率: < 0.1%

### **缓存策略**
- TTL: 3600秒 (1小时)
- 命中率: > 80%
- 内存限制: 100MB

---

## 🔒 **安全说明**

### **访问控制**
- 支持 CORS 跨域访问
- 请求频率限制: 100次/分钟
- 输入数据验证和清理

### **数据保护**
- 不存储用户个人信息
- 计算结果临时缓存
- 定期清理过期数据

### **错误处理**
- 完善的异常捕获
- 详细的错误日志
- 优雅的降级处理

---

## 📞 **技术支持**

如有技术问题或建议，请联系：

- **项目地址**: https://github.com/suoke-life/calculation-service
- **文档地址**: http://localhost:8005/docs
- **健康检查**: http://localhost:8005/ping

**算诊服务 - 传统中医智慧的现代化实现** 🧮✨ 