"""
demo_blockchain_service - ç´¢å…‹ç”Ÿæ´»é¡¹ç›®æ¨¡å—
"""

from datetime import datetime, timedelta
from suoke_blockchain_service.config import settings
from suoke_blockchain_service.database import init_database, close_database
from suoke_blockchain_service.logging import configure_logging, get_logger
from suoke_blockchain_service.service import get_blockchain_service
from typing import Dict, Any
import asyncio
import json
import uuid

#! / usr / bin / env python3
"""
Blockchain Service åŠŸèƒ½æ¼”ç¤ºè„šæœ¬

æ¼”ç¤ºåŒºå—é“¾æœåŠ¡çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬æ•°æ®å­˜å‚¨ã€éªŒè¯ã€è®¿é—®æ§åˆ¶ç­‰ã€‚
"""


# å¯¼å…¥æœåŠ¡æ¨¡å—

logger = get_logger(__name__)

class BlockchainServiceDemo:
    """åŒºå—é“¾æœåŠ¡æ¼”ç¤ºç±»"""

    def __init__(self) - > None:
        """TODO: æ·»åŠ æ–‡æ¡£å­—ç¬¦ä¸²"""
        self.service = get_blockchain_service()
        self.demo_user_id = "demo - user - " + str(uuid.uuid4())[:8]
        self.demo_grantee_id = "demo - grantee - " + str(uuid.uuid4())[:8]

    async def demo_health_data_storage(self) - > Dict[str, Any]:
        """æ¼”ç¤ºå¥åº·æ•°æ®å­˜å‚¨åŠŸèƒ½"""
        print("\n === æ¼”ç¤º1: å¥åº·æ•°æ®å­˜å‚¨ === ")

        # å‡†å¤‡ç¤ºä¾‹å¥åº·æ•°æ®
        health_data = {
            "user_id": self.demo_user_id,
            "timestamp": datetime.now().isoformat(),
            "data_type": "heart_rate",
            "measurements": {
                "heart_rate": 72,
                "blood_pressure": {"systolic": 120, "diastolic": 80},
                "temperature": 36.5,
                "weight": 70.5
            },
            "device_info": {
                "device_id": "smartwatch - 001",
                "manufacturer": "HealthTech",
                "model": "HT - Watch - Pro",
                "firmware_version": "2.1.0"
            },
            "location": {
                "latitude": 39.9042,
                "longitude": 116.4074,
                "accuracy": 10
            },
            "metadata": {
                "session_id": str(uuid.uuid4()),
                "quality_score": 0.95,
                "notes": "Regular morning measurement"
            }
        }

        print(f"ğŸ“Š å­˜å‚¨ç”¨æˆ· {self.demo_user_id} çš„å¥åº·æ•°æ®...")
        print(f"ğŸ“‹ æ•°æ®ç±»å‹: {health_data['data_type']}")
        print(f"ğŸ“ æ•°æ®å¤§å°: {len(json.dumps(health_data))} bytes")

        try:
            # è°ƒç”¨å­˜å‚¨æœåŠ¡
            result = await self.service.store_health_data(
                user_id = self.demo_user_id,
                data = health_data,
                data_type = "heart_rate",
                permissions = {
                    "read": ["doctor", "emergency"],
                    "write": ["self"],
                    "share": ["family"]
                }
            )

            print(f"âœ… å­˜å‚¨æˆåŠŸ!")
            print(f"ğŸ“ è®°å½•ID: {result['record_id']}")
            print(f"ğŸ”— äº¤æ˜“ID: {result['transaction_id']}")
            print(f"ğŸ”’ æ•°æ®å“ˆå¸Œ: {result['data_hash'][:16]}...")
            print(f"ğŸŒ IPFSå“ˆå¸Œ: {result['ipfs_hash']}")
            print(f"ğŸ” é›¶çŸ¥è¯†è¯æ˜: {'å·²ç”Ÿæˆ' if result['zkp_proof'] else 'æœªç”Ÿæˆ'}")

            return result

        except Exception as e:
            print(f"âŒ å­˜å‚¨å¤±è´¥: {str(e)}")
            return {}

    async def demo_health_data_verification(self, record_id: str) - > Dict[str, Any]:
        """æ¼”ç¤ºå¥åº·æ•°æ®éªŒè¯åŠŸèƒ½"""
        print("\n === æ¼”ç¤º2: å¥åº·æ•°æ®éªŒè¯ === ")

        print(f"ğŸ” éªŒè¯è®°å½• {record_id}...")

        try:
            # è°ƒç”¨éªŒè¯æœåŠ¡
            result = await self.service.verify_health_data(
                record_id = record_id,
                user_id = self.demo_user_id
            )

            print(f"ğŸ“Š éªŒè¯ç»“æœ:")
            print(f"  ğŸ”— åŒºå—é“¾éªŒè¯: {'âœ… é€šè¿‡' if result['blockchain_valid'] else 'âŒ å¤±è´¥'}")
            print(f"  ğŸ” é›¶çŸ¥è¯†è¯æ˜: {'âœ… é€šè¿‡' if result['zkp_valid'] else 'âŒ å¤±è´¥'}")
            print(f"  ğŸŒ IPFSå®Œæ•´æ€§: {'âœ… é€šè¿‡' if result['ipfs_valid'] else 'âŒ å¤±è´¥'}")
            print(f"  ğŸ¯ ç»¼åˆéªŒè¯: {'âœ… é€šè¿‡' if result['overall_valid'] else 'âŒ å¤±è´¥'}")
            print(f"  â° éªŒè¯æ—¶é—´: {result['verified_at']}")

            return result

        except Exception as e:
            print(f"âŒ éªŒè¯å¤±è´¥: {str(e)}")
            return {}

    async def demo_access_control(self, record_id: str) - > Dict[str, Any]:
        """æ¼”ç¤ºè®¿é—®æ§åˆ¶åŠŸèƒ½"""
        print("\n === æ¼”ç¤º3: è®¿é—®æ§åˆ¶ === ")

        # æˆæƒè®¿é—®
        print(f"ğŸ”‘ æˆæƒç”¨æˆ· {self.demo_grantee_id} è®¿é—®è®°å½• {record_id}...")

        try:
            # æˆæƒè®¿é—®
            grant_result = await self.service.grant_access(
                owner_id = self.demo_user_id,
                grantee_id = self.demo_grantee_id,
                record_id = record_id,
                access_level = "read",
                expires_at = datetime.now() + timedelta(hours = 24),
                permissions = {
                    "read_data": True,
                    "read_metadata": True,
                    "download": False,
                    "share": False
                }
            )

            print(f"âœ… æˆæƒæˆåŠŸ!")
            print(f"ğŸ†” æˆæƒID: {grant_result['grant_id']}")
            print(f"ğŸ”— äº¤æ˜“å“ˆå¸Œ: {grant_result.get('transaction_hash', 'N / A')}")
            print(f"ğŸ“… è¿‡æœŸæ—¶é—´: {grant_result['expires_at']}")

            # æŸ¥è¯¢è®¿é—®æˆæƒ
            print(f"\nğŸ“‹ æŸ¥è¯¢ç”¨æˆ· {self.demo_user_id} çš„æˆæƒåˆ—è¡¨...")
            grants = await self.service.get_access_grants(
                user_id = self.demo_user_id,
                as_owner = True,
                active_only = True
            )

            print(f"ğŸ“Š æ‰¾åˆ° {len(grants)} ä¸ªæœ‰æ•ˆæˆæƒ:")
            for grant in grants:
                print(f"  ğŸ‘¤ è¢«æˆæƒè€…: {grant['grantee_id']}")
                print(f"  ğŸ”’ è®¿é—®çº§åˆ«: {grant['access_level']}")
                print(f"  ğŸ“… æˆæƒæ—¶é—´: {grant['granted_at']}")
                print(f"  â° è¿‡æœŸæ—¶é—´: {grant['expires_at'] or 'æ°¸ä¸è¿‡æœŸ'}")

            # æ’¤é”€è®¿é—®
            print(f"\nğŸš« æ’¤é”€ç”¨æˆ· {self.demo_grantee_id} çš„è®¿é—®æƒé™...")
            revoke_result = await self.service.revoke_access(
                owner_id = self.demo_user_id,
                grantee_id = self.demo_grantee_id,
                record_id = record_id,
                reason = "æ¼”ç¤ºå®Œæˆ"
            )

            print(f"âœ… æ’¤é”€æˆåŠŸ!")
            print(f"ğŸ†” æˆæƒID: {revoke_result['grant_id']}")
            print(f"ğŸ“… æ’¤é”€æ—¶é—´: {revoke_result['revoked_at']}")
            print(f"ğŸ“ æ’¤é”€åŸå› : {revoke_result['reason']}")

            return {
                "grant_result": grant_result,
                "grants": grants,
                "revoke_result": revoke_result
            }

        except Exception as e:
            print(f"âŒ è®¿é—®æ§åˆ¶æ“ä½œå¤±è´¥: {str(e)}")
            return {}

    async def demo_data_query(self) - > Dict[str, Any]:
        """æ¼”ç¤ºæ•°æ®æŸ¥è¯¢åŠŸèƒ½"""
        print("\n === æ¼”ç¤º4: æ•°æ®æŸ¥è¯¢ === ")

        print(f"ğŸ“‹ æŸ¥è¯¢ç”¨æˆ· {self.demo_user_id} çš„å¥åº·è®°å½•...")

        try:
            # æŸ¥è¯¢å¥åº·è®°å½•
            records = await self.service.get_health_records(
                user_id = self.demo_user_id,
                data_type = "heart_rate",
                limit = 10,
                offset = 0
            )

            print(f"ğŸ“Š æŸ¥è¯¢ç»“æœ:")
            print(f"  ğŸ“ æ€»è®°å½•æ•°: {records['total_count']}")
            print(f"  ğŸ“„ å½“å‰é¡µè®°å½•: {len(records['records'])}")
            print(f"  ğŸ“– æ˜¯å¦æœ‰æ›´å¤š: {records['has_more']}")

            for i, record in enumerate(records['records'], 1):
                print(f"\n  ğŸ“‹ è®°å½• {i}:")
                print(f"    ğŸ†” ID: {record['id']}")
                print(f"    ğŸ“Š æ•°æ®ç±»å‹: {record['data_type']}")
                print(f"    ğŸ”’ æ•°æ®å“ˆå¸Œ: {record['data_hash'][:16]}...")
                print(f"    ğŸ“… åˆ›å»ºæ—¶é—´: {record['created_at']}")
                print(f"    ğŸ”— äº¤æ˜“çŠ¶æ€: {record['transaction_status'] or 'N / A'}")
                print(f"    ğŸ” é›¶çŸ¥è¯†è¯æ˜: {'âœ…' if record['has_zkp'] else 'âŒ'}")

            return records

        except Exception as e:
            print(f"âŒ æŸ¥è¯¢å¤±è´¥: {str(e)}")
            return {}

    async def run_demo(self) - > None:
        """è¿è¡Œå®Œæ•´æ¼”ç¤º"""
        print("ğŸš€ å¼€å§‹ Blockchain Service åŠŸèƒ½æ¼”ç¤º")
        print(" = " * 50)

        try:
            # æ¼”ç¤º1: æ•°æ®å­˜å‚¨
            storage_result = await self.demo_health_data_storage()
            if not storage_result:
                print("âŒ æ•°æ®å­˜å‚¨æ¼”ç¤ºå¤±è´¥ï¼Œç»ˆæ­¢æ¼”ç¤º")
                return

            record_id = storage_result['record_id']

            # æ¼”ç¤º2: æ•°æ®éªŒè¯
            await self.demo_health_data_verification(record_id)

            # æ¼”ç¤º3: è®¿é—®æ§åˆ¶
            await self.demo_access_control(record_id)

            # æ¼”ç¤º4: æ•°æ®æŸ¥è¯¢
            await self.demo_data_query()

            print("\n" + " = " * 50)
            print("ğŸ‰ æ¼”ç¤ºå®Œæˆ! æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½è¿è¡Œæ­£å¸¸")
            print("\nğŸ“Š æ¼”ç¤ºæ€»ç»“:")
            print("âœ… å¥åº·æ•°æ®å­˜å‚¨ - æ”¯æŒåŠ å¯†å­˜å‚¨å’ŒIPFSåˆ†å¸ƒå¼å­˜å‚¨")
            print("âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯ - å¤šå±‚éªŒè¯æœºåˆ¶ç¡®ä¿æ•°æ®å¯ä¿¡")
            print("âœ… è®¿é—®æƒé™æ§åˆ¶ - ç»†ç²’åº¦æƒé™ç®¡ç†å’Œæ—¶é—´é™åˆ¶")
            print("âœ… æ•°æ®æŸ¥è¯¢æœåŠ¡ - é«˜æ•ˆçš„æ•°æ®æ£€ç´¢å’Œåˆ†é¡µæ”¯æŒ")
            print("âœ… åŒºå—é“¾é›†æˆ - ä¸å¯ç¯¡æ”¹çš„æ•°æ®å­˜è¯å’Œå®¡è®¡")
            print("âœ… é›¶çŸ¥è¯†è¯æ˜ - éšç§ä¿æŠ¤çš„æ•°æ®éªŒè¯")

        except Exception as e:
            print(f"\nâŒ æ¼”ç¤ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}")
            logger.exception("æ¼”ç¤ºå¤±è´¥")

async def main() - > None:
    """ä¸»å‡½æ•°"""
    # é…ç½®æ—¥å¿—
    configure_logging()

    print(f"ğŸ”§ é…ç½®ä¿¡æ¯:")
    print(f"  ğŸ“± åº”ç”¨åç§°: {settings.app_name}")
    print(f"  ğŸ”§ ç¯å¢ƒ: {settings.environment}")
    print(f"  ğŸ› è°ƒè¯•æ¨¡å¼: {settings.debug}")
    print(f"  ğŸ—„ï¸ æ•°æ®åº“: {settings.database.host}:{settings.database.port}")
    print(f"  ğŸŒ IPFSèŠ‚ç‚¹: {settings.ipfs.node_url}")
    print(f"  â›“ï¸ åŒºå—é“¾èŠ‚ç‚¹: {settings.blockchain.eth_node_url}")

    try:
        # åˆå§‹åŒ–æ•°æ®åº“
        print("\nğŸ”„ åˆå§‹åŒ–æ•°æ®åº“è¿æ¥...")
        await init_database()
        print("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")

        # è¿è¡Œæ¼”ç¤º
        demo = BlockchainServiceDemo()
        await demo.run_demo()

    except Exception as e:
        print(f"\nâŒ åˆå§‹åŒ–å¤±è´¥: {str(e)}")
        logger.exception("åˆå§‹åŒ–å¤±è´¥")
    finally:
        # æ¸…ç†èµ„æº
        print("\nğŸ§¹ æ¸…ç†èµ„æº...")
        await close_database()
        print("âœ… èµ„æºæ¸…ç†å®Œæˆ")

if __name__ == "__main__":
    asyncio.run(main())