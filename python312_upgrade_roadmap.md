# Python 3.12 å‡çº§è·¯çº¿å›¾

## é¡¹ç›®æ¦‚è¿°

ç´¢å…‹ç”Ÿæ´»(Suoke Life)é¡¹ç›®ç›®å‰ä½¿ç”¨å¤šä¸ªPythonç‰ˆæœ¬(3.9/3.10/3.11)ã€‚æœ¬å‡çº§è®¡åˆ’æ—¨åœ¨å°†æ‰€æœ‰æœåŠ¡ç»Ÿä¸€å‡çº§åˆ°Python 3.12ï¼Œä»¥ä¾¿åˆ©ç”¨æœ€æ–°ç‰¹æ€§å’Œæ€§èƒ½æ”¹è¿›ã€‚

## å·²å®Œæˆå·¥ä½œ

1. âœ… åˆ›å»ºå…¼å®¹æ€§æ£€æŸ¥è„šæœ¬ `scripts/check_python312_compatibility.py`
2. âœ… åˆ›å»ºDockerfileæ›´æ–°è„šæœ¬ `scripts/update_dockerfiles.py`  
3. âœ… åˆ›å»ºGitHubå·¥ä½œæµæ›´æ–°è„šæœ¬ `scripts/update_github_workflows.py`
4. âœ… åˆ›å»ºä¸»åè°ƒè„šæœ¬ `scripts/upgrade_python312.py`
5. âœ… åˆ›å»ºæ”¹è¿›ç‰ˆå…¼å®¹æ€§æ£€æŸ¥è„šæœ¬ `scripts/check_dependency_compatibility.py`
6. âœ… åˆ›å»ºæµ‹è¯•éªŒè¯è„šæœ¬ `scripts/test_python312_compatibility.py`
7. âœ… åˆ›å»ºä¾èµ–ä¿®å¤è„šæœ¬ `scripts/fix_python312_dependencies.py`
8. âœ… åˆ›å»ºæ‰‹åŠ¨ä¾èµ–ä¿®å¤è„šæœ¬ `scripts/manual_fixes_python312.py`
9. âœ… åˆ›å»ºå‡çº§ç›‘æŽ§è„šæœ¬ `scripts/monitor_python312_upgrade.py`
10. âœ… æ›´æ–°28ä¸ªDockerfileä¸­çš„PythonåŸºç¡€é•œåƒä¸º3.12
11. âœ… æ›´æ–°4ä¸ªGitHubå·¥ä½œæµé…ç½®ä¸ºPython 3.12
12. âœ… è‡ªåŠ¨ä¿®å¤16ä¸ªæœåŠ¡çš„52ä¸ªä¾èµ–é¡¹é—®é¢˜
13. âœ… æ‰‹åŠ¨ä¿®å¤9ä¸ªæœåŠ¡çš„20ä¸ªä¾èµ–é¡¹é—®é¢˜

## å½“å‰çŠ¶æ€

é€šè¿‡ä¾èµ–å…¼å®¹æ€§æ£€æµ‹ï¼Œå·²å¤„ç†ä»¥ä¸‹ä¸å…¼å®¹é—®é¢˜ï¼š

1. **ä¾èµ–åŒ…ç‰ˆæœ¬ä¸å…¼å®¹**ï¼šå·²å‡çº§éƒ¨åˆ†ä¾èµ–åŒ…åˆ°æ”¯æŒPython 3.12çš„ç‰ˆæœ¬
   - numpyã€scipyç­‰ç§‘å­¦è®¡ç®—åº“å·²å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
   - torchã€torchvisionç­‰æ·±åº¦å­¦ä¹ æ¡†æž¶å·²å‡çº§
   - sqlalchemyã€asyncpgç­‰æ•°æ®åº“ä¾èµ–å·²å‡çº§

2. **æ— æ³•å‡çº§çš„ä¾èµ–é¡¹**ï¼šå¯¹äºŽæŸäº›å°šæ— Python 3.12å…¼å®¹ç‰ˆæœ¬çš„åº“ï¼Œå·²åœ¨è¦æ±‚æ–‡ä»¶ä¸­æ·»åŠ æ³¨é‡Šæ ‡è®°
   - tensorflow-liteã€tflite-runtimeç­‰ä¾èµ–æš‚ä¸æ”¯æŒPython 3.12
   - pysnarkã€zokratesç­‰ç‰¹å®šé¢†åŸŸåº“éœ€è¦åŽç»­å•ç‹¬å¤„ç†

3. **æ ¼å¼é”™è¯¯çš„ä¾èµ–é¡¹**ï¼šä¿®å¤äº†åŒ…å«æ³¨é‡Šçš„ä¾èµ–é¡¹å®šä¹‰
   - ä¾‹å¦‚ï¼š`asyncpg>=0.27.0,<0.28.0  # PostgreSQL async client` â†’ `asyncpg>=0.29.0,<1.0.0`

## å‡çº§çŽ¯å¢ƒå‡†å¤‡

1. **Python 3.12å®‰è£…**
   ```bash
   # macOS (ä½¿ç”¨Homebrew)
   brew install python@3.12
   
   # Ubuntu/Debian
   sudo apt update
   sudo apt install software-properties-common
   sudo add-apt-repository ppa:deadsnakes/ppa
   sudo apt install python3.12 python3.12-venv python3.12-dev
   
   # CentOS/RHEL
   sudo dnf install python3.12
   ```

2. **è™šæ‹ŸçŽ¯å¢ƒè®¾ç½®**
   ```bash
   # åˆ›å»ºPython 3.12è™šæ‹ŸçŽ¯å¢ƒ
   python3.12 -m venv py312-env
   
   # æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒ
   source py312-env/bin/activate
   
   # å®‰è£…åŸºæœ¬å·¥å…·
   pip install --upgrade pip setuptools wheel
   ```

3. **å®¹å™¨çŽ¯å¢ƒå‡†å¤‡**
   ```bash
   # åˆ›å»ºæµ‹è¯•å®¹å™¨çŽ¯å¢ƒ(Docker)
   docker pull python:3.12-slim
   ```

## åˆ†é˜¶æ®µéƒ¨ç½²è®¡åˆ’

æ ¹æ®æœåŠ¡ä¾èµ–å…³ç³»å’Œé‡è¦æ€§ï¼Œæˆ‘ä»¬å°†æŒ‰ç…§ä»¥ä¸‹å››ä¸ªé˜¶æ®µè¿›è¡Œéƒ¨ç½²ï¼š

### é˜¶æ®µ1: åŸºç¡€æœåŠ¡(ç¬¬1å‘¨)

**ç›®æ ‡æœåŠ¡:**
- api-gateway
- auth-service
- message-bus

**æ‰§è¡Œè®¡åˆ’:**
1. åœ¨æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²Python 3.12ç‰ˆæœ¬
2. è¿è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. ç›‘æŽ§æœåŠ¡æ€§èƒ½å’Œç¨³å®šæ€§(48å°æ—¶)
4. ç¡®è®¤æ— é—®é¢˜åŽéƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ

**å‘½ä»¤:**
```bash
# éƒ¨ç½²æµ‹è¯•çŽ¯å¢ƒ
python3 scripts/deploy_python312.py --stage 1 --env test

# è¿è¡Œæµ‹è¯•
python3 scripts/test_python312_compatibility.py --services api-gateway auth-service message-bus

# ç›‘æŽ§æœåŠ¡(è¿è¡Œ48å°æ—¶)
python3 scripts/monitor_python312_upgrade.py --stage 1 --duration 172800 --interval 300
```

### é˜¶æ®µ2: æ ¸å¿ƒä¸šåŠ¡æœåŠ¡(ç¬¬2å‘¨)

**ç›®æ ‡æœåŠ¡:**
- user-service
- health-data-service
- med-knowledge
- medical-service

**æ‰§è¡Œè®¡åˆ’:**
1. åœ¨æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²Python 3.12ç‰ˆæœ¬
2. è¿è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. éªŒè¯ä¸Žé˜¶æ®µ1æœåŠ¡çš„äº¤äº’
4. ç›‘æŽ§æœåŠ¡æ€§èƒ½å’Œç¨³å®šæ€§(48å°æ—¶)
5. ç¡®è®¤æ— é—®é¢˜åŽéƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ

**å‘½ä»¤:**
```bash
# éƒ¨ç½²æµ‹è¯•çŽ¯å¢ƒ
python3 scripts/deploy_python312.py --stage 2 --env test

# è¿è¡Œæµ‹è¯•
python3 scripts/test_python312_compatibility.py --services user-service health-data-service med-knowledge medical-service

# ç›‘æŽ§æœåŠ¡(è¿è¡Œ48å°æ—¶)
python3 scripts/monitor_python312_upgrade.py --stage 2 --duration 172800 --interval 300
```

### é˜¶æ®µ3: æ™ºèƒ½ä½“æœåŠ¡(ç¬¬3å‘¨)

**ç›®æ ‡æœåŠ¡:**
- rag-service
- agent-services/laoke-service
- agent-services/soer-service
- agent-services/xiaoai-service
- agent-services/xiaoke-service

**æ‰§è¡Œè®¡åˆ’:**
1. åœ¨æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²Python 3.12ç‰ˆæœ¬
2. è¿è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯æ™ºèƒ½ä½“åŠŸèƒ½
4. ç›‘æŽ§æœåŠ¡æ€§èƒ½å’Œç¨³å®šæ€§(72å°æ—¶)
5. ç¡®è®¤æ— é—®é¢˜åŽéƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ

**å‘½ä»¤:**
```bash
# éƒ¨ç½²æµ‹è¯•çŽ¯å¢ƒ
python3 scripts/deploy_python312.py --stage 3 --env test

# è¿è¡Œæµ‹è¯•
python3 scripts/test_python312_compatibility.py --services rag-service agent-services/laoke-service agent-services/soer-service agent-services/xiaoai-service agent-services/xiaoke-service

# ç›‘æŽ§æœåŠ¡(è¿è¡Œ72å°æ—¶)
python3 scripts/monitor_python312_upgrade.py --stage 3 --duration 259200 --interval 300
```

### é˜¶æ®µ4: è¾…åŠ©æœåŠ¡(ç¬¬4å‘¨)

**ç›®æ ‡æœåŠ¡:**
- accessibility-service
- blockchain-service
- corn-maze-service
- suoke-bench-service
- diagnostic-services/*

**æ‰§è¡Œè®¡åˆ’:**
1. åœ¨æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²Python 3.12ç‰ˆæœ¬
2. è¿è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. ç›‘æŽ§æœåŠ¡æ€§èƒ½å’Œç¨³å®šæ€§(48å°æ—¶)
4. ç¡®è®¤æ— é—®é¢˜åŽéƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ

**å‘½ä»¤:**
```bash
# éƒ¨ç½²æµ‹è¯•çŽ¯å¢ƒ
python3 scripts/deploy_python312.py --stage 4 --env test

# è¿è¡Œæµ‹è¯•
python3 scripts/test_python312_compatibility.py --services accessibility-service blockchain-service corn-maze-service suoke-bench-service diagnostic-services/listen-service diagnostic-services/inquiry-service diagnostic-services/palpation-service diagnostic-services/look-service

# ç›‘æŽ§æœåŠ¡(è¿è¡Œ48å°æ—¶)
python3 scripts/monitor_python312_upgrade.py --stage 4 --duration 172800 --interval 300
```

## ç›‘æŽ§è®¡åˆ’

ä¸ºç¡®ä¿å‡çº§è¿‡ç¨‹å¹³ç¨³è¿›è¡Œï¼Œæˆ‘ä»¬å°†å¯¹æ¯ä¸ªé˜¶æ®µçš„æœåŠ¡è¿›è¡Œå…¨é¢ç›‘æŽ§ï¼š

### ç›‘æŽ§æŒ‡æ ‡

- **æœåŠ¡å¯ç”¨æ€§**: å¥åº·æ£€æŸ¥ç«¯ç‚¹å“åº”çŠ¶æ€
- **å“åº”æ—¶é—´**: æœåŠ¡å“åº”å»¶è¿Ÿ
- **é”™è¯¯çŽ‡**: è¯·æ±‚å¤±è´¥æ¯”ä¾‹
- **èµ„æºä½¿ç”¨**: CPU/å†…å­˜ä½¿ç”¨çŽ‡
- **ä¾èµ–æœåŠ¡**: ä¸Šä¸‹æ¸¸æœåŠ¡äº¤äº’æƒ…å†µ
- **ä¸šåŠ¡æŒ‡æ ‡**: å…³é”®ä¸šåŠ¡åŠŸèƒ½æ­£å¸¸è¿è¡Œ

### ç›‘æŽ§å·¥å…·

- **ç›‘æŽ§è„šæœ¬**: ä½¿ç”¨ `scripts/monitor_python312_upgrade.py` è¿›è¡ŒæœåŠ¡å¥åº·ç›‘æŽ§
- **Prometheus/Grafana**: ç”¨äºŽæ”¶é›†å’Œå¯è§†åŒ–æ€§èƒ½æŒ‡æ ‡
- **æ—¥å¿—åˆ†æž**: åˆ†æžæœåŠ¡æ—¥å¿—ä¸­çš„å¼‚å¸¸å’Œé”™è¯¯
- **å‘Šè­¦è®¾ç½®**: å½“ç›‘æŽ§æŒ‡æ ‡è¶…è¿‡é˜ˆå€¼æ—¶å‘é€å‘Šè­¦

### æ‰§è¡Œç›‘æŽ§å‘½ä»¤ç¤ºä¾‹

```bash
# ç›‘æŽ§å•ä¸ªæœåŠ¡(5åˆ†é’Ÿé—´éš”ï¼Œè¿è¡Œ24å°æ—¶)
python3 scripts/monitor_python312_upgrade.py --services api-gateway --interval 300 --duration 86400

# ç›‘æŽ§ä¸€ä¸ªé˜¶æ®µçš„æ‰€æœ‰æœåŠ¡(5åˆ†é’Ÿé—´éš”ï¼Œè¿è¡Œ48å°æ—¶)
python3 scripts/monitor_python312_upgrade.py --stage 1 --interval 300 --duration 172800
```

## å›žæ»šè®¡åˆ’

å¦‚æžœåœ¨å‡çº§è¿‡ç¨‹ä¸­å‘çŽ°ä¸¥é‡é—®é¢˜ï¼Œå°†æ‰§è¡Œä»¥ä¸‹å›žæ»šæµç¨‹ï¼š

1. **ç«‹å³å›žæ»š**:
   - å¯¹äºŽéžå…³é”®æœåŠ¡å‡ºçŽ°éžé˜»å¡žæ€§é—®é¢˜ï¼Œè®°å½•é—®é¢˜å¹¶ç»§ç»­ç›‘æŽ§
   - å¯¹äºŽå…³é”®æœåŠ¡å‡ºçŽ°ä¸¥é‡é—®é¢˜ï¼Œç«‹å³æ‰§è¡Œå›žæ»š

2. **å›žæ»šæ­¥éª¤**:
   ```bash
   # å›žæ»šç‰¹å®šæœåŠ¡
   python3 scripts/deploy_python312.py --rollback --services service-name
   
   # å›žæ»šæ•´ä¸ªé˜¶æ®µ
   python3 scripts/deploy_python312.py --rollback --stage 1
   ```

3. **å›žæ»šåŽéªŒè¯**:
   - ç¡®è®¤æœåŠ¡å·²æˆåŠŸå›žæ»šåˆ°ä¹‹å‰çš„Pythonç‰ˆæœ¬
   - éªŒè¯æœåŠ¡åŠŸèƒ½å’Œæ€§èƒ½å·²æ¢å¤æ­£å¸¸
   - è¿›è¡Œæ ¹æœ¬åŽŸå› åˆ†æžï¼Œè§£å†³é—®é¢˜åŽå†æ¬¡å°è¯•å‡çº§

## å‡çº§æ—¶é—´çº¿

| é˜¶æ®µ | å¼€å§‹æ—¥æœŸ | ç»“æŸæ—¥æœŸ | æœåŠ¡ | çŠ¶æ€ |
|------|----------|----------|------|------|
| å‡†å¤‡å·¥ä½œ | 2025-05-22 | 2025-05-24 | æ‰€æœ‰æœåŠ¡ | âœ… å·²å®Œæˆ |
| é˜¶æ®µ1 | 2025-05-27 | 2025-05-31 | åŸºç¡€æœåŠ¡ | â³ è®¡åˆ’ä¸­ |
| é˜¶æ®µ2 | 2025-06-03 | 2025-06-07 | æ ¸å¿ƒä¸šåŠ¡æœåŠ¡ | ðŸ“… è®¡åˆ’ä¸­ |
| é˜¶æ®µ3 | 2025-06-10 | 2025-06-14 | æ™ºèƒ½ä½“æœåŠ¡ | ðŸ“… è®¡åˆ’ä¸­ |
| é˜¶æ®µ4 | 2025-06-17 | 2025-06-21 | è¾…åŠ©æœåŠ¡ | ðŸ“… è®¡åˆ’ä¸­ |
| éªŒè¯å’Œä¼˜åŒ– | 2025-06-24 | 2025-06-28 | æ‰€æœ‰æœåŠ¡ | ðŸ“… è®¡åˆ’ä¸­ |

## å‡çº§éªŒè¯

å®Œæˆæ‰€æœ‰å‡çº§åŽï¼Œå°†è¿›è¡Œå…¨é¢çš„ç³»ç»ŸéªŒè¯ï¼š

1. **æ€§èƒ½åŸºå‡†æµ‹è¯•**:
   - ä½¿ç”¨suoke-bench-serviceè¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
   - å¯¹æ¯”å‡çº§å‰åŽçš„æ€§èƒ½å·®å¼‚

2. **è´Ÿè½½æµ‹è¯•**:
   - åœ¨ç”Ÿäº§çº§è´Ÿè½½ä¸‹éªŒè¯ç³»ç»Ÿç¨³å®šæ€§
   - ç¡®è®¤é«˜å³°æœŸé—´çš„èµ„æºä½¿ç”¨æƒ…å†µ

3. **åŠŸèƒ½æµ‹è¯•**:
   - æ‰§è¡Œç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•
   - éªŒè¯æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡æµç¨‹

## æ–‡æ¡£å’ŒåŸ¹è®­

1. **æ›´æ–°æ–‡æ¡£**:
   - æ›´æ–°å¼€å‘çŽ¯å¢ƒè®¾ç½®æŒ‡å—
   - æ›´æ–°CI/CDæµç¨‹æ–‡æ¡£
   - æ›´æ–°ä¾èµ–ç®¡ç†ç­–ç•¥

2. **å›¢é˜ŸåŸ¹è®­**:
   - ä»‹ç»Python 3.12æ–°ç‰¹æ€§
   - åˆ†äº«å‡çº§ç»éªŒå’Œæœ€ä½³å®žè·µ

## åŽç»­æ­¥éª¤

1. å®Œæˆå›žå½’æµ‹è¯•å¹¶è§£å†³å‘çŽ°çš„é—®é¢˜
2. æ›´æ–°å¼€å‘çŽ¯å¢ƒå’ŒCI/CDç³»ç»Ÿ
3. æ‰§è¡Œåˆ†é˜¶æ®µéƒ¨ç½²è®¡åˆ’
4. æŒç»­ç›‘æŽ§æœåŠ¡å¥åº·çŠ¶å†µ
5. å®šæœŸæ±‡æŠ¥å‡çº§è¿›åº¦

---

## æ›´æ–°è®°å½•

- **2025-05-22**: åˆå§‹åˆ›å»ºå‡çº§è·¯çº¿å›¾
- **2025-05-23**: å®Œæˆè‡ªåŠ¨åŒ–è„šæœ¬å¼€å‘å’Œä¾èµ–å…¼å®¹æ€§ä¿®å¤
- **2025-05-24**: æ›´æ–°è·¯çº¿å›¾ï¼Œæ·»åŠ ç›‘æŽ§è®¡åˆ’å’Œåˆ†é˜¶æ®µéƒ¨ç½²è¯¦æƒ… 