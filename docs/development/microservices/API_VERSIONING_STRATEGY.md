# 索克生活APP API版本控制策略

## 目录

- [版本控制原则](#版本控制原则)
- [REST API版本控制](#rest-api版本控制)
- [gRPC API版本控制](#grpc-api版本控制)
- [兼容性变更指南](#兼容性变更指南)
- [API发布流程](#api发布流程)
- [API废弃策略](#api废弃策略)
- [客户端适配策略](#客户端适配策略)
- [版本迁移指南](#版本迁移指南)

## 版本控制原则

索克生活APP的API版本控制遵循以下核心原则：

1. **向后兼容**：新版本必须兼容旧版本客户端
2. **显式版本**：版本号必须明确可见
3. **语义版本**：遵循语义版本控制规范
4. **有序演进**：渐进式演进，避免突变
5. **并行版本**：支持多个活跃版本并存
6. **优雅废弃**：旧API版本应有合理的废弃期

## REST API版本控制

### 版本号格式

REST API使用主版本号（v1、v2等）进行版本控制，格式如下：

```
https://api.suokelife.com/v{major-version}/resource
```

例如：
- https://api.suokelife.com/v1/users
- https://api.suokelife.com/v2/health-records

### 版本控制位置

REST API版本信息应在URI路径中指定，而非查询参数或HTTP头。这样可以：

- 提高可缓存性
- 简化API路由
- 提高可发现性

### 次版本控制

次要版本和修订版本通过HTTP头传递：

```
X-API-Minor-Version: 3
```

客户端可以通过此头指定所需的确切次版本，但这是可选的。服务器应始终返回实际使用的次版本：

```
X-API-Version: 1.3.2  // 格式：major.minor.patch
```

## gRPC API版本控制

### Protobuf包命名

gRPC服务使用包名中的版本后缀进行版本控制：

```protobuf
package suokelife.auth.v1;

service AuthService {
  // ...
}
```

新版本应使用新的包名：

```protobuf
package suokelife.auth.v2;

service AuthService {
  // ...
}
```

### 服务地址版本控制

gRPC服务注册时应包含版本信息：

```
auth.v1.AuthService
auth.v2.AuthService
```

### 消息演进

Protobuf消息应遵循以下演进规则：

1. 不得更改现有字段的数据类型
2. 不得移除现有字段
3. 不得更改现有字段的字段号
4. 新增字段必须是可选的(optional)，并设置默认值
5. 枚举类型的新值应添加在末尾

## 兼容性变更指南

### 兼容性变更示例

以下变更被视为兼容性变更，无需升级主版本：

- 添加新的端点或API方法
- 为请求添加新的可选参数
- 为响应添加新的字段
- 放宽输入限制（例如，增加字符串长度限制）
- 添加新的错误码（前提是老客户端能够适当处理）

### 不兼容变更示例

以下变更被视为不兼容变更，必须升级主版本：

- 移除或重命名端点、字段或参数
- 更改字段或参数的数据类型
- 添加新的必填参数
- 更改资源的URL结构
- 更改请求或响应的基本结构
- 更改认证机制
- 更改错误处理机制

## API发布流程

### 新API版本发布流程

1. **设计阶段**
   - 创建详细的API设计文档
   - 列出与当前版本的所有差异
   - 进行安全和性能评审

2. **开发阶段**
   - 实现新版本API
   - 编写全面的自动化测试
   - 确保向后兼容性

3. **测试阶段**
   - 进行功能测试
   - 进行兼容性测试（使用旧客户端）
   - 进行负载和性能测试

4. **预发布阶段**
   - 在测试环境发布新版本
   - 邀请内部开发者测试
   - 收集反馈并进行必要调整

5. **发布阶段**
   - 更新API文档
   - 发布版本变更说明
   - 向开发者社区通知新版本
   - 监控新版本使用情况和错误率

### 版本命名与标记

- **测试版API**：使用`beta`标记（例如`v2-beta`）
- **预览版API**：使用`preview`标记（例如`v1-preview`）
- **稳定版API**：不使用标记（例如`v1`）

## API废弃策略

### 废弃流程

1. **宣布废弃**
   - 在API文档中标记为废弃
   - 在响应头中添加废弃通知（`X-API-Deprecated: true`）
   - 邮件通知所有已注册的开发者

2. **废弃期**
   - 主要版本的最短废弃期为12个月
   - 次要版本的最短废弃期为6个月
   - 废弃期内继续提供正常支持和bug修复

3. **提醒通知**
   - 在废弃期的3个月、1个月和1周前发送提醒
   - 提供迁移指南和工具

4. **停用**
   - 在废弃期结束后停用API
   - 向使用已停用API的请求返回410 Gone响应

### 废弃标记

在API响应中包含废弃信息：

```
X-API-Deprecated: true
X-API-Deprecated-Reason: "This version will be discontinued on 2023-12-31. Please migrate to v2."
X-API-Successor-Version: v2
```

## 客户端适配策略

### 客户端版本检测

服务器应检测客户端版本并提供适当的响应：

1. 通过`User-Agent`或自定义头（如`X-Client-Version`）获取客户端版本
2. 对特定版本客户端进行适配处理
3. 向老版本客户端提供兼容性字段

### 客户端升级提示

当客户端使用即将废弃的API版本时，应在响应中提供升级提示：

```json
{
  "data": {
    // 正常响应数据
  },
  "meta": {
    "upgrade_notice": {
      "message": "您正在使用即将废弃的API版本。请在2023-12-31前升级到新版本。",
      "upgrade_url": "https://developer.suokelife.com/docs/migration-v1-to-v2"
    }
  }
}
```

## 版本迁移指南

### 迁移文档要求

每次发布新的主版本API时，必须提供详细的迁移指南，包括：

1. 新旧版本的差异对比
2. 代码示例展示如何迁移
3. 迁移工具或脚本（如适用）
4. 常见问题和解决方案
5. 联系支持渠道

### 平滑迁移策略

为确保平滑迁移，应采取以下措施：

1. **过渡期双版本并行**：新旧版本同时可用
2. **功能切换标志**：使用功能标志逐步启用新功能
3. **流量切分**：逐步将流量从旧版API迁移到新版API
4. **监控与回滚**：密切监控错误率，必要时快速回滚

### 迁移工具

提供以下迁移辅助工具：

1. **API兼容性检查器**：检测客户端代码与新API的兼容性
2. **请求转换器**：自动将旧版API请求转换为新版格式
3. **响应适配器**：适配新版API响应为旧版格式

## 结论

严格遵循本文档中的API版本控制策略，可以确保索克生活APP的API演进既满足业务需求的快速迭代，又保障现有客户端的稳定运行。所有开发团队必须遵守这些准则，以维持API的一致性和可靠性。