# 索克生活APP架构设计

## 目录

- [总体架构](#总体架构)
- [前端架构](#前端架构)
- [后端架构](#后端架构)
- [数据流](#数据流)
- [安全架构](#安全架构)
- [扩展性设计](#扩展性设计)
- [技术选型理由](#技术选型理由)

## 总体架构

索克生活APP采用现代化的分布式微服务架构，主要分为前端应用层、API网关层、微服务层、数据存储层和基础设施层。系统整体架构如下图所示：

```
用户层
+----------------+     +----------------+     +----------------+
|   移动应用      |     |     网页应用    |     |   第三方应用    |
| (iOS/Android)  |     |   (响应式)      |     |  (通过开放API)  |
+-------+--------+     +-------+---------+    +-------+---------+
        |                      |                      |
        v                      v                      v
+------------------------------------------------------------------+
|                          API网关层                                |
|  +-------------+  +-------------+  +-------------+  +----------+ |
|  | 认证与授权   |  | 流量控制    |  | 请求路由    |  | 日志监控  | |
|  +-------------+  +-------------+  +-------------+  +----------+ |
+---------------------------+----------------------------------+---+
                            |
                            v
+------------------------------------------------------------------+
|                          微服务层                                 |
|  +-------------+  +-------------+  +-------------+  +----------+ |
|  | 用户服务     |  | 智能体服务   |  | 四诊服务    |  | 健康服务  | |
|  +-------------+  +-------------+  +-------------+  +----------+ |
|                                                                  |
|  +-------------+  +-------------+  +-------------+  +----------+ |
|  | 区块链服务   |  | RAG服务     |  | 消息队列    |  | 其他服务  | |
|  +-------------+  +-------------+  +-------------+  +----------+ |
+---------------------------+----------------------------------+---+
                            |
                            v
+------------------------------------------------------------------+
|                          数据存储层                               |
|  +-------------+  +-------------+  +-------------+  +----------+ |
|  | 关系型数据库 |  | NoSQL数据库  |  | 向量数据库   |  | 缓存系统  | |
|  | PostgreSQL  |  | MongoDB     |  | Milvus      |  | Redis     | |
|  +-------------+  +-------------+  +-------------+  +----------+ |
+------------------------------------------------------------------+
                            |
                            v
+------------------------------------------------------------------+
|                          基础设施层                               |
|  +-------------+  +-------------+  +-------------+  +----------+ |
|  | 容器编排     |  | 服务网格    |  | 监控告警    |  | CI/CD系统 | |
|  | Kubernetes  |  | Istio       |  | Prometheus  |  | GitHub   | |
|  +-------------+  +-------------+  +-------------+  +----------+ |
+------------------------------------------------------------------+
```

## 前端架构

索克生活APP前端采用React Native跨平台框架，实现iOS和Android两端的统一开发。前端架构采用分层设计，遵循Clean Architecture原则，各层职责清晰分离。

### 前端分层架构

1. **表现层 (Presentation Layer)**
   - 负责UI渲染和用户交互
   - 基于React Native组件构建
   - 使用React Hooks管理组件状态

2. **业务逻辑层 (Business Logic Layer)**
   - 实现业务逻辑和流程控制
   - 使用Redux Toolkit管理全局状态
   - 封装复杂业务逻辑到自定义Hooks

3. **数据层 (Data Layer)**
   - 负责API调用和数据处理
   - 实现数据持久化和缓存策略
   - 处理离线状态和数据同步

4. **核心层 (Core Layer)**
   - 提供公共工具和服务
   - 实现错误处理和日志记录
   - 封装第三方库的调用

### 前端技术栈

- **框架**: React Native 0.73+
- **状态管理**: Redux Toolkit
- **路由导航**: React Navigation 6
- **数据存储**: SQLite
- **UI组件库**: React Native Paper
- **样式方案**: StyleSheet + Themed Components
- **网络请求**: Axios
- **国际化**: i18next
- **动画**: React Native Reanimated
- **多媒体**: React Native Vision Camera + React Native Voice
- **测试**: Jest + React Native Testing Library

### 前端模块化设计

索克生活APP前端采用基于特性(feature)的模块化设计，每个功能模块包含自己的组件、状态、API调用和业务逻辑。

```
src/
  features/
    home/              // 首页模块
      components/      // 模块专用组件
      hooks/           // 模块自定义钩子
      screens/         // 模块页面
      services/        // 模块服务
      slices/          // Redux状态切片
      types/           // 类型定义
      utils/           // 模块工具函数
      index.ts         // 模块导出
    auth/              // 认证模块
    agents/            // 智能体模块
    health/            // 健康模块
    ...
```

### 智能体交互架构

索克生活APP中的四大智能体(小艾、小克、老克、索儿)采用统一的交互架构：

```
+-------------------+             +-------------------+
|  智能体交互界面    |             |    WebSocket      |
|  (聊天/语音/图像)  +----------->+  实时通信服务      |
+-------------------+             +---------+---------+
        ^                                   |
        |                                   v
+-------+-------------+           +---------+---------+
|  智能体状态管理     |<----------+  智能体API服务     |
|  (Redux Store)     |           |                   |
+-------------------+            +-------------------+
```

- 使用WebSocket实现实时通信
- 支持多模态输入(文本、图像、语音、传感器数据)
- 采用Redux管理会话状态和历史记录
- 实现智能体间协同服务调用

## 后端架构

索克生活APP后端采用微服务架构，按照业务域(Domain)划分服务边界，每个微服务负责特定的业务功能，拥有独立的数据库和部署流程。

### 微服务架构图

```
                       +-------------+
                       |   API网关   |
                       |    Kong     |
                       +------+------+
                              |
              +---------------+----------------+
              |               |                |
     +--------v------+ +------v-------+ +------v-------+
     |   认证服务    | |  用户服务     | |  健康服务     |
     |  Keycloak    | |  User API    | | Health API   |
     +---------------+ +--------------+ +--------------+
              |               |                |
              v               v                v
     +--------+------+ +------+-------+ +------+-------+
     | 小艾(xiaoai)  | | 小克(xiaoke) | | 老克(laoke)  |
     |  智能体服务   | | 智能体服务   | | 智能体服务   |
     +---------------+ +--------------+ +--------------+
              |               |                |
              v               v                v
     +--------+------+ +------+-------+ +------+-------+
     | 索儿(soer)    | |  四诊服务     | |  区块链服务   |
     | 智能体服务    | |  4D APIs     | | Blockchain   |
     +---------------+ +--------------+ +--------------+
              |               |                |
              v               v                v
     +--------+------+ +------+-------+ +------+-------+
     |  消息总线     | |  RAG服务      | |  数据分析    |
     |   Kafka      | |  Vector DB    | |  Flink      |
     +---------------+ +--------------+ +--------------+
```

### 微服务技术栈

| 服务类型 | 技术栈 | 主要功能 |
|---------|--------|---------|
| API网关 | Kong, Node.js | 请求路由、认证授权、限流、日志 |
| 认证服务 | Keycloak, OAuth2.0 | 用户认证、授权管理、SSO |
| 用户服务 | FastAPI, PostgreSQL | 用户管理、资料维护、权限控制 |
| 健康服务 | FastAPI, MongoDB | 健康数据存储、分析、趋势计算 |
| 智能体服务 | FastAPI, gRPC, PyTorch | AI推理、多模态理解、知识检索 |
| 四诊服务 | FastAPI, TensorFlow | 图像分析、语音处理、脉象分析 |
| 区块链服务 | Hyperledger Besu, Web3.js | 健康数据存证、隐私计算 |
| RAG服务 | Milvus, LangChain | 向量检索、知识图谱查询 |
| 消息总线 | Kafka, ZooKeeper | 服务间通信、事件驱动 |
| 数据分析 | Flink, Druid | 流处理、实时分析 |

### 服务间通信

索克生活APP后端服务间通信采用两种主要模式：

1. **同步通信**: 使用gRPC进行服务间直接调用，适用于实时性要求高的场景
   - 低延迟：使用HTTP/2协议和Protocol Buffers
   - 强类型：使用IDL(Interface Definition Language)定义接口
   - 双向流：支持服务器和客户端流式处理

2. **异步通信**: 使用Kafka作为消息总线，实现事件驱动架构
   - 解耦：服务间无直接依赖
   - 可扩展：容易添加新的消费者服务
   - 容错：消息持久化，支持重试机制

### 数据库策略

索克生活APP采用多数据库策略，根据不同数据类型和查询模式选择合适的数据库：

| 数据类型 | 数据库选择 | 应用场景 |
|---------|-----------|---------|
| 结构化数据 | PostgreSQL | 用户信息、订单、交易 |
| 半结构化数据 | MongoDB | 健康记录、智能体会话 |
| 向量数据 | Milvus | 知识检索、相似度搜索 |
| 缓存数据 | Redis | 会话状态、热点数据 |
| 时序数据 | Druid | 健康指标、传感器数据 |
| 区块链数据 | IPFS + Ethereum | 健康数据存证、隐私计算 |

### API设计原则

索克生活APP的API设计遵循RESTful原则，同时也支持GraphQL查询复杂数据：

- **REST API**: 符合HTTP语义，版本化URL，使用JSON格式
- **GraphQL API**: 支持复杂查询，减少请求次数，按需获取数据
- **WebSocket API**: 用于实时通信和事件推送

## 数据流

索克生活APP的数据流采用单向数据流设计，遵循Flux/Redux架构模式：

### 前端数据流

```
+----------------+      +-----------------+      +-----------------+
|                |      |                 |      |                 |
|   User Input   +----->+    Actions      +----->+    Reducers     |
|                |      |                 |      |                 |
+----------------+      +-----------------+      +--------+--------+
                                                          |
+----------------+      +-----------------+      +--------v--------+
|                |      |                 |      |                 |
|     Views      +<-----+   Selectors     +<-----+      Store      |
|                |      |                 |      |                 |
+----------------+      +-----------------+      +-----------------+
```

### 后端数据流

```
+-----------------+      +----------------+      +-----------------+
|                 |      |                |      |                 |
|   API Gateway   +----->+  Services      +----->+   Repositories  |
|                 |      |                |      |                 |
+-----------------+      +----------------+      +--------+--------+
                                                          |
+-----------------+      +----------------+      +--------v--------+
|                 |      |                |      |                 |
|     Events      +<-----+  Domain Models +<-----+   Databases     |
|                 |      |                |      |                 |
+-----------------+      +----------------+      +-----------------+
```

### 跨服务数据共享

索克生活APP采用以下策略在微服务之间共享数据：

1. **API组合**: 通过API网关组合多个服务的数据
2. **事件溯源**: 使用Kafka保存事件，服务可重播构建状态
3. **CQRS模式**: 分离读写操作，优化查询性能
4. **数据视图**: 服务可维护其他服务数据的只读副本

## 安全架构

索克生活APP高度重视用户数据安全，实现多层次安全防护：

### 认证与授权

- 采用OAuth 2.0 + OpenID Connect实现身份认证
- 基于JWT的无状态令牌验证
- 使用RBAC(基于角色)和ABAC(基于属性)的权限控制
- 多因素认证支持(MFA)

### 数据安全

- 传输层使用TLS 1.3加密
- 敏感数据字段级加密
- 使用零知识证明技术保护健康数据隐私
- 基于区块链的数据完整性验证
- 遵循GDPR和医疗数据隐私法规

### 边缘安全

- API网关实现速率限制和DDoS防护
- 输入验证和输出编码防止注入攻击
- 应用Web应用防火墙(WAF)
- 定期安全扫描和渗透测试

## 扩展性设计

索克生活APP架构设计遵循可扩展性原则，能够应对用户增长和功能扩展：

### 水平扩展

- 无状态服务设计，支持多实例部署
- 基于Kubernetes的自动伸缩
- 数据库读写分离和分片
- 全球CDN分发静态资源

### 功能扩展

- 插件化架构，支持功能扩展
- 基于事件的松耦合集成
- 组件化设计，支持复用
- API版本控制，支持平滑升级

## 技术选型理由

### 前端技术选型

- **React Native**: 实现跨平台开发，提高开发效率，保持原生体验
- **Redux Toolkit**: 简化Redux使用，提供标准化的状态管理模式
- **React Navigation**: 提供灵活的导航解决方案，支持深度链接
- **SQLite**: 本地数据库，支持复杂查询和事务，优于Hive的键值存储
- **React Native Paper**: Material Design组件库，UI一致性好，定制性强

### 后端技术选型

- **FastAPI**: 高性能Python框架，自动生成API文档，支持异步处理
- **gRPC**: 高效二进制通信协议，支持多语言，双向流式通信
- **Kubernetes**: 容器编排平台，自动化部署，扩展和管理
- **Kafka**: 高吞吐消息队列，支持事件溯源，保证消息可靠性
- **PostgreSQL**: 强大的关系型数据库，支持JSON和全文搜索
- **MongoDB**: 灵活的文档数据库，适合存储半结构化数据
- **Milvus**: 高性能向量数据库，支持AI模型的知识检索
- **Redis**: 高性能内存数据库，支持多种数据结构，适合缓存和会话存储

## 持续集成与交付

索克生活APP采用现代化DevOps实践，实现持续集成和持续交付：

### CI/CD流程

```
代码提交 --> 自动化测试 --> 构建 --> 质量检测 --> 部署 --> 监控
```

- 使用GitHub Actions实现CI/CD流水线
- 自动化测试覆盖单元测试、集成测试和E2E测试
- ESLint和SonarQube进行代码质量检测
- ArgoCD实现GitOps风格的部署
- Prometheus和Grafana监控系统健康状态

### 环境管理

索克生活APP维护多个环境，确保软件质量：

- **开发环境**: 开发人员本地环境
- **集成环境**: 持续集成环境，每次提交自动部署
- **测试环境**: QA团队测试环境，功能完整测试
- **预发布环境**: 与生产环境配置相同，最终验证
- **生产环境**: 面向最终用户的环境

## 灾备与高可用

索克生活APP架构设计考虑高可用性和灾难恢复：

### 高可用设计

- 多区域部署，支持区域容灾
- 服务多实例部署，避免单点故障
- 数据库主从复制，自动故障转移
- 缓存和消息队列集群化部署

### 灾难恢复

- 数据自动备份，定时和增量备份策略
- 数据库时间点恢复(PITR)
- 多区域数据同步
- 完整的灾难恢复演练和文档

## 监控与可观测性

索克生活APP实现全面的监控和可观测性：

### 监控体系

- Prometheus + Grafana监控指标数据
- ELK Stack(Elasticsearch, Logstash, Kibana)收集和分析日志
- Jaeger进行分布式追踪
- Alertmanager实现告警通知
- SLO/SLI指标定义和跟踪

### 关键指标

- 系统可用性(Availability)
- 请求延迟(Latency)
- 吞吐量(Throughput)
- 错误率(Error Rate)
- 资源使用率(Resource Utilization)
- 用户体验指标(Core Web Vitals)

## 总结

索克生活APP采用现代化的微服务架构，通过前端React Native和后端微服务的结合，实现了高性能、可扩展、安全的健康管理平台。系统架构支持AI智能体运行，实现中医四诊合参的数字化，并通过区块链保障用户健康数据安全。架构设计重视可扩展性、安全性和用户体验，为用户提供个性化全生命周期健康管理服务。 